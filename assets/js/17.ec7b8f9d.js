(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{338:function(t,s,a){t.exports=a.p+"assets/img/image-20231225231656041.0aae02e8.png"},339:function(t,s){t.exports="data:image/png;base64,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"},340:function(t,s,a){t.exports=a.p+"assets/img/image-20231225231813285.23c04c3f.png"},341:function(t,s,a){t.exports=a.p+"assets/img/image-20231225233008020.afcc98f7.png"},342:function(t,s,a){t.exports=a.p+"assets/img/image-20231225233417497.10486417.png"},412:function(t,s,a){"use strict";a.r(s);var n=a(14),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"监控-key-变化-keyspace-notifications"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#监控-key-变化-keyspace-notifications"}},[t._v("#")]),t._v(" 监控 key 变化：Keyspace Notifications")]),t._v(" "),s("p",[t._v("Keyspace Notifications，可以用于监控 Redis 内的 Key 和 Value的变化，包括 Key 过期事件。")]),t._v(" "),s("p",[t._v("基本原理是：Pub/Sub。客户端通过订阅 Pub/Sub 频道，来感知事件的发生。")]),t._v(" "),s("h3",{attrs:{id:"开启键空间通知功能"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开启键空间通知功能"}},[t._v("#")]),t._v(" 开启键空间通知功能")]),t._v(" "),s("p",[t._v("Keyspace Notifications 功能默认是关闭的，需要手动开启")]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# config set 或者 redis.conf 配置")]),t._v("\nnotify-keyspace-events "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("参数"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("KEA"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 禁用该功能 参数设置为空即可")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("h3",{attrs:{id:"参数详细选项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参数详细选项"}},[t._v("#")]),t._v(" 参数详细选项")]),t._v(" "),s("blockquote",[s("p",[t._v("至少需要有 K  或者 E 中的一个")])]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"center"}},[t._v("参数")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("意义")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("K")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("以 "),s("code",[t._v("__keyspace@<db>__")]),t._v(" 为前缀的 Keyspace events")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("E")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("以 "),s("code",[t._v("__keyevent@<db>__")]),t._v(" 为前缀的 Keyevent events")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("m")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("访问了不存在的 key")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("n")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("产生了新 key")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("A")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("A是"),s("strong",[t._v("特殊")]),t._v('的，代表下面所有的参数的总和，是"g$lshztxed"的别名（除去mnKE的全部）')])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("x")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("key 过期事件")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("e")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("Redis内存满了,被内存淘汰的事件")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("g")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("通用命令")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("$")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("String commands")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("s")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("Set commands")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("h")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("Hash commands")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("z")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("Sorted set commands")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("t")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("Stream commands")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("d")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("Module key type events")])])])]),t._v(" "),s("h2",{attrs:{id:"keyspace-notifications-快速入门"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#keyspace-notifications-快速入门"}},[t._v("#")]),t._v(" Keyspace Notifications 快速入门")]),t._v(" "),s("p",[t._v("首先开启该功能，然后客户端只需要监听对应的频道即可。")]),t._v(" "),s("p",[t._v("频道分为两类："),s("code",[t._v("__keyspace@<db>__:xxx")]),t._v(" 和 "),s("code",[t._v("__keyevent@<db>__:xxx")])]),t._v(" "),s("p",[t._v("详细可以参考下面的例子：")]),t._v(" "),s("p",[t._v("一个客户端执行：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(338),alt:"image-20231225231656041"}})]),t._v(" "),s("p",[t._v("另一个客户端执行：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(339),alt:"image-20231225231752867"}})]),t._v(" "),s("p",[t._v("第一个客户端收到消息如下：")]),t._v(" "),s("p",[s("img",{attrs:{src:a(340),alt:"image-20231225231813285"}})]),t._v(" "),s("p",[t._v("可以看到，setex 命令分为 set expire 两条命令，并且在10s以后产生了 expired 事件代表 key 过期")]),t._v(" "),s("p",[t._v("对于每个事件的含义如下：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("1) 消息类型 pmessage 为模式匹配的消息\n2) 匹配的模式\n3) 事件名称\n4) 命令 或者 key\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("h2",{attrs:{id:"客户端订阅频道-两种通知事件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#客户端订阅频道-两种通知事件"}},[t._v("#")]),t._v(" 客户端订阅频道：两种通知事件")]),t._v(" "),s("p",[t._v("大多数情况下，一条命令会生成两条通知事件，两种事件的类型不同。")]),t._v(" "),s("p",[t._v("键空间通知事件分为两类，K 和 E，下面说一下区别")]),t._v(" "),s("h3",{attrs:{id:"_1、key-space-notification-关注-key"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1、key-space-notification-关注-key"}},[t._v("#")]),t._v(" 1、Key-space notification：关注 key")]),t._v(" "),s("p",[t._v("Key-space notification 更关注 key，你可以通过如下命令来关注指定的 key")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("psubscribe "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__keyspace@*__:[key name]'")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("下面的例子中，只有 Key 为 test 的事件被监听。")]),t._v(" "),s("p",[s("img",{attrs:{src:a(341),alt:"image-20231225233008020"}})]),t._v(" "),s("h3",{attrs:{id:"_2、key-event-notification-关注事件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2、key-event-notification-关注事件"}},[t._v("#")]),t._v(" 2、Key-event notification：关注事件")]),t._v(" "),s("p",[t._v("Key-event notification 更关注事件或者某个具体的命令")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("psubscribe "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__keyevent@*__:[event]'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 关注过期事件发生")]),t._v("\npsubscribe "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__keyevent@*__:expired'")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("p",[t._v("下面的例子中，两个key的过期事件均被监听到，没有set事件。")]),t._v(" "),s("p",[s("img",{attrs:{src:a(342),alt:"image-20231225233417497"}})]),t._v(" "),s("h3",{attrs:{id:"命令对应的事件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#命令对应的事件"}},[t._v("#")]),t._v(" 命令对应的事件")]),t._v(" "),s("p",[t._v('举个例子，过期事件对应为"expired"，'),s("code",[t._v("RENAME")]),t._v(" 命令对应有 "),s("code",[t._v("rename_from")]),t._v(" 事件和  "),s("code",[t._v("rename_to")]),t._v(" 事件")]),t._v(" "),s("p",[t._v("非常多，在此不一一列举，详细见官网："),s("a",{attrs:{href:"https://redis.io/docs/manual/keyspace-notifications/#events-generated-by-different-commands",target:"_blank",rel:"noopener noreferrer"}},[t._v("Events generated by different commands"),s("OutboundLink")],1)]),t._v(" "),s("h2",{attrs:{id:"keyspace-notifications-源码分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#keyspace-notifications-源码分析"}},[t._v("#")]),t._v(" Keyspace Notifications 源码分析")]),t._v(" "),s("p",[t._v("我们还是以过期事件为例，下面是懒删除找不到 key 时的处理：")]),t._v(" "),s("div",{staticClass:"language-C line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[t._v("robj "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("lookupKey")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("redisDb "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" robj "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" flags"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    dictEntry "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("de "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("dictFind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("db"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("dict"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("key"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("ptr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    robj "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("val "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("de"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        val "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("dictGetVal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("de"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 发现过期了")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("expireIfNeeded")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" expire_flags"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            val "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("val"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ... ")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// notifyKeyspaceEvent 发出通知 对不存在的 key 进行了操作")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("flags "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("LOOKUP_NONOTIFY "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" LOOKUP_WRITE"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("notifyKeyspaceEvent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("NOTIFY_KEY_MISS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"keymiss"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" db"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" val"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br")])]),s("p",[s("code",[t._v("expireIfNeeded")]),t._v(" 方法中，调用如下方法：")]),t._v(" "),s("div",{staticClass:"language-C line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("deleteExpiredKeyAndPropagate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("redisDb "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" robj "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("keyobj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 先删除 key")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("mstime_t")]),t._v(" expire_latency"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("latencyStartMonitor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("expire_latency"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("server"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lazyfree_lazy_expire"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("dbAsyncDelete")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("keyobj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("dbSyncDelete")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("keyobj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("latencyEndMonitor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("expire_latency"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("latencyAddSampleIfNeeded")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"expire-del"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("expire_latency"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// notifyKeyspaceEvent 发出通知 发生了 key 过期事件")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("notifyKeyspaceEvent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("NOTIFY_EXPIRED"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"expired"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("keyobj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("db"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("signalModifiedKey")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" keyobj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("propagateDeletion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("keyobj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("server"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lazyfree_lazy_expire"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    server"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stat_expiredkeys"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br")])]),s("p",[t._v("所以不管是什么类型的事件，都会通过 "),s("code",[t._v("notifyKeyspaceEvent")]),t._v(" 进行消息的发布，第一个参数 type 就代表了事件的类型。 "),s("code",[t._v("notifyKeyspaceEvent")]),t._v(" 就是最核心的部分，源码如下：")]),t._v(" "),s("div",{staticClass:"language-C line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("notifyKeyspaceEvent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" type"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("event"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" robj "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" dbid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// sds 做 key 的拼接")]),t._v("\n    sds chan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    robj "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("chanobj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("eventobj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" len "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" buf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("24")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    eventobj "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createStringObject")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("event"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("strlen")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("event"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* __keyspace@<db>__:<key> <event> notifications. */")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("server"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("notify_keyspace_events "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" NOTIFY_KEYSPACE"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 首先利用 sds 拼接 key ")]),t._v("\n        chan "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sdsnewlen")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"__keyspace@"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        len "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ll2string")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("buf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("buf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("dbid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        chan "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sdscatlen")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" buf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" len"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        chan "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sdscatlen")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"__:"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        chan "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sdscatsds")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("ptr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        chanobj "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createObject")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("OBJ_STRING"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" chan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// pubsub 发布消息")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pubsubPublishMessage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chanobj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" eventobj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("decrRefCount")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chanobj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* __keyevent@<db>__:<event> <key> notifications. */")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("server"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("notify_keyspace_events "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" NOTIFY_KEYEVENT"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        chan "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sdsnewlen")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"__keyevent@"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("len "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" len "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ll2string")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("buf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("buf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("dbid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        chan "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sdscatlen")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" buf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" len"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        chan "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sdscatlen")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"__:"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        chan "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sdscatsds")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" eventobj"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("ptr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        chanobj "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createObject")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("OBJ_STRING"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" chan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pubsubPublishMessage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chanobj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("decrRefCount")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chanobj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("decrRefCount")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eventobj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br"),s("span",{staticClass:"line-number"},[t._v("34")]),s("br"),s("span",{staticClass:"line-number"},[t._v("35")]),s("br"),s("span",{staticClass:"line-number"},[t._v("36")]),s("br")])]),s("p",[t._v("代码逻辑很清晰，就是拼接 key 然后发布到对应的频道上。 "),s("code",[t._v("pubsubPublishMessage")]),t._v(" 方法，就相当于执行了 publish 命令，在 Pub/Sub 源码已经介绍过。")]),t._v(" "),s("h2",{attrs:{id:"keyspace-notifications-的缺点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#keyspace-notifications-的缺点"}},[t._v("#")]),t._v(" Keyspace Notifications 的缺点")]),t._v(" "),s("p",[t._v("既然是基于 Pub/Sub 实现的，那 Pub/Sub 的所有缺点 Keyspace Notifications 也一并继承了。")]),t._v(" "),s("h3",{attrs:{id:"_1、不可靠性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1、不可靠性"}},[t._v("#")]),t._v(" 1、不可靠性")]),t._v(" "),s("p",[t._v("pubsub的消息传递模型是至多一次，不会对消息做持久化，因此出现连接断开时，消息会丢失")]),t._v(" "),s("h3",{attrs:{id:"_2、集群模式的问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2、集群模式的问题"}},[t._v("#")]),t._v(" 2、集群模式的问题")]),t._v(" "),s("p",[t._v("在集群模式下，Keyspace Notifications 就与 Pub/Sub 不太相同了。")]),t._v(" "),s("p",[t._v("在 Redis 7.0 前，集群模式下的全局 Pub/Sub，会导致广播风暴问题；")]),t._v(" "),s("p",[t._v("Redis 7.0 推出了 Shared Pub/Sub 来解决这个问题。")]),t._v(" "),s("p",[t._v("而在集群模式下，Keyspace Notifications 不会进行广播，每个节点只会生成自己 Key 子集的事件。")]),t._v(" "),s("p",[t._v("因此，为了收到所有的事件，客户端需要订阅集群的所有节点。")]),t._v(" "),s("h3",{attrs:{id:"_3、过期-key-事件的延迟"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3、过期-key-事件的延迟"}},[t._v("#")]),t._v(" 3、过期 Key 事件的延迟")]),t._v(" "),s("p",[t._v("过期 Key 事件的通知，并非 TTL 到 0，而是当 Redis 发现过期并真正删除时才会通知，发现 Key 过期的时间取决于过期策略。因此，在 Key 的数量非常多时，过期 Key 事件的通知可能会有分钟级的延迟。")])])}),[],!1,null,null,null);s.default=e.exports}}]);