(window.webpackJsonp=window.webpackJsonp||[]).push([[76],{398:function(s,t,a){"use strict";a.r(t);var e=a(14),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"一、前言"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一、前言"}},[s._v("#")]),s._v(" 一、前言")]),s._v(" "),t("p",[s._v("Redis 是一个基于内存的 K-V 数据库，最著名的特点是单线程。")]),s._v(" "),t("h2",{attrs:{id:"总览-redis"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总览-redis"}},[s._v("#")]),s._v(" 总览 Redis")]),s._v(" "),t("p",[s._v("源码如下：")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("typedef")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("redisDb")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 键值对")]),s._v("\n    dict "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("dict"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 键值对的过期时间 ")]),s._v("\n    dict "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("expires"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("          \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 阻塞的key  Keys with clients waiting for data (BLPOP)")]),s._v("\n    dict "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("blocking_keys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("        \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Blocked keys that received a PUSH")]),s._v("\n    dict "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("ready_keys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("          \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 事务过程中监控的key  WATCHED keys for MULTI/EXEC CAS ")]),s._v("\n    dict "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("watched_keys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("       \n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* Database ID */")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" avg_ttl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* Average TTL, just for stats */")]),s._v("\n    list "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("defrag_later"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* List of key names to attempt to defrag one by one, gradually. */")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" redisDb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("h3",{attrs:{id:"存储k-v-哈希表"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#存储k-v-哈希表"}},[s._v("#")]),s._v(" 存储K-V：哈希表")]),s._v(" "),t("p",[s._v("Redis最核心的存储键值对的方式是：哈希表，好处是定位K-V的速度非常快，但这也决定了Redis不支持Key的范围查询。")]),s._v(" "),t("h3",{attrs:{id:"对象头信息-redisobject"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#对象头信息-redisobject"}},[s._v("#")]),s._v(" 对象头信息：redisObject")]),s._v(" "),t("p",[s._v("在 Redis 中，所有的对象都会包含 redisObject 对象头")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// redisObject共16字节如下")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("typedef")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("redisObject")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unsigned")]),s._v(" type"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 4 bit 如string、list、hash")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unsigned")]),s._v(" encoding"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 4 bit")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unsigned")]),s._v(" lru"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("LRU_BITS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 3字节")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" refcount"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 4字节 引用计数器")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("ptr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 8 个字节 指向具体的内容")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("h3",{attrs:{id:"执行命令-单线程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#执行命令-单线程"}},[s._v("#")]),s._v(" 执行命令：单线程")]),s._v(" "),t("p",[s._v("Redis基于内存，因此单线程速度就够快了，多线程反而变慢。")]),s._v(" "),t("p",[s._v("Redis的并发量的瓶颈不在这里，而是在网络。")]),s._v(" "),t("p",[s._v("Redis 6.0 提供了多线程功能，但执行命令仍然是单线程，只是命令的读取、解析、写回是多线程。")]),s._v(" "),t("h2",{attrs:{id:"redis进线程总览"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis进线程总览"}},[s._v("#")]),s._v(" Redis进线程总览")]),s._v(" "),t("h3",{attrs:{id:"一、redis主线程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一、redis主线程"}},[s._v("#")]),s._v(" 一、Redis主线程")]),s._v(" "),t("p",[s._v("Redis主线程，也叫主进程，这就是我们通常说的Redis单线程。")]),s._v(" "),t("h3",{attrs:{id:"二、redis子进程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二、redis子进程"}},[s._v("#")]),s._v(" 二、Redis子进程")]),s._v(" "),t("p",[s._v("子进程，都是通过fork得到的。")]),s._v(" "),t("h4",{attrs:{id:"_1、重写aof文件-bgrewriteaof子进程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、重写aof文件-bgrewriteaof子进程"}},[s._v("#")]),s._v(" 1、重写AOF文件：bgrewriteaof子进程")]),s._v(" "),t("p",[s._v("AOF的bgrewriteaof，需要fork出一个子进程。")]),s._v(" "),t("h4",{attrs:{id:"_2、rdb主从同步-bgsave子进程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、rdb主从同步-bgsave子进程"}},[s._v("#")]),s._v(" 2、RDB主从同步/bgsave子进程")]),s._v(" "),t("p",[s._v("RDB的bgsave；该子进程同时负责了在主从同步时传输 RDB 给从库。")]),s._v(" "),t("h4",{attrs:{id:"_3、无盘复制rdb主从同步"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3、无盘复制rdb主从同步"}},[s._v("#")]),s._v(" 3、无盘复制RDB主从同步")]),s._v(" "),t("p",[s._v("如果采取了"),t("code",[s._v("repl-diskless-sync yes")]),s._v(" 无盘复制，是由另一个子进程复制传输的。")]),s._v(" "),t("h3",{attrs:{id:"三、redis子线程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三、redis子线程"}},[s._v("#")]),s._v(" 三、Redis子线程")]),s._v(" "),t("p",[s._v("子线程，区别子进程，是通过pthread_create得到的。")]),s._v(" "),t("h4",{attrs:{id:"_1、异步删除-lazy-free"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、异步删除-lazy-free"}},[s._v("#")]),s._v(" 1、异步删除：lazy free")]),s._v(" "),t("p",[s._v("删除键值对和释放空间的操作，是Redis的子线程执行的，当然这需要开启lazy free功能")]),s._v(" "),t("h4",{attrs:{id:"_2、写-aof-日志-everysec"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、写-aof-日志-everysec"}},[s._v("#")]),s._v(" 2、写 AOF 日志：everysec")]),s._v(" "),t("p",[s._v("只有当配置参数为 "),t("code",[s._v("appendfsync everysec")]),s._v(" 时，才会有这个子线程。")]),s._v(" "),t("blockquote",[t("ul",[t("li",[s._v("no  是交给OS决定何时写入")]),s._v(" "),t("li",[s._v("always 是主线程负责写入")])])]),s._v(" "),t("h4",{attrs:{id:"_3、文件关闭"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3、文件关闭"}},[s._v("#")]),s._v(" 3、文件关闭")]),s._v(" "),t("h2",{attrs:{id:"如何找到命令对应的实现源码"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#如何找到命令对应的实现源码"}},[s._v("#")]),s._v(" 如何找到命令对应的实现源码")]),s._v(" "),t("p",[s._v("Redis 会初始化一个 redisCommandTable 命令表，存放着所有命令对应的处理方法。当我们需要知道一个命令具体是如何处理时，通过这张表就能定位到实现函数了。")]),s._v(" "),t("blockquote",[t("p",[s._v("redisCommandTable在 commands.c 中")])]),s._v(" "),t("div",{staticClass:"language-C line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"set"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Set the string value of a key"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"O(1)"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1.0.0"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("CMD_DOC_NONE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("COMMAND_GROUP_STRING"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("SET_History"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("SET_tips"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("setCommand"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("CMD_WRITE"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("CMD_DENYOOM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("ACL_CATEGORY_STRING"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"RW and ACCESS due to the optional `GET` argument"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("CMD_KEY_RW"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("CMD_KEY_ACCESS"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("CMD_KEY_UPDATE"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("CMD_KEY_VARIABLE_FLAGS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("KSPEC_BS_INDEX"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("index"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("KSPEC_FK_RANGE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("range"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("setGetKeys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("args"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("SET_Args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// setCommand 就是 set 对应的实现，在VSCode中为黄色高亮")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h4",{attrs:{id:"参考文档"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考文档"}},[s._v("#")]),s._v(" 参考文档")]),s._v(" "),t("p",[s._v("《Redis 源码剖析与实战》")])])}),[],!1,null,null,null);t.default=n.exports}}]);