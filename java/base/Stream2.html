<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Stream 源码解析（下） | lun&#39;s blogs</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="description" content="blog">
    
    <link rel="preload" href="/blog/assets/css/0.styles.56f5eb6c.css" as="style"><link rel="preload" href="/blog/assets/js/app.7b9df32b.js" as="script"><link rel="preload" href="/blog/assets/js/2.be714ec7.js" as="script"><link rel="preload" href="/blog/assets/js/1.26c7c9cc.js" as="script"><link rel="preload" href="/blog/assets/js/56.ace3e6e3.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.0d71bf2e.js"><link rel="prefetch" href="/blog/assets/js/11.cc81c248.js"><link rel="prefetch" href="/blog/assets/js/12.5e69cd14.js"><link rel="prefetch" href="/blog/assets/js/13.f0bc7bf2.js"><link rel="prefetch" href="/blog/assets/js/14.0188e855.js"><link rel="prefetch" href="/blog/assets/js/15.48a1e71e.js"><link rel="prefetch" href="/blog/assets/js/16.0f4182c9.js"><link rel="prefetch" href="/blog/assets/js/17.ec7b8f9d.js"><link rel="prefetch" href="/blog/assets/js/18.776522e2.js"><link rel="prefetch" href="/blog/assets/js/19.26561e06.js"><link rel="prefetch" href="/blog/assets/js/20.3e42feda.js"><link rel="prefetch" href="/blog/assets/js/21.fd4e7a00.js"><link rel="prefetch" href="/blog/assets/js/22.b59f6079.js"><link rel="prefetch" href="/blog/assets/js/23.e6b2d3ec.js"><link rel="prefetch" href="/blog/assets/js/24.736cfa99.js"><link rel="prefetch" href="/blog/assets/js/25.91176041.js"><link rel="prefetch" href="/blog/assets/js/26.146e299c.js"><link rel="prefetch" href="/blog/assets/js/27.56a57551.js"><link rel="prefetch" href="/blog/assets/js/28.13a846a1.js"><link rel="prefetch" href="/blog/assets/js/29.f71b59d6.js"><link rel="prefetch" href="/blog/assets/js/3.f34ea2f7.js"><link rel="prefetch" href="/blog/assets/js/30.bf0626f9.js"><link rel="prefetch" href="/blog/assets/js/31.47592684.js"><link rel="prefetch" href="/blog/assets/js/32.63f20fc3.js"><link rel="prefetch" href="/blog/assets/js/33.4852d9ec.js"><link rel="prefetch" href="/blog/assets/js/34.4f467138.js"><link rel="prefetch" href="/blog/assets/js/35.17d26444.js"><link rel="prefetch" href="/blog/assets/js/36.d0059312.js"><link rel="prefetch" href="/blog/assets/js/37.fc856e5d.js"><link rel="prefetch" href="/blog/assets/js/38.dc6b373c.js"><link rel="prefetch" href="/blog/assets/js/39.f04e5b6a.js"><link rel="prefetch" href="/blog/assets/js/4.885368ff.js"><link rel="prefetch" href="/blog/assets/js/40.b378efa5.js"><link rel="prefetch" href="/blog/assets/js/41.3c800d8a.js"><link rel="prefetch" href="/blog/assets/js/42.8b804f0c.js"><link rel="prefetch" href="/blog/assets/js/43.832aa078.js"><link rel="prefetch" href="/blog/assets/js/44.d1121c11.js"><link rel="prefetch" href="/blog/assets/js/45.b3e8ede1.js"><link rel="prefetch" href="/blog/assets/js/46.01e4202b.js"><link rel="prefetch" href="/blog/assets/js/47.489850e9.js"><link rel="prefetch" href="/blog/assets/js/48.3bd88d5f.js"><link rel="prefetch" href="/blog/assets/js/49.08c6f759.js"><link rel="prefetch" href="/blog/assets/js/5.d1dbc0b1.js"><link rel="prefetch" href="/blog/assets/js/50.c900e52a.js"><link rel="prefetch" href="/blog/assets/js/51.a59d8fbf.js"><link rel="prefetch" href="/blog/assets/js/52.0c715d23.js"><link rel="prefetch" href="/blog/assets/js/53.07715a2f.js"><link rel="prefetch" href="/blog/assets/js/54.e0d8cc69.js"><link rel="prefetch" href="/blog/assets/js/55.1efa3b0b.js"><link rel="prefetch" href="/blog/assets/js/57.221667c1.js"><link rel="prefetch" href="/blog/assets/js/58.a786e5bd.js"><link rel="prefetch" href="/blog/assets/js/59.8a6dde26.js"><link rel="prefetch" href="/blog/assets/js/6.7ee6eed6.js"><link rel="prefetch" href="/blog/assets/js/60.0192f277.js"><link rel="prefetch" href="/blog/assets/js/61.75813485.js"><link rel="prefetch" href="/blog/assets/js/62.d8de1a01.js"><link rel="prefetch" href="/blog/assets/js/63.a08485a4.js"><link rel="prefetch" href="/blog/assets/js/64.7d19f572.js"><link rel="prefetch" href="/blog/assets/js/65.3f290d9a.js"><link rel="prefetch" href="/blog/assets/js/66.73f49082.js"><link rel="prefetch" href="/blog/assets/js/67.cb22e678.js"><link rel="prefetch" href="/blog/assets/js/68.22dc7228.js"><link rel="prefetch" href="/blog/assets/js/69.1f450482.js"><link rel="prefetch" href="/blog/assets/js/7.153b9c62.js"><link rel="prefetch" href="/blog/assets/js/70.03205c0b.js"><link rel="prefetch" href="/blog/assets/js/71.5b98edf5.js"><link rel="prefetch" href="/blog/assets/js/72.8be00756.js"><link rel="prefetch" href="/blog/assets/js/73.5e60394c.js"><link rel="prefetch" href="/blog/assets/js/74.a1100b64.js"><link rel="prefetch" href="/blog/assets/js/75.b47153bc.js"><link rel="prefetch" href="/blog/assets/js/76.b881f0b9.js"><link rel="prefetch" href="/blog/assets/js/77.eef60dd8.js"><link rel="prefetch" href="/blog/assets/js/78.b52fa32f.js"><link rel="prefetch" href="/blog/assets/js/79.9adc486f.js"><link rel="prefetch" href="/blog/assets/js/80.10b21516.js"><link rel="prefetch" href="/blog/assets/js/81.12c11cbc.js"><link rel="prefetch" href="/blog/assets/js/82.df4ae15b.js"><link rel="prefetch" href="/blog/assets/js/83.078b9ed6.js"><link rel="prefetch" href="/blog/assets/js/84.2d8ccb46.js"><link rel="prefetch" href="/blog/assets/js/85.4d5e44f4.js"><link rel="prefetch" href="/blog/assets/js/86.c32dda95.js"><link rel="prefetch" href="/blog/assets/js/87.c28d1f54.js"><link rel="prefetch" href="/blog/assets/js/88.c06457bb.js"><link rel="prefetch" href="/blog/assets/js/89.1febc082.js"><link rel="prefetch" href="/blog/assets/js/90.37985dbe.js"><link rel="prefetch" href="/blog/assets/js/91.9c3ebd93.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.02634ae8.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.56f5eb6c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="lun's blogs" class="logo"> <span class="site-name can-hide">lun's blogs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/base/Exception.html" class="nav-link">
  异常
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Generics.html" class="nav-link">
  泛型
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Enum.html" class="nav-link">
  枚举
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Serialize.html" class="nav-link">
  Java序列化机制详解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Proxy.html" class="nav-link">
  动态代理
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Annotation.html" class="nav-link">
  深入理解Java注解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream1.html" class="nav-link">
  Stream源码分析(上)
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream2.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Stream源码分析(下)
</a></li></ul></div></div><div class="nav-item"><a href="/blog/java多线程/" class="nav-link">
  Java多线程
</a></div><div class="nav-item"><a href="/blog/jvm/" class="nav-link">
  JVM
</a></div><div class="nav-item"><a href="/blog/redis/" class="nav-link">
  Redis
</a></div><div class="nav-item"><a href="/blog/blogs/" class="nav-link">
  随笔
</a></div><div class="nav-item"><a href="https://juejin.cn/user/2159878519134157" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/base/Exception.html" class="nav-link">
  异常
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Generics.html" class="nav-link">
  泛型
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Enum.html" class="nav-link">
  枚举
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Serialize.html" class="nav-link">
  Java序列化机制详解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Proxy.html" class="nav-link">
  动态代理
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Annotation.html" class="nav-link">
  深入理解Java注解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream1.html" class="nav-link">
  Stream源码分析(上)
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream2.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Stream源码分析(下)
</a></li></ul></div></div><div class="nav-item"><a href="/blog/java多线程/" class="nav-link">
  Java多线程
</a></div><div class="nav-item"><a href="/blog/jvm/" class="nav-link">
  JVM
</a></div><div class="nav-item"><a href="/blog/redis/" class="nav-link">
  Redis
</a></div><div class="nav-item"><a href="/blog/blogs/" class="nav-link">
  随笔
</a></div><div class="nav-item"><a href="https://juejin.cn/user/2159878519134157" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java基础知识</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/java/base/Exception.html" class="sidebar-link">Java异常实现原理</a></li><li><a href="/blog/java/base/Generics.html" class="sidebar-link">泛型</a></li><li><a href="/blog/java/base/Enum.html" class="sidebar-link">枚举</a></li><li><a href="/blog/java/base/Serialize.html" class="sidebar-link">Java序列化机制详解</a></li><li><a href="/blog/java/base/Proxy.html" class="sidebar-link">两种动态代理</a></li><li><a href="/blog/java/base/Annotation.html" class="sidebar-link">注解</a></li><li><a href="/blog/java/base/Stream1.html" class="sidebar-link">Stream 源码解析（上）</a></li><li><a href="/blog/java/base/Stream2.html" aria-current="page" class="active sidebar-link">Stream 源码解析（下）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#stream的终止" class="sidebar-link">Stream的终止</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#终止操作的分类与共性" class="sidebar-link">终止操作的分类与共性</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#短路操作-可以提前终止的操作" class="sidebar-link">短路操作：可以提前终止的操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#匹配操作-matchop" class="sidebar-link">匹配操作：MatchOp</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#anymatch" class="sidebar-link" style="padding-left:3rem;">anyMatch</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#allmatch" class="sidebar-link" style="padding-left:3rem;">allMatch</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#查找操作-findop" class="sidebar-link">查找操作：FindOp</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#findfirst-返回第一个元素" class="sidebar-link" style="padding-left:3rem;">findFirst：返回第一个元素</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#非短路操作-无法提前终止" class="sidebar-link">非短路操作：无法提前终止</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#遍历-foreachop" class="sidebar-link">遍历：ForEachOp</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#foreeah" class="sidebar-link" style="padding-left:3rem;">forEeah</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#聚合-reduceop" class="sidebar-link">聚合：ReduceOp</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#reduce-聚合" class="sidebar-link" style="padding-left:3rem;">reduce：聚合</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#max-min-求最大最小元素" class="sidebar-link" style="padding-left:3rem;">max/min：求最大最小元素</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#collect-将流转化为集合" class="sidebar-link" style="padding-left:3rem;">collect：将流转化为集合</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#终止操作的流程🚩" class="sidebar-link">终止操作的流程🚩</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#_1、terminalop-终止操作" class="sidebar-link">1、TerminalOp：终止操作</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#_2、evaluate-执行操作" class="sidebar-link">2、evaluate()：执行操作</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#四大terminalop架构-共同点" class="sidebar-link">四大TerminalOp架构/共同点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#foreachop" class="sidebar-link">ForEachOp</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#reduceop" class="sidebar-link">ReduceOp</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#findop" class="sidebar-link">FindOp</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#matchop" class="sidebar-link">MatchOp</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#wrapandcopyinto方法" class="sidebar-link">wrapAndCopyInto方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#_1、封装sink" class="sidebar-link">1、封装Sink</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#_2、执行copyinto-遍历处理" class="sidebar-link">2、执行copyInto：遍历处理</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#_2-1、若短路操作" class="sidebar-link" style="padding-left:3rem;">2.1、若短路操作</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#_2-2、若非短路操作" class="sidebar-link" style="padding-left:3rem;">2.2、若非短路操作</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#小结" class="sidebar-link">小结</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#中间操作是如何生效的" class="sidebar-link">中间操作是如何生效的</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#collect方法的参数-collector" class="sidebar-link">collect方法的参数：Collector</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#collector接口" class="sidebar-link" style="padding-left:3rem;">Collector接口</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#collector唯一实现-collectorimpl" class="sidebar-link" style="padding-left:3rem;">Collector唯一实现：CollectorImpl</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#collectors工具类" class="sidebar-link">Collectors工具类</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#tolist-返回arraylist" class="sidebar-link" style="padding-left:3rem;">toList()：返回ArrayList</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#tolist的terminalop" class="sidebar-link" style="padding-left:4rem;">toList的terminalOp</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#joining-字符串拼接" class="sidebar-link" style="padding-left:3rem;">joining()：字符串拼接</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#toset-返回hashset" class="sidebar-link" style="padding-left:3rem;">toSet()：返回HashSet</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#tomap-返回hashmap" class="sidebar-link" style="padding-left:3rem;">toMap()：返回HashMap</a></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#特殊的终止-toarray" class="sidebar-link">特殊的终止：toArray</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#小结-stream语句的原理" class="sidebar-link">小结：Stream语句的原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java/base/Stream2.html#参考文档" class="sidebar-link" style="padding-left:3rem;">参考文档</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="stream-源码解析-下"><a href="#stream-源码解析-下" class="header-anchor">#</a> Stream 源码解析（下）</h1> <p>上文我们介绍了流的创建和中间操作，下面讲一讲Stream的终止操作</p> <h2 id="stream的终止"><a href="#stream的终止" class="header-anchor">#</a> Stream的终止</h2> <h3 id="终止操作的分类与共性"><a href="#终止操作的分类与共性" class="header-anchor">#</a> 终止操作的分类与共性</h3> <p>终止操作又分为「短路操作」和「非短路操作」。</p> <p>之后又根据不同作用分类。</p> <p>下面列出一些常用API，读者可以尝试观察它们的共同点和不同点。</p> <h2 id="短路操作-可以提前终止的操作"><a href="#短路操作-可以提前终止的操作" class="header-anchor">#</a> 短路操作：可以提前终止的操作</h2> <p>如果是短路操作，那么不一定需要完整的遍历整个Stream的元素，在某些条件下，可以提前得到结果，提前结束遍历过程。短路操作有<strong>MatchOp和FindOp</strong>两个TerminalOp实现，分别表示匹配和查找。</p> <blockquote><p>cancellationRequested()：如果返回true，表示sink不再处理Stream中后续的元素，用于短路操作。</p></blockquote> <h3 id="匹配操作-matchop"><a href="#匹配操作-matchop" class="header-anchor">#</a> 匹配操作：MatchOp</h3> <h4 id="anymatch"><a href="#anymatch" class="header-anchor">#</a> anyMatch</h4> <p>有一个匹配就立刻返回true</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">anyMatch</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> P_OUT<span class="token punctuation">&gt;</span></span> predicate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token class-name">MatchOps</span><span class="token punctuation">.</span><span class="token function">makeRef</span><span class="token punctuation">(</span>predicate<span class="token punctuation">,</span> <span class="token class-name">MatchOps<span class="token punctuation">.</span>MatchKind</span><span class="token punctuation">.</span><span class="token constant">ANY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="allmatch"><a href="#allmatch" class="header-anchor">#</a> allMatch</h4> <p>有一个不匹配就立刻返回false</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">allMatch</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> P_OUT<span class="token punctuation">&gt;</span></span> predicate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token class-name">MatchOps</span><span class="token punctuation">.</span><span class="token function">makeRef</span><span class="token punctuation">(</span>predicate<span class="token punctuation">,</span> <span class="token class-name">MatchOps<span class="token punctuation">.</span>MatchKind</span><span class="token punctuation">.</span><span class="token constant">ALL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="查找操作-findop"><a href="#查找操作-findop" class="header-anchor">#</a> 查找操作：FindOp</h3> <h4 id="findfirst-返回第一个元素"><a href="#findfirst-返回第一个元素" class="header-anchor">#</a> findFirst：返回第一个元素</h4> <p>虽然名字叫find但findAny在并行流就是随便返回集合内一个元素，在串行流，就是返回集合的首元素，挺没用的，不支持自定义过滤。要自己匹配还得用match。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span>P_OUT<span class="token punctuation">&gt;</span></span> <span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token class-name">FindOps</span><span class="token punctuation">.</span><span class="token function">makeRef</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>findAny在串行流与findFirst完全相同，如果是并行流，不一定是第一个。</p> <h2 id="非短路操作-无法提前终止"><a href="#非短路操作-无法提前终止" class="header-anchor">#</a> 非短路操作：无法提前终止</h2> <h3 id="遍历-foreachop"><a href="#遍历-foreachop" class="header-anchor">#</a> 遍历：ForEachOp</h3> <h4 id="foreeah"><a href="#foreeah" class="header-anchor">#</a> forEeah</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> P_OUT<span class="token punctuation">&gt;</span></span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token class-name">ForEachOps</span><span class="token punctuation">.</span><span class="token function">makeRef</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>forEachOrdered</strong>：在串行流中，与forEeah的结果没区别。这个是为了保证<strong>并行流对元素的处理顺序是从前往后</strong></p> <h3 id="聚合-reduceop"><a href="#聚合-reduceop" class="header-anchor">#</a> 聚合：ReduceOp</h3> <h4 id="reduce-聚合"><a href="#reduce-聚合" class="header-anchor">#</a> reduce：聚合</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span>P_OUT<span class="token punctuation">&gt;</span></span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">BinaryOperator</span><span class="token generics"><span class="token punctuation">&lt;</span>P_OUT<span class="token punctuation">&gt;</span></span> accumulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token class-name">ReduceOps</span><span class="token punctuation">.</span><span class="token function">makeRef</span><span class="token punctuation">(</span>accumulator<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="max-min-求最大最小元素"><a href="#max-min-求最大最小元素" class="header-anchor">#</a> max/min：求最大最小元素</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span>P_OUT<span class="token punctuation">&gt;</span></span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> P_OUT<span class="token punctuation">&gt;</span></span> comparator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">BinaryOperator</span><span class="token punctuation">.</span><span class="token function">maxBy</span><span class="token punctuation">(</span>comparator<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>也就是max/min实际调用的是上面这个reduce方法</p> <h4 id="collect-将流转化为集合"><a href="#collect-将流转化为集合" class="header-anchor">#</a> collect：将流转化为集合</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span> <span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> P_OUT<span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> collector<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">A</span> container<span class="token punctuation">;</span>
    <span class="token comment">// 去掉了并行流的判断处理</span>
        container <span class="token operator">=</span> <span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token class-name">ReduceOps</span><span class="token punctuation">.</span><span class="token function">makeRef</span><span class="token punctuation">(</span>collector<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> collector<span class="token punctuation">.</span><span class="token function">characteristics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">Collector<span class="token punctuation">.</span>Characteristics</span><span class="token punctuation">.</span><span class="token constant">IDENTITY_FINISH</span><span class="token punctuation">)</span>
           <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">)</span> container
           <span class="token operator">:</span> collector<span class="token punctuation">.</span><span class="token function">finisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="终止操作的流程🚩"><a href="#终止操作的流程🚩" class="header-anchor">#</a> 终止操作的流程🚩</h2> <ol><li>所有方法都根据作用分类成了不同的Op，它们的父类都是TerminalOp。调用了对应的xxxOps工厂类的makeRef方法得到一个TerminalOp的实现类。</li> <li>执行evaluate方法。</li></ol> <p>简单说，就是利用工厂类，根据你的特点，<strong>生成一个终止操作：TerminalOp，然后evaluate</strong>。</p> <h3 id="_1、terminalop-终止操作"><a href="#_1、terminalop-终止操作" class="header-anchor">#</a> 1、TerminalOp：终止操作</h3> <p>这里插一嘴，TerminalOp不像前面都继承自pipeline。TerminalOp自己就是个<strong>顶层的父接口</strong>。</p> <p>并且<strong>TerminalOp并不会像其他中间操作一样仍返回一个Stream</strong>。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">interface</span> <span class="token class-name">TerminalOp</span><span class="token generics"><span class="token punctuation">&lt;</span>E_IN<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    
    <span class="token keyword">default</span> <span class="token class-name">StreamShape</span> <span class="token function">inputShape</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token class-name">StreamShape</span><span class="token punctuation">.</span><span class="token constant">REFERENCE</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">default</span> <span class="token keyword">int</span> <span class="token function">getOpFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">// 并行 evaluate</span>
    <span class="token keyword">default</span> <span class="token generics"><span class="token punctuation">&lt;</span>P_IN<span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span> <span class="token function">evaluateParallel</span><span class="token punctuation">(</span><span class="token class-name">PipelineHelper</span><span class="token generics"><span class="token punctuation">&lt;</span>E_IN<span class="token punctuation">&gt;</span></span> helper<span class="token punctuation">,</span>
                                      <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span>P_IN<span class="token punctuation">&gt;</span></span> spliterator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 简略了一下</span>
        <span class="token keyword">return</span> <span class="token function">evaluateSequential</span><span class="token punctuation">(</span>helper<span class="token punctuation">,</span> spliterator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 串行 evaluate 抽象方法</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>P_IN<span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span> <span class="token function">evaluateSequential</span><span class="token punctuation">(</span><span class="token class-name">PipelineHelper</span><span class="token generics"><span class="token punctuation">&lt;</span>E_IN<span class="token punctuation">&gt;</span></span> helper<span class="token punctuation">,</span>
                                <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span>P_IN<span class="token punctuation">&gt;</span></span> spliterator<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_2、evaluate-执行操作"><a href="#_2、evaluate-执行操作" class="header-anchor">#</a> 2、evaluate()：执行操作</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span> <span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token class-name">TerminalOp</span><span class="token generics"><span class="token punctuation">&lt;</span>E_OUT<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> terminalOp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 忽略校验</span>
    <span class="token keyword">return</span> <span class="token function">isParallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
           <span class="token operator">?</span>  <span class="token comment">// 并行</span>
 terminalOp<span class="token punctuation">.</span><span class="token function">evaluateParallel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token function">sourceSpliterator</span><span class="token punctuation">(</span>terminalOp<span class="token punctuation">.</span><span class="token function">getOpFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token operator">:</span>  <span class="token comment">// 串行             </span>
 terminalOp<span class="token punctuation">.</span><span class="token function">evaluateSequential</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token function">sourceSpliterator</span><span class="token punctuation">(</span>terminalOp<span class="token punctuation">.</span><span class="token function">getOpFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>也就是真正的执行是terminalOp.evaluateSequential方法，是写在terminalOp内部的</p> <p>那么核心点就在于terminalOp了。</p> <h2 id="四大terminalop架构-共同点"><a href="#四大terminalop架构-共同点" class="header-anchor">#</a> 四大TerminalOp架构/共同点</h2> <ul><li>都是<strong>工厂模式</strong>，由xxxOps.makeRef方法创建对象。</li> <li>都<strong>重写了evaluateXXX</strong>方法，即一个Stream流语句的最终执行</li> <li>都实现了TerminalOp接口</li> <li>evaluateXXX方法<strong>最终都是调用pipeline的wrapAndCopyInto方法</strong></li></ul> <h3 id="foreachop"><a href="#foreachop" class="header-anchor">#</a> ForEachOp</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ForEachOp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">TerminalOp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">TerminalSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>TerminalOp接口</strong>：前文介绍过，主要是提供了evaluate方法的具体实现</p> <p><strong>TerminalSink接口</strong>：继承了Sink和Supplier，Sink继承自Consumer，有消费能力的同时提供了begin/end。Supplier也是lambda表达式，无参有返回值。</p> <p>重点是重写了evaluate方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 因为foreach没有返回值，所以get返回null this就是当前的TerminalOp</span>
<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Void</span> <span class="token function">evaluateSequential</span><span class="token punctuation">(</span><span class="token class-name">PipelineHelper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> helper<span class="token punctuation">,</span>
                                   <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> spliterator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> helper<span class="token punctuation">.</span><span class="token function">wrapAndCopyInto</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> spliterator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="reduceop"><a href="#reduceop" class="header-anchor">#</a> ReduceOp</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ReduceOp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">S</span> <span class="token keyword">extends</span> <span class="token class-name">AccumulatingSink</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">TerminalOp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// makeSink方法抽象</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">S</span> <span class="token function">makeSink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 不关注并行了。实现了evaluateSequential方法</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span>P_IN<span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span> <span class="token function">evaluateSequential</span><span class="token punctuation">(</span><span class="token class-name">PipelineHelper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> helper<span class="token punctuation">,</span>
                                       <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span>P_IN<span class="token punctuation">&gt;</span></span> spliterator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> helper<span class="token punctuation">.</span><span class="token function">wrapAndCopyInto</span><span class="token punctuation">(</span><span class="token function">makeSink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> spliterator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="findop"><a href="#findop" class="header-anchor">#</a> FindOp</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">FindOp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">O</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">TerminalOp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">O</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// 核心属性</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StreamShape</span> shape<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> mustFindFirst<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">O</span> emptyValue<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">&gt;</span></span> presentPredicate<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TerminalSink</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">O</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> sinkSupplier<span class="token punctuation">;</span>
    <span class="token comment">// 方法</span>
   <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">O</span> <span class="token function">evaluateSequential</span><span class="token punctuation">(</span><span class="token class-name">PipelineHelper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> helper<span class="token punctuation">,</span><span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> spliterator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">O</span> result <span class="token operator">=</span> helper<span class="token punctuation">.</span><span class="token function">wrapAndCopyInto</span><span class="token punctuation">(</span>sinkSupplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> spliterator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> result <span class="token operator">:</span> emptyValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>可以看到也是wrapAndCopyInto方法。</p> <h3 id="matchop"><a href="#matchop" class="header-anchor">#</a> MatchOp</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">MatchOp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">TerminalOp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StreamShape</span> inputShape<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">MatchKind</span> matchKind<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BooleanTerminalSink</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> sinkSupplier<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Boolean</span> <span class="token function">evaluateSequential</span><span class="token punctuation">(</span><span class="token class-name">PipelineHelper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> helper<span class="token punctuation">,</span>
                                              <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> spliterator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> helper<span class="token punctuation">.</span><span class="token function">wrapAndCopyInto</span><span class="token punctuation">(</span>sinkSupplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> spliterator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAndClearState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="wrapandcopyinto方法"><a href="#wrapandcopyinto方法" class="header-anchor">#</a> wrapAndCopyInto方法</h2> <p><strong>四大Op的evaluateSequential方法都调用了pipeline的wrapAndCopyInto方法。</strong></p> <p>正如方法名：</p> <ol><li>wrap包装sink</li> <li>执行CopyInto方法</li></ol> <p>wrapAndCopyInto方法的实现在AbstractPipeline</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token generics"><span class="token punctuation">&lt;</span>P_IN<span class="token punctuation">,</span> <span class="token class-name">S</span> <span class="token keyword">extends</span> <span class="token class-name">Sink</span><span class="token punctuation">&lt;</span>E_OUT<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">S</span> <span class="token function">wrapAndCopyInto</span><span class="token punctuation">(</span><span class="token class-name">S</span> sink<span class="token punctuation">,</span> <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span>P_IN<span class="token punctuation">&gt;</span></span> spliterator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">copyInto</span><span class="token punctuation">(</span><span class="token function">wrapSink</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>sink<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> spliterator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sink<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_1、封装sink"><a href="#_1、封装sink" class="header-anchor">#</a> 1、封装Sink</h3> <p>这里首先有一个wrapSink方法，对sink的封装</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token generics"><span class="token punctuation">&lt;</span>P_IN<span class="token punctuation">&gt;</span></span> <span class="token class-name">Sink</span><span class="token generics"><span class="token punctuation">&lt;</span>P_IN<span class="token punctuation">&gt;</span></span> <span class="token function">wrapSink</span><span class="token punctuation">(</span><span class="token class-name">Sink</span><span class="token generics"><span class="token punctuation">&lt;</span>E_OUT<span class="token punctuation">&gt;</span></span> sink<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token class-name">AbstractPipeline</span> p<span class="token operator">=</span><span class="token class-name">AbstractPipeline</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">;</span> p<span class="token punctuation">.</span>depth <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> p<span class="token operator">=</span>p<span class="token punctuation">.</span>previousStage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sink <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">opWrapSink</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>previousStage<span class="token punctuation">.</span>combinedFlags<span class="token punctuation">,</span> sink<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Sink</span><span class="token generics"><span class="token punctuation">&lt;</span>P_IN<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> sink<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可以看到，<strong>往回遍历双向链表然后调用opWrapSink方法，仍然返回一个sink</strong>。</p> <p>opWrapSink方法还记得吗？是所有不管有无状态的Op即<strong>中间操作必须重写的方法</strong>。</p> <p>这里回顾一下map的：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token class-name">Sink</span><span class="token generics"><span class="token punctuation">&lt;</span>P_OUT<span class="token punctuation">&gt;</span></span> <span class="token function">opWrapSink</span><span class="token punctuation">(</span><span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token class-name">Sink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> sink<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// 返回 Sink.ChainedReference</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Sink<span class="token punctuation">.</span>ChainedReference</span><span class="token generics"><span class="token punctuation">&lt;</span>P_OUT<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>sink<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token class-name">P_OUT</span> u<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 这个mapper就是 map(mapper) lambda表达式，比如 映射到Id就是 User::getId</span>
                downstream<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>mapper<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>ChainedReference有一个核心属性：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Sink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> E_OUT<span class="token punctuation">&gt;</span></span> downstream<span class="token punctuation">;</span>
<span class="token comment">// 即下一个的Sink，从而实现Sink的相连</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>又重写了accept方法，即当前Op先apply结束以后，再调用下一个的Op，从而实现了所有Op的相连，返回了一个最终的Sink。</p> <p>至此确定了copyInto的wrappedSink参数。</p> <h3 id="_2、执行copyinto-遍历处理"><a href="#_2、执行copyinto-遍历处理" class="header-anchor">#</a> 2、执行copyInto：遍历处理</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// wrapAndCopyInto 调用 copyInto</span>
    <span class="token keyword">final</span> <span class="token generics"><span class="token punctuation">&lt;</span>P_IN<span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">copyInto</span><span class="token punctuation">(</span><span class="token class-name">Sink</span><span class="token generics"><span class="token punctuation">&lt;</span>P_IN<span class="token punctuation">&gt;</span></span> wrappedSink<span class="token punctuation">,</span> <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span>P_IN<span class="token punctuation">&gt;</span></span> spliterator<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StreamOpFlag</span><span class="token punctuation">.</span><span class="token constant">SHORT_CIRCUIT</span><span class="token punctuation">.</span><span class="token function">isKnown</span><span class="token punctuation">(</span><span class="token function">getStreamAndOpFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            wrappedSink<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span>spliterator<span class="token punctuation">.</span><span class="token function">getExactSizeIfKnown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            spliterator<span class="token punctuation">.</span><span class="token function">forEachRemaining</span><span class="token punctuation">(</span>wrappedSink<span class="token punctuation">)</span><span class="token punctuation">;</span>
            wrappedSink<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">copyIntoWithCancel</span><span class="token punctuation">(</span>wrappedSink<span class="token punctuation">,</span> spliterator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>SHORT_CIRCUIT是短路的意思，因此如果是短路操作，进入 copyIntoWithCancel；否则forEachRemaining</p> <h4 id="_2-1、若短路操作"><a href="#_2-1、若短路操作" class="header-anchor">#</a> 2.1、若短路操作</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token generics"><span class="token punctuation">&lt;</span>P_IN<span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">copyIntoWithCancel</span><span class="token punctuation">(</span><span class="token class-name">Sink</span><span class="token generics"><span class="token punctuation">&lt;</span>P_IN<span class="token punctuation">&gt;</span></span> wrappedSink<span class="token punctuation">,</span> <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span>P_IN<span class="token punctuation">&gt;</span></span> spliterator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 链表尾</span>
    <span class="token class-name">AbstractPipeline</span> p <span class="token operator">=</span> <span class="token class-name">AbstractPipeline</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>depth <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        p <span class="token operator">=</span> p<span class="token punctuation">.</span>previousStage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    wrappedSink<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span>spliterator<span class="token punctuation">.</span><span class="token function">getExactSizeIfKnown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 依次消费所有元素</span>
    p<span class="token punctuation">.</span><span class="token function">forEachWithCancel</span><span class="token punctuation">(</span>spliterator<span class="token punctuation">,</span> wrappedSink<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    wrappedSink<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">forEachWithCancel</span><span class="token punctuation">(</span><span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span>P_OUT<span class="token punctuation">&gt;</span></span> spliterator<span class="token punctuation">,</span> <span class="token class-name">Sink</span><span class="token generics"><span class="token punctuation">&lt;</span>P_OUT<span class="token punctuation">&gt;</span></span> sink<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>sink<span class="token punctuation">.</span><span class="token function">cancellationRequested</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> spliterator<span class="token punctuation">.</span><span class="token function">tryAdvance</span><span class="token punctuation">(</span>sink<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">// tryAdvance就是，用lambda表达式的accept方法消费一个元素，sink就是consumer的子类，有accept方法</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="_2-2、若非短路操作"><a href="#_2-2、若非短路操作" class="header-anchor">#</a> 2.2、若非短路操作</h4> <p>非短路操作：</p> <ul><li><strong>先begin</strong></li> <li><strong>后spliterator.forEachRemaining(wrappedSink);</strong></li> <li><strong>最后end</strong></li></ul> <p><strong>begin和end都被StatexxxOp重写，而forEachRemaining又被各种spliterator重写</strong></p> <p>这里以ArrayListSpliterator为例：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">forEachRemaining</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> hi<span class="token punctuation">,</span> mc<span class="token punctuation">;</span> <span class="token comment">// hoist accesses and checks from loop</span>
    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> lst<span class="token punctuation">;</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>lst <span class="token operator">=</span> list<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> lst<span class="token punctuation">.</span>elementData<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>hi <span class="token operator">=</span> fence<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mc <span class="token operator">=</span> lst<span class="token punctuation">.</span>modCount<span class="token punctuation">;</span>
            hi <span class="token operator">=</span> lst<span class="token punctuation">.</span>size<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
            mc <span class="token operator">=</span> expectedModCount<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> index<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>index <span class="token operator">=</span> hi<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> a<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> hi<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">E</span> e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                action<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lst<span class="token punctuation">.</span>modCount <span class="token operator">==</span> mc<span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentModificationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>就是遍历处理。</p> <p>在evaluateSequential方法的最后，通常还有一个get方法，用于获取返回值。</p> <p>至此，终止操作分析完毕。</p> <h3 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h3> <p>终止操作：大概是创建一个TerminalOp，然后调用evaluate方法处理。evaluate最终依赖wrapAndCopyInto，会遍历双向链表来封装一个链式Sink，然后遍历元素调用lambda表达式即sink来处理。</p> <h2 id="中间操作是如何生效的"><a href="#中间操作是如何生效的" class="header-anchor">#</a> 中间操作是如何生效的</h2> <p>非短路下：先begin方法。再accpet。最后end。</p> <p>一般都是链式调用，我处理完了，给我下一个处理。但是不乏特殊的，比如sorted：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">begin</span><span class="token punctuation">(</span><span class="token keyword">long</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    list <span class="token operator">=</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> size<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 排序</span>
    list<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>comparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    downstream<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 非短路 全部处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cancellationWasRequested<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>downstream<span class="token operator">::</span><span class="token function">accept</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 短路 随时可能会break</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">T</span> t <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>downstream<span class="token punctuation">.</span><span class="token function">cancellationRequested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            downstream<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    downstream<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token class-name">T</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 并没有向下传递</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>begin，accept方法并不是链式调用，相反，begin直接停住了new一个ArrayList，accept是往自己的ArrayList添加元素。那么我们知道后面的accept方法就不会被调用到了，于是开始end。此时又会让下游begin，accept，end走一套。</p> <h2 id="collect方法的参数-collector"><a href="#collect方法的参数-collector" class="header-anchor">#</a> collect方法的参数：Collector</h2> <p>collect方法与别的终止操作有些不一样。</p> <p>Collectors.toList()返回一个Collector接口，这个方法做了些什么呢？</p> <h4 id="collector接口"><a href="#collector接口" class="header-anchor">#</a> Collector接口</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// 四个lambda方法</span>
    <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">&gt;</span></span> <span class="token function">supplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">BiConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">accumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">BinaryOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">&gt;</span></span> <span class="token function">combiner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">finisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Characteristics枚举类 ： CONCURRENT / UNORDERED / IDENTITY_FINISH</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Characteristics</span><span class="token punctuation">&gt;</span></span> <span class="token function">characteristics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="collector唯一实现-collectorimpl"><a href="#collector唯一实现-collectorimpl" class="header-anchor">#</a> Collector唯一实现：CollectorImpl</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CollectorImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
      <span class="token comment">// 五个属性 分别对应五个方法</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">&gt;</span></span> supplier<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BiConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> accumulator<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BinaryOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">&gt;</span></span> combiner<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> finisher<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Characteristics</span><span class="token punctuation">&gt;</span></span> characteristics<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>实际上，这也是Collector的最大的作用了。</p> <p>Collector<strong>仅仅起到了封装数据(一些lambda表达式)的作用</strong>。</p> <h2 id="collectors工具类"><a href="#collectors工具类" class="header-anchor">#</a> Collectors工具类</h2> <h4 id="tolist-返回arraylist"><a href="#tolist-返回arraylist" class="header-anchor">#</a> toList()：返回ArrayList</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CollectorImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                        <span class="token number">1</span>      <span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">ArrayList</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">,</span>
                        <span class="token number">2</span>       <span class="token class-name">List</span><span class="token operator">::</span><span class="token function">add</span><span class="token punctuation">,</span>
                        <span class="token number">3</span>       <span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> left<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> left<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token number">4</span>       <span class="token constant">CH_ID</span> <span class="token comment">// 这个可以不用管</span>
                              <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 上面调用的是这个构造方法</span>
<span class="token comment">// 1 Supplier 无参，有返回值</span>
<span class="token comment">// 2 BiConsumer 两个参数，没有返回值</span>
<span class="token comment">// 3 BinaryOperator 两个入参，有返回值，三者类型相同，在toList这里的类型是ArrayList</span>
<span class="token comment">// 猜测：这里用 BinaryOperator 应该是为了让并行也能用吧...</span>
      <span class="token class-name">CollectorImpl</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">&gt;</span></span> supplier<span class="token punctuation">,</span>
                      <span class="token class-name">BiConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> accumulator<span class="token punctuation">,</span>
                      <span class="token class-name">BinaryOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">&gt;</span></span> combiner<span class="token punctuation">,</span>
                      <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Characteristics</span><span class="token punctuation">&gt;</span></span> characteristics<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">// 依次赋值  finisher比较特殊一点，是 finisher  =  castingIdentity()</span>
        <span class="token punctuation">}</span>
  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>Collectors.toList()方法生成了一个CollectorImpl实例，实现了Collector接口。传递了三个lambda方法</p> <ul><li>new 一个ArrayList</li> <li>向ArrayList add元素</li> <li>向ArrayList addAll另一个ArrayList 的元素</li></ul> <h5 id="tolist的terminalop"><a href="#tolist的terminalop" class="header-anchor">#</a> toList的terminalOp</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">I</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">TerminalOp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">I</span><span class="token punctuation">&gt;</span></span> <span class="token function">makeRef</span><span class="token punctuation">(</span><span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> collector<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回一个 TerminalOp</span>
    <span class="token comment">// supplier 是 ArrayList::new</span>
    <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">&gt;</span></span> supplier <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>collector<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">supplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// accumulator 是 List::add</span>
    <span class="token class-name">BiConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> accumulator <span class="token operator">=</span> collector<span class="token punctuation">.</span><span class="token function">accumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// combiner 是 (left, right) -&gt; { left.addAll(right); return left; }</span>
    <span class="token class-name">BinaryOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">&gt;</span></span> combiner <span class="token operator">=</span> collector<span class="token punctuation">.</span><span class="token function">combiner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ---------------------</span>
    <span class="token keyword">class</span> <span class="token class-name">ReducingSink</span> <span class="token keyword">extends</span> <span class="token class-name">Box</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">I</span><span class="token punctuation">&gt;</span></span>
            <span class="token keyword">implements</span> <span class="token class-name">AccumulatingSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">ReducingSink</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token comment">// 就是new一个ArrayList</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">begin</span><span class="token punctuation">(</span><span class="token keyword">long</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            state <span class="token operator">=</span> supplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 向ArrayList add一个元素</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token class-name">T</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            accumulator<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 向ArrayList add 另一个ArrayList的所有元素</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">combine</span><span class="token punctuation">(</span><span class="token class-name">ReducingSink</span> other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            state <span class="token operator">=</span> combiner<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> other<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ---------------------    </span>
    <span class="token comment">// 以上可以概括为取出CollectorImpl的几个重要的表达式</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReduceOp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">I</span><span class="token punctuation">,</span> <span class="token class-name">ReducingSink</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">StreamShape</span><span class="token punctuation">.</span><span class="token constant">REFERENCE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ReducingSink</span> <span class="token function">makeSink</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReducingSink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 省略 getOpFlags</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>至此，得到一个ReduceOp实例，并重写了makeSink方法。makeSink用作wrapAndCopyInto方法的入参。</p> <p>在evaluate时，ReduceOp也会被当成和普通的StatexxxOp一样，被调用begin，end，accept方法，他的sink在整个sinke链条的最后。因此实现了将结果转化为一个ArrayList。</p> <h4 id="joining-字符串拼接"><a href="#joining-字符串拼接" class="header-anchor">#</a> joining()：字符串拼接</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;java&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;scala&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;go&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;python&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 输出 ： java,scala,go,python</span>
<span class="token comment">// 支持无参直接拼接，也支持分隔符</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>通过分析toList我们已经知道，<strong>Collector只是封装几个函数，因此不同方法只是几个lambda表达式方法和别人的不同，因此后文只关注这些方法</strong>。</p> <p>joining()就是：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CharSequence</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">joining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CollectorImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CharSequence</span><span class="token punctuation">,</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
            <span class="token class-name">StringBuilder</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">,</span>  <span class="token comment">// 1</span>
            <span class="token class-name">StringBuilder</span><span class="token operator">::</span><span class="token function">append</span><span class="token punctuation">,</span> <span class="token comment">// 2 </span>
            <span class="token punctuation">(</span>r1<span class="token punctuation">,</span> r2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> r1<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>r2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> r1<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">// 3</span>
            <span class="token class-name">StringBuilder</span><span class="token operator">::</span><span class="token function">toString</span><span class="token punctuation">,</span> <span class="token comment">// 4</span>
            <span class="token constant">CH_NOID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>多写了一个方法：将StringBuilder转化为String，多指定了finisher方法，这在ArrayList没有。</p> <h4 id="toset-返回hashset"><a href="#toset-返回hashset" class="header-anchor">#</a> toSet()：返回HashSet</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span>
<span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CollectorImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                               <span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">HashSet</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">,</span> 
                               <span class="token class-name">Set</span><span class="token operator">::</span><span class="token function">add</span><span class="token punctuation">,</span>
                               <span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> left<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> left<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                               <span class="token constant">CH_UNORDERED_ID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="tomap-返回hashmap"><a href="#tomap-返回hashmap" class="header-anchor">#</a> toMap()：返回HashMap</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">U</span><span class="token punctuation">,</span> <span class="token class-name">M</span> <span class="token keyword">extends</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">U</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
<span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">M</span><span class="token punctuation">&gt;</span></span> <span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> keyMapper<span class="token punctuation">,</span>
                            <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> valueMapper<span class="token punctuation">,</span>
                            <span class="token class-name">BinaryOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">U</span><span class="token punctuation">&gt;</span></span> mergeFunction<span class="token punctuation">,</span>
                            <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">M</span><span class="token punctuation">&gt;</span></span> mapSupplier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">BiConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">M</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> accumulator
            <span class="token operator">=</span> <span class="token punctuation">(</span>map<span class="token punctuation">,</span> element<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> map<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>keyMapper<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 处理k</span>
                                          valueMapper<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 处理v</span>
                                          mergeFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// merge方法可以简单理解为 add 只不过可以自定义key相同的情况，如何处理，下面可以看到源码</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CollectorImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>mapSupplier<span class="token punctuation">,</span>  <span class="token comment">// new </span>
                               accumulator<span class="token punctuation">,</span>  <span class="token comment">// merge</span>
                               <span class="token function">mapMerger</span><span class="token punctuation">(</span>mergeFunction<span class="token punctuation">)</span><span class="token punctuation">,</span>
                               <span class="token constant">CH_ID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>toMap()要稍微特殊一点，可以看到他有个mergeFunction的函数，这个是处理两个key一模一样的情况的。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// merge是map接口下的方法 主要是利用remappingFunction 决定key相同时，用哪个value</span>
<span class="token keyword">default</span> <span class="token class-name">V</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span>
        <span class="token class-name">BiFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">V</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">V</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> remappingFunction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">V</span> oldValue <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">V</span> newValue <span class="token operator">=</span> <span class="token punctuation">(</span>oldValue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> value <span class="token operator">:</span>
               remappingFunction<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>newValue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> newValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>除了上述这些内容，Collectors还提供了max/minBy，reuducing，averaging，summing等等方法，就不一一介绍了。</p> <h3 id="特殊的终止-toarray"><a href="#特殊的终止-toarray" class="header-anchor">#</a> 特殊的终止：toArray</h3> <p>这个就不关心实现了，但它和别人确实都不太一样。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">toArray</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">A</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">toArray</span><span class="token punctuation">(</span><span class="token class-name">IntFunction</span><span class="token operator">&lt;</span><span class="token class-name">A</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> generator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token class-name">Nodes</span><span class="token punctuation">.</span><span class="token function">flatten</span><span class="token punctuation">(</span><span class="token function">evaluateToArrayNode</span><span class="token punctuation">(</span>generator<span class="token punctuation">)</span><span class="token punctuation">,</span> generator<span class="token punctuation">)</span>
                              <span class="token punctuation">.</span><span class="token function">asArray</span><span class="token punctuation">(</span>generator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="小结-stream语句的原理"><a href="#小结-stream语句的原理" class="header-anchor">#</a> 小结：Stream语句的原理</h2> <p>第一步，肯定是<strong>创建Stream流对象</strong>，众所周知Stream是个接口。因此我们创建的流的实体类是：Pipeline。用的最多的是ReferencePipeline，他又有三个内部类：Head头节点，无状态操作，和有状态的操作。这两种状态的操作我又理解成普通节点。因为它是已<strong>双向链表的形式</strong>组织起来所有的Option的，头节点是特殊的Head，其余节点就是这两种Option。创建对象呢又依赖StreamSupport.stream方法。这里又有三种创建流对象的方法底层全都依赖StreamSupport，会返回一个Head头节点。</p> <p>第二步，就是很多<strong>中间操作</strong>，比如我们常用的map映射，然后sorted排序这些。这些方法的实现都在AbstractPipeline，是ReferencePipeline的父类。也并不复杂，通常是创建一个节点，就是无状态操作，和有状态操作中的一个，然后插入到链表尾部。然后StatelessOp这也是抽象类，虽然Stream是个惰性流，但我们也要存储你的lambda表达式，所以我们要重写opWrapSink方法，这个方法很重要，会在终止Stream的时候使用。</p> <p>最后一步，也就是<strong>终止操作</strong>。终止操作又有很多种比如collect，foreach这些。这些方法会创建一个<strong>TerminalOp</strong>对象。TerminalOp又有很多子类，这里我拿collect举例吧，就是ReduceOp，利用ReduceOps的makeRef方法创建对象。如果是collect(Collections.toList())的话他就会向最后这个ReduceOp存储三个lambda方法，就是创建ArrayList，以及ArrayList的add和addAll方法。然后这个ReduceOp还会重写一个方法叫makeSink。这个Sink是一个Consumer的子类，就也是一个lambda表达式。最后呢我们执行evaluate方法，会先调用这个makeSink方法取出TerminalOp的Sink，然后对它做一个封装，就是第二步中间操作提到的重写的opWrapSink方法，我们会从后往前遍历双向链表，依次调用这个opWrapSink方法，那这个方法的逻辑是取决于你的Option的，比如map是返回一个Sink.ChainedReference，首先它内部有一个它后续的Sink，其次重写它的accpet方法就是lambda表达式嘛，会先执行当前的lambda式以后，调用后续Sink的accept方法，以此实现对所有的lambda表达式的依次执行，执行完以后就返回了。</p> <p>整个流程大概就是这样。</p> <h4 id="参考文档"><a href="#参考文档" class="header-anchor">#</a> 参考文档</h4> <p><a href="https://juejin.cn/post/7103718952626290695" target="_blank" rel="noopener noreferrer">Java8 Stream源码精讲（四）：一文说透四种终止操作<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/java/base/Stream1.html" class="prev">
        Stream 源码解析（上）
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.7b9df32b.js" defer></script><script src="/blog/assets/js/2.be714ec7.js" defer></script><script src="/blog/assets/js/1.26c7c9cc.js" defer></script><script src="/blog/assets/js/56.ace3e6e3.js" defer></script>
  </body>
</html>
