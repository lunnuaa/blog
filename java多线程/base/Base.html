<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>多线程基础知识 | lun&#39;s blogs</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="description" content="blog">
    
    <link rel="preload" href="/blog/assets/css/0.styles.56f5eb6c.css" as="style"><link rel="preload" href="/blog/assets/js/app.7b9df32b.js" as="script"><link rel="preload" href="/blog/assets/js/2.be714ec7.js" as="script"><link rel="preload" href="/blog/assets/js/1.26c7c9cc.js" as="script"><link rel="preload" href="/blog/assets/js/37.fc856e5d.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.0d71bf2e.js"><link rel="prefetch" href="/blog/assets/js/11.cc81c248.js"><link rel="prefetch" href="/blog/assets/js/12.5e69cd14.js"><link rel="prefetch" href="/blog/assets/js/13.f0bc7bf2.js"><link rel="prefetch" href="/blog/assets/js/14.0188e855.js"><link rel="prefetch" href="/blog/assets/js/15.48a1e71e.js"><link rel="prefetch" href="/blog/assets/js/16.0f4182c9.js"><link rel="prefetch" href="/blog/assets/js/17.ec7b8f9d.js"><link rel="prefetch" href="/blog/assets/js/18.776522e2.js"><link rel="prefetch" href="/blog/assets/js/19.26561e06.js"><link rel="prefetch" href="/blog/assets/js/20.3e42feda.js"><link rel="prefetch" href="/blog/assets/js/21.fd4e7a00.js"><link rel="prefetch" href="/blog/assets/js/22.b59f6079.js"><link rel="prefetch" href="/blog/assets/js/23.e6b2d3ec.js"><link rel="prefetch" href="/blog/assets/js/24.736cfa99.js"><link rel="prefetch" href="/blog/assets/js/25.91176041.js"><link rel="prefetch" href="/blog/assets/js/26.146e299c.js"><link rel="prefetch" href="/blog/assets/js/27.56a57551.js"><link rel="prefetch" href="/blog/assets/js/28.13a846a1.js"><link rel="prefetch" href="/blog/assets/js/29.f71b59d6.js"><link rel="prefetch" href="/blog/assets/js/3.f34ea2f7.js"><link rel="prefetch" href="/blog/assets/js/30.bf0626f9.js"><link rel="prefetch" href="/blog/assets/js/31.47592684.js"><link rel="prefetch" href="/blog/assets/js/32.63f20fc3.js"><link rel="prefetch" href="/blog/assets/js/33.4852d9ec.js"><link rel="prefetch" href="/blog/assets/js/34.4f467138.js"><link rel="prefetch" href="/blog/assets/js/35.17d26444.js"><link rel="prefetch" href="/blog/assets/js/36.d0059312.js"><link rel="prefetch" href="/blog/assets/js/38.dc6b373c.js"><link rel="prefetch" href="/blog/assets/js/39.f04e5b6a.js"><link rel="prefetch" href="/blog/assets/js/4.885368ff.js"><link rel="prefetch" href="/blog/assets/js/40.b378efa5.js"><link rel="prefetch" href="/blog/assets/js/41.3c800d8a.js"><link rel="prefetch" href="/blog/assets/js/42.8b804f0c.js"><link rel="prefetch" href="/blog/assets/js/43.832aa078.js"><link rel="prefetch" href="/blog/assets/js/44.d1121c11.js"><link rel="prefetch" href="/blog/assets/js/45.b3e8ede1.js"><link rel="prefetch" href="/blog/assets/js/46.01e4202b.js"><link rel="prefetch" href="/blog/assets/js/47.489850e9.js"><link rel="prefetch" href="/blog/assets/js/48.3bd88d5f.js"><link rel="prefetch" href="/blog/assets/js/49.08c6f759.js"><link rel="prefetch" href="/blog/assets/js/5.d1dbc0b1.js"><link rel="prefetch" href="/blog/assets/js/50.c900e52a.js"><link rel="prefetch" href="/blog/assets/js/51.a59d8fbf.js"><link rel="prefetch" href="/blog/assets/js/52.0c715d23.js"><link rel="prefetch" href="/blog/assets/js/53.07715a2f.js"><link rel="prefetch" href="/blog/assets/js/54.e0d8cc69.js"><link rel="prefetch" href="/blog/assets/js/55.1efa3b0b.js"><link rel="prefetch" href="/blog/assets/js/56.ace3e6e3.js"><link rel="prefetch" href="/blog/assets/js/57.221667c1.js"><link rel="prefetch" href="/blog/assets/js/58.a786e5bd.js"><link rel="prefetch" href="/blog/assets/js/59.8a6dde26.js"><link rel="prefetch" href="/blog/assets/js/6.7ee6eed6.js"><link rel="prefetch" href="/blog/assets/js/60.0192f277.js"><link rel="prefetch" href="/blog/assets/js/61.75813485.js"><link rel="prefetch" href="/blog/assets/js/62.d8de1a01.js"><link rel="prefetch" href="/blog/assets/js/63.a08485a4.js"><link rel="prefetch" href="/blog/assets/js/64.7d19f572.js"><link rel="prefetch" href="/blog/assets/js/65.3f290d9a.js"><link rel="prefetch" href="/blog/assets/js/66.73f49082.js"><link rel="prefetch" href="/blog/assets/js/67.cb22e678.js"><link rel="prefetch" href="/blog/assets/js/68.22dc7228.js"><link rel="prefetch" href="/blog/assets/js/69.1f450482.js"><link rel="prefetch" href="/blog/assets/js/7.153b9c62.js"><link rel="prefetch" href="/blog/assets/js/70.03205c0b.js"><link rel="prefetch" href="/blog/assets/js/71.5b98edf5.js"><link rel="prefetch" href="/blog/assets/js/72.8be00756.js"><link rel="prefetch" href="/blog/assets/js/73.5e60394c.js"><link rel="prefetch" href="/blog/assets/js/74.a1100b64.js"><link rel="prefetch" href="/blog/assets/js/75.b47153bc.js"><link rel="prefetch" href="/blog/assets/js/76.b881f0b9.js"><link rel="prefetch" href="/blog/assets/js/77.eef60dd8.js"><link rel="prefetch" href="/blog/assets/js/78.b52fa32f.js"><link rel="prefetch" href="/blog/assets/js/79.9adc486f.js"><link rel="prefetch" href="/blog/assets/js/80.10b21516.js"><link rel="prefetch" href="/blog/assets/js/81.12c11cbc.js"><link rel="prefetch" href="/blog/assets/js/82.df4ae15b.js"><link rel="prefetch" href="/blog/assets/js/83.078b9ed6.js"><link rel="prefetch" href="/blog/assets/js/84.2d8ccb46.js"><link rel="prefetch" href="/blog/assets/js/85.4d5e44f4.js"><link rel="prefetch" href="/blog/assets/js/86.c32dda95.js"><link rel="prefetch" href="/blog/assets/js/87.c28d1f54.js"><link rel="prefetch" href="/blog/assets/js/88.c06457bb.js"><link rel="prefetch" href="/blog/assets/js/89.1febc082.js"><link rel="prefetch" href="/blog/assets/js/90.37985dbe.js"><link rel="prefetch" href="/blog/assets/js/91.9c3ebd93.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.02634ae8.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.56f5eb6c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="lun's blogs" class="logo"> <span class="site-name can-hide">lun's blogs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/base/Exception.html" class="nav-link">
  异常
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Generics.html" class="nav-link">
  泛型
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Enum.html" class="nav-link">
  枚举
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Serialize.html" class="nav-link">
  Java序列化机制详解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Proxy.html" class="nav-link">
  动态代理
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Annotation.html" class="nav-link">
  深入理解Java注解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream1.html" class="nav-link">
  Stream源码分析(上)
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream2.html" class="nav-link">
  Stream源码分析(下)
</a></li></ul></div></div><div class="nav-item"><a href="/blog/java多线程/" class="nav-link">
  Java多线程
</a></div><div class="nav-item"><a href="/blog/jvm/" class="nav-link">
  JVM
</a></div><div class="nav-item"><a href="/blog/redis/" class="nav-link">
  Redis
</a></div><div class="nav-item"><a href="/blog/blogs/" class="nav-link">
  随笔
</a></div><div class="nav-item"><a href="https://juejin.cn/user/2159878519134157" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/base/Exception.html" class="nav-link">
  异常
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Generics.html" class="nav-link">
  泛型
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Enum.html" class="nav-link">
  枚举
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Serialize.html" class="nav-link">
  Java序列化机制详解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Proxy.html" class="nav-link">
  动态代理
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Annotation.html" class="nav-link">
  深入理解Java注解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream1.html" class="nav-link">
  Stream源码分析(上)
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream2.html" class="nav-link">
  Stream源码分析(下)
</a></li></ul></div></div><div class="nav-item"><a href="/blog/java多线程/" class="nav-link">
  Java多线程
</a></div><div class="nav-item"><a href="/blog/jvm/" class="nav-link">
  JVM
</a></div><div class="nav-item"><a href="/blog/redis/" class="nav-link">
  Redis
</a></div><div class="nav-item"><a href="/blog/blogs/" class="nav-link">
  随笔
</a></div><div class="nav-item"><a href="https://juejin.cn/user/2159878519134157" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/java%E5%A4%9A%E7%BA%BF%E7%A8%8B/" aria-current="page" class="sidebar-link">一、前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>二、Java并发基础知识</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/java多线程/base/Base.html" class="active sidebar-link">多线程基础知识</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java多线程/base/Base.html#进程与线程的基本概念" class="sidebar-link">进程与线程的基本概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java多线程/base/Base.html#多进程-vs-多线程" class="sidebar-link">多进程 vs 多线程</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/base/Base.html#进程和线程的区别" class="sidebar-link">进程和线程的区别</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/base/Base.html#上下文切换" class="sidebar-link">上下文切换</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/base/Base.html#区分并发与并行" class="sidebar-link">区分并发与并行</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java多线程/base/Base.html#为什么需要并发编程" class="sidebar-link">为什么需要并发编程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java多线程/base/Base.html#如何实现多线程" class="sidebar-link">如何实现多线程</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/base/Base.html#通信与同步的概念" class="sidebar-link">通信与同步的概念</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/base/Base.html#并发编程基本工作模型" class="sidebar-link">并发编程基本工作模型</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java多线程/base/Base.html#并发编程需要解决的问题" class="sidebar-link">并发编程需要解决的问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java多线程/base/Base.html#并发三要素" class="sidebar-link">并发三要素</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/base/Base.html#_1、可见性问题" class="sidebar-link" style="padding-left:3rem;">1、可见性问题</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/base/Base.html#_2、原子性问题" class="sidebar-link" style="padding-left:3rem;">2、原子性问题</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/base/Base.html#_3、有序性问题" class="sidebar-link" style="padding-left:3rem;">3、有序性问题</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java多线程/base/Base.html#并发编程基础小结" class="sidebar-link">并发编程基础小结</a></li></ul></li><li><a href="/blog/java多线程/base/JMM.html" class="sidebar-link">Java并发基石——JMM</a></li><li><a href="/blog/java多线程/base/Thread.html" class="sidebar-link">认识 Java 世界的线程</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>三、锁与同步器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>四、JUC</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>五、线程池</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>六、补充</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="多线程基础知识"><a href="#多线程基础知识" class="header-anchor">#</a> 多线程基础知识</h1> <blockquote><p>本文首先会介绍一些多线程基础知识，然后分析实现并发编程，需要客克服哪些困难？为理解JMM做铺垫。</p></blockquote> <h2 id="进程与线程的基本概念"><a href="#进程与线程的基本概念" class="header-anchor">#</a> 进程与线程的基本概念</h2> <p>进程就是<strong>应用程序在内存中分配的空间，也就是正在运行的程序</strong>，各个进程之间互不干扰。同时进程保存着程序每一个时刻运行的状态。一个进程的组成实体可以分为两大部分：<strong>线程集和资源集</strong>。线程代表了进程指令的执行。</p> <p>线程是在进程中执行的一个子任务。</p> <p><strong>进程是操作系统进行资源分配的基本单位，而线程是操作系统进行调度的基本单位</strong>，即CPU分配时间的单位</p> <h3 id="多进程-vs-多线程"><a href="#多进程-vs-多线程" class="header-anchor">#</a> 多进程 vs 多线程</h3> <p>为什么要用多线程不用多进程？</p> <ul><li>进程间的通信比较复杂，而线程间的通信比较简单，线程共享资源，这些资源在线程间的通信比较容易。</li> <li>进程是重量级的，而线程是轻量级的，故多线程方式的系统开销更小。</li></ul> <h3 id="进程和线程的区别"><a href="#进程和线程的区别" class="header-anchor">#</a> 进程和线程的区别</h3> <p>进程是一个独立的运行环境，而线程是在进程中执行的一个任务。他们两个本质的区别是<strong>是否单独占有内存地址空间及其它系统资源（比如I/O）</strong>。进程的创建和销毁不仅需要保存寄存器和栈信息，还需要资源的分配回收以及页调度，开销较大；线程只需要保存寄存器和栈信息，开销较小。</p> <ul><li><strong>进程是操作系统进行资源分配的基本单位，而线程是操作系统进行调度的基本单位</strong>。</li> <li>进程包含了多个线程，包含关系，线程依赖进程</li> <li>线程共享进程的地址空间和资源，共享内存，通信更简单</li> <li>进程的上下文切换消耗更大，不仅仅是2栈+PC，寄存器，还包括虚拟内存、全局变量等用户态资源；额外多了<strong>内核堆栈</strong>、<strong>寄存器</strong>等内核空间的状态</li></ul> <h3 id="上下文切换"><a href="#上下文切换" class="header-anchor">#</a> 上下文切换</h3> <p>上下文切换是指 CPU 从一个进程（或线程）切换到另一个进程（或线程）。</p> <p>上下文是指<strong>某一时间点 CPU 寄存器和程序计数器的内容。</strong></p> <h3 id="区分并发与并行"><a href="#区分并发与并行" class="header-anchor">#</a> 区分并发与并行</h3> <p><strong>并发</strong>：是宏观的，也就是实际上是串行执行的。<strong>一个CPU核心，执行多个线程</strong></p> <p><strong>并行</strong>：是CPU不同核心同时执行。<strong>多个CPU核心，分别执行多个线程</strong></p> <h2 id="为什么需要并发编程"><a href="#为什么需要并发编程" class="header-anchor">#</a> 为什么需要并发编程</h2> <p>比如你去看一个视频，计算机需要做：接受并读取数据包，解压数据包，播放数据包。如果没有多线程，即只有一个进程，先读，读完了解压，解压完了再播放，那等到你真正看到视频要等好久。</p> <p>由于这三件事需要彼此通信同步，因此多线程的方式比起多进程更简单。</p> <h3 id="如何实现多线程"><a href="#如何实现多线程" class="header-anchor">#</a> 如何实现多线程</h3> <p>读者不妨考虑一下如何实现多线程？有哪些核心问题呢？</p> <p>就拿前文看视频的例子，如果播放的速度快于解压的速度，那么负责播放的线程如何感知到此时能播放的数据已经播放完了？解压得到了新的数据，又该如何通知播放线程可以播放了呢？</p> <h3 id="通信与同步的概念"><a href="#通信与同步的概念" class="header-anchor">#</a> 通信与同步的概念</h3> <p>用更抽象的语言来表达就是：</p> <ul><li>线程之间如何<strong>通信</strong>，更确切的说，如何将线程A的数据交付给线程B，<strong>线程之间以何种机制来交换信息</strong></li> <li>线程之间如何<strong>同步</strong>，即线程A如何让线程B停下来，等线程A的工作完成到一定程度再把线程B叫醒继续工作</li></ul> <p>这就是<strong>通信与同步的概念</strong>。</p> <p>通信与同步的概念非常重要，请务必搞明白二者的区别。</p> <h3 id="并发编程基本工作模型"><a href="#并发编程基本工作模型" class="header-anchor">#</a> 并发编程基本工作模型</h3> <p>那么实现并发编程的核心问题就是：如何实现<strong>通信与同步</strong>？</p> <p>一般有两种并发编程的基本工作模型：</p> <ul><li>消息传递并发模型：  线程A给线程B发送数据消息，从而通信，收到数据的线程B可以根据数据来决定是否阻塞（停下来）或是继续工作。即：<strong>显式通信，隐式同步</strong></li> <li>共享内存并发模型：  线程A修改共享内存中的某个数据，B可以通过某种方式，比如轮询，感知到这个数据的变化，从而改变自己的行为。即：<strong>隐式通信，显式同步 （这也是JAVA所采用的模型）</strong></li></ul> <h2 id="并发编程需要解决的问题"><a href="#并发编程需要解决的问题" class="header-anchor">#</a> 并发编程需要解决的问题</h2> <p>虽然上述分析已经让我们明确了实现并发编程最关键的问题所在，也确定了两种模型来实现线程间的通信与同步功能，但我们还必须考虑到下层的硬件，操作系统向上的影响。硬件和操作系统的实现各不相同，我们需要一个模型来<strong>屏蔽下层对上层的影响，或者说提供一些手段让程序员一定程度上能够影响到下层硬件的工作</strong>。而一般来说，下层对上层的影响就是如下三个问题，它们也被叫做「并发三要素」：</p> <h3 id="并发三要素"><a href="#并发三要素" class="header-anchor">#</a> 并发三要素</h3> <h4 id="_1、可见性问题"><a href="#_1、可见性问题" class="header-anchor">#</a> 1、可见性问题</h4> <p>可见性问题一般是由CPU缓存等硬件引起，每个核心的L1，L2 cache都是私有的，每个线程分别运行在CPU的两个核心，对cache的写操作，硬件不能保证彼此的可见性，这就是并发模型需要考虑的第一个问题：可见性问题。</p> <h4 id="_2、原子性问题"><a href="#_2、原子性问题" class="header-anchor">#</a> 2、原子性问题</h4> <p>CPU如何调度线程？CPU会为每个线程分配一个时间片，执行完这个时间片，该线程还没执行完，会先去执行其他的线程。那这会导致什么问题呢？假设我们此时有两个线程A，B都执行同一行代码：i++，起初i为0，我们预期执行结果为i = 2，而这行代码实际需要三条 CPU 指令：</p> <ul><li>读取i的值到寄存器</li> <li>+1，此时结果存储在寄存器</li> <li>写回，可能写入的是CPU Cache，也可能是主存</li></ul> <p>假设线程A读取i后阻塞，轮到线程B执行，线程B正常执行完i++，并且顺利写回主存，此时主存的i为1，轮到线程A执行，但此时A<strong>不会重新去读取主存中的i的值</strong>，继续执行+1，并且顺利写回主存，此时主存的i的值仍为1，这就和我们所预想的i = 2 不太相同。这就是第二个问题：原子性问题。</p> <blockquote><p>可以看到，我们的假设已经保证了每条线程都从主存中读取数据，并且写完立刻写回主存，即我们的假设是<strong>已经解决了可见性问题</strong>的，但因为CPU调度导致的<strong>原子性问题</strong>没有解决，才导致了程序运行结果与预期不同</p></blockquote> <p>具有原子性的一个或多个操作叫做原子操作，<strong>原子操作是不能操作系统被中断的</strong>。</p> <h4 id="_3、有序性问题"><a href="#_3、有序性问题" class="header-anchor">#</a> 3、有序性问题</h4> <p>从 java 源代码到最终实际执行的指令序列，会分别经历下面三种重排序：</p> <p><img src="data:image/png;base64,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" alt=""></p> <p>重排序的概念：计算机在执行程序时，为了提高性能，编译器和处理器常常会对指令做重排序。</p> <p>举个例子：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> c <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>上面1 2行代码，它们的执行的先后顺序，对第三行代码而言，根本不重要，即1 2行即使交换执行顺序，也不会影响程序的运行结果，因此在这里就有一个可重排序的空间，如果重排序能带来性能的提高，那也许就会发生重排序</p> <p>那么在一个线程内，以及在多个线程并发执行的情况，硬件，编译器具体如何重排序都可能不一样，因此指令的执行顺序对程序员而言是个黑盒，我们不得而知。为了使程序的执行结果符合预期，我们必须对这些重排序做一些限制，从而使得多线程并发的场景下，程序的执行结果仍然与预期相符，这就是第三个问题：有序性问题。</p> <p><strong>可见性和有序性的区别</strong></p> <p>还是举个例子来帮助你理解：</p> <p>仍然是两个线程A和B，A执行代码：i++，起初i为0；B仅仅是读取 i 的值。按照预期，A先执行i++，并刷新到主存，B读取 i 应该是1。但实际上，尽管你先启动A线程，也可能被重排序，CPU先执行线程B，读到i为0，再执行线程A做i++。这个过程没有发生可见性问题，因为在B读取的时候，主存，以及A的本地内存 i 都是0，但是运行结果与预期不相符。</p> <h2 id="并发编程基础小结"><a href="#并发编程基础小结" class="header-anchor">#</a> 并发编程基础小结</h2> <p>学到这里，我们知道线程的优势所在，以及实现并发编程的基本理论，知道通信与同步的概念以及并发必须解决的三大问题：可见性，原子性，有序性。这些内容与后续的内容息息相关，请务必掌握。</p> <p>那么到此为止，我们已经将实现并发编程的基本要素说清楚了，下篇文章我们就正式来看一看Java是如何实现并发编程的。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/java%E5%A4%9A%E7%BA%BF%E7%A8%8B/" class="prev router-link-active">
        一、前言
      </a></span> <span class="next"><a href="/blog/java多线程/base/JMM.html">
        Java并发基石——JMM
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.7b9df32b.js" defer></script><script src="/blog/assets/js/2.be714ec7.js" defer></script><script src="/blog/assets/js/1.26c7c9cc.js" defer></script><script src="/blog/assets/js/37.fc856e5d.js" defer></script>
  </body>
</html>
