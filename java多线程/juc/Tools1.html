<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>常见工具类：AQS 的应用 | lun&#39;s blogs</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="description" content="blog">
    
    <link rel="preload" href="/blog/assets/css/0.styles.56f5eb6c.css" as="style"><link rel="preload" href="/blog/assets/js/app.7b9df32b.js" as="script"><link rel="preload" href="/blog/assets/js/2.be714ec7.js" as="script"><link rel="preload" href="/blog/assets/js/1.26c7c9cc.js" as="script"><link rel="preload" href="/blog/assets/js/61.75813485.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.0d71bf2e.js"><link rel="prefetch" href="/blog/assets/js/11.cc81c248.js"><link rel="prefetch" href="/blog/assets/js/12.5e69cd14.js"><link rel="prefetch" href="/blog/assets/js/13.f0bc7bf2.js"><link rel="prefetch" href="/blog/assets/js/14.0188e855.js"><link rel="prefetch" href="/blog/assets/js/15.48a1e71e.js"><link rel="prefetch" href="/blog/assets/js/16.0f4182c9.js"><link rel="prefetch" href="/blog/assets/js/17.ec7b8f9d.js"><link rel="prefetch" href="/blog/assets/js/18.776522e2.js"><link rel="prefetch" href="/blog/assets/js/19.26561e06.js"><link rel="prefetch" href="/blog/assets/js/20.3e42feda.js"><link rel="prefetch" href="/blog/assets/js/21.fd4e7a00.js"><link rel="prefetch" href="/blog/assets/js/22.b59f6079.js"><link rel="prefetch" href="/blog/assets/js/23.e6b2d3ec.js"><link rel="prefetch" href="/blog/assets/js/24.736cfa99.js"><link rel="prefetch" href="/blog/assets/js/25.91176041.js"><link rel="prefetch" href="/blog/assets/js/26.146e299c.js"><link rel="prefetch" href="/blog/assets/js/27.56a57551.js"><link rel="prefetch" href="/blog/assets/js/28.13a846a1.js"><link rel="prefetch" href="/blog/assets/js/29.f71b59d6.js"><link rel="prefetch" href="/blog/assets/js/3.f34ea2f7.js"><link rel="prefetch" href="/blog/assets/js/30.bf0626f9.js"><link rel="prefetch" href="/blog/assets/js/31.47592684.js"><link rel="prefetch" href="/blog/assets/js/32.63f20fc3.js"><link rel="prefetch" href="/blog/assets/js/33.4852d9ec.js"><link rel="prefetch" href="/blog/assets/js/34.4f467138.js"><link rel="prefetch" href="/blog/assets/js/35.17d26444.js"><link rel="prefetch" href="/blog/assets/js/36.d0059312.js"><link rel="prefetch" href="/blog/assets/js/37.fc856e5d.js"><link rel="prefetch" href="/blog/assets/js/38.dc6b373c.js"><link rel="prefetch" href="/blog/assets/js/39.f04e5b6a.js"><link rel="prefetch" href="/blog/assets/js/4.885368ff.js"><link rel="prefetch" href="/blog/assets/js/40.b378efa5.js"><link rel="prefetch" href="/blog/assets/js/41.3c800d8a.js"><link rel="prefetch" href="/blog/assets/js/42.8b804f0c.js"><link rel="prefetch" href="/blog/assets/js/43.832aa078.js"><link rel="prefetch" href="/blog/assets/js/44.d1121c11.js"><link rel="prefetch" href="/blog/assets/js/45.b3e8ede1.js"><link rel="prefetch" href="/blog/assets/js/46.01e4202b.js"><link rel="prefetch" href="/blog/assets/js/47.489850e9.js"><link rel="prefetch" href="/blog/assets/js/48.3bd88d5f.js"><link rel="prefetch" href="/blog/assets/js/49.08c6f759.js"><link rel="prefetch" href="/blog/assets/js/5.d1dbc0b1.js"><link rel="prefetch" href="/blog/assets/js/50.c900e52a.js"><link rel="prefetch" href="/blog/assets/js/51.a59d8fbf.js"><link rel="prefetch" href="/blog/assets/js/52.0c715d23.js"><link rel="prefetch" href="/blog/assets/js/53.07715a2f.js"><link rel="prefetch" href="/blog/assets/js/54.e0d8cc69.js"><link rel="prefetch" href="/blog/assets/js/55.1efa3b0b.js"><link rel="prefetch" href="/blog/assets/js/56.ace3e6e3.js"><link rel="prefetch" href="/blog/assets/js/57.221667c1.js"><link rel="prefetch" href="/blog/assets/js/58.a786e5bd.js"><link rel="prefetch" href="/blog/assets/js/59.8a6dde26.js"><link rel="prefetch" href="/blog/assets/js/6.7ee6eed6.js"><link rel="prefetch" href="/blog/assets/js/60.0192f277.js"><link rel="prefetch" href="/blog/assets/js/62.d8de1a01.js"><link rel="prefetch" href="/blog/assets/js/63.a08485a4.js"><link rel="prefetch" href="/blog/assets/js/64.7d19f572.js"><link rel="prefetch" href="/blog/assets/js/65.3f290d9a.js"><link rel="prefetch" href="/blog/assets/js/66.73f49082.js"><link rel="prefetch" href="/blog/assets/js/67.cb22e678.js"><link rel="prefetch" href="/blog/assets/js/68.22dc7228.js"><link rel="prefetch" href="/blog/assets/js/69.1f450482.js"><link rel="prefetch" href="/blog/assets/js/7.153b9c62.js"><link rel="prefetch" href="/blog/assets/js/70.03205c0b.js"><link rel="prefetch" href="/blog/assets/js/71.5b98edf5.js"><link rel="prefetch" href="/blog/assets/js/72.8be00756.js"><link rel="prefetch" href="/blog/assets/js/73.5e60394c.js"><link rel="prefetch" href="/blog/assets/js/74.a1100b64.js"><link rel="prefetch" href="/blog/assets/js/75.b47153bc.js"><link rel="prefetch" href="/blog/assets/js/76.b881f0b9.js"><link rel="prefetch" href="/blog/assets/js/77.eef60dd8.js"><link rel="prefetch" href="/blog/assets/js/78.b52fa32f.js"><link rel="prefetch" href="/blog/assets/js/79.9adc486f.js"><link rel="prefetch" href="/blog/assets/js/80.10b21516.js"><link rel="prefetch" href="/blog/assets/js/81.12c11cbc.js"><link rel="prefetch" href="/blog/assets/js/82.df4ae15b.js"><link rel="prefetch" href="/blog/assets/js/83.078b9ed6.js"><link rel="prefetch" href="/blog/assets/js/84.2d8ccb46.js"><link rel="prefetch" href="/blog/assets/js/85.4d5e44f4.js"><link rel="prefetch" href="/blog/assets/js/86.c32dda95.js"><link rel="prefetch" href="/blog/assets/js/87.c28d1f54.js"><link rel="prefetch" href="/blog/assets/js/88.c06457bb.js"><link rel="prefetch" href="/blog/assets/js/89.1febc082.js"><link rel="prefetch" href="/blog/assets/js/90.37985dbe.js"><link rel="prefetch" href="/blog/assets/js/91.9c3ebd93.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.02634ae8.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.56f5eb6c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="lun's blogs" class="logo"> <span class="site-name can-hide">lun's blogs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/base/Exception.html" class="nav-link">
  异常
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Generics.html" class="nav-link">
  泛型
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Enum.html" class="nav-link">
  枚举
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Serialize.html" class="nav-link">
  Java序列化机制详解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Proxy.html" class="nav-link">
  动态代理
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Annotation.html" class="nav-link">
  深入理解Java注解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream1.html" class="nav-link">
  Stream源码分析(上)
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream2.html" class="nav-link">
  Stream源码分析(下)
</a></li></ul></div></div><div class="nav-item"><a href="/blog/java多线程/" class="nav-link">
  Java多线程
</a></div><div class="nav-item"><a href="/blog/jvm/" class="nav-link">
  JVM
</a></div><div class="nav-item"><a href="/blog/redis/" class="nav-link">
  Redis
</a></div><div class="nav-item"><a href="/blog/blogs/" class="nav-link">
  随笔
</a></div><div class="nav-item"><a href="https://juejin.cn/user/2159878519134157" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/base/Exception.html" class="nav-link">
  异常
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Generics.html" class="nav-link">
  泛型
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Enum.html" class="nav-link">
  枚举
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Serialize.html" class="nav-link">
  Java序列化机制详解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Proxy.html" class="nav-link">
  动态代理
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Annotation.html" class="nav-link">
  深入理解Java注解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream1.html" class="nav-link">
  Stream源码分析(上)
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream2.html" class="nav-link">
  Stream源码分析(下)
</a></li></ul></div></div><div class="nav-item"><a href="/blog/java多线程/" class="nav-link">
  Java多线程
</a></div><div class="nav-item"><a href="/blog/jvm/" class="nav-link">
  JVM
</a></div><div class="nav-item"><a href="/blog/redis/" class="nav-link">
  Redis
</a></div><div class="nav-item"><a href="/blog/blogs/" class="nav-link">
  随笔
</a></div><div class="nav-item"><a href="https://juejin.cn/user/2159878519134157" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/java%E5%A4%9A%E7%BA%BF%E7%A8%8B/" aria-current="page" class="sidebar-link">一、前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>二、Java并发基础知识</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>三、锁与同步器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>四、JUC</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/java多线程/juc/Locks.html" class="sidebar-link">透过 ReentrantLock 讲 AQS 的原理</a></li><li><a href="/blog/java多线程/juc/Tools1.html" class="active sidebar-link">常见工具类：AQS 的应用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#countdownlatch-等待唤醒" class="sidebar-link">CountDownLatch：等待唤醒</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#快速使用" class="sidebar-link">快速使用</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#state-还需等待几个线程" class="sidebar-link" style="padding-left:3rem;">state：还需等待几个线程</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#构造方法-指定state初始值" class="sidebar-link" style="padding-left:3rem;">构造方法：指定state初始值</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#await-阻塞等待执行" class="sidebar-link" style="padding-left:3rem;">await：阻塞等待执行</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#countdown-state" class="sidebar-link" style="padding-left:3rem;">countDown：state--</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#实现原理" class="sidebar-link">实现原理</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#semaphore-控制线程数量" class="sidebar-link">Semaphore：控制线程数量</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#快速使用-2" class="sidebar-link">快速使用</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#permits-state-最大线程数量" class="sidebar-link" style="padding-left:3rem;">permits/state：最大线程数量</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#构造方法-指定state-公平" class="sidebar-link" style="padding-left:3rem;">构造方法：指定state/公平</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#acquire-获取许可证" class="sidebar-link" style="padding-left:3rem;">acquire：获取许可证</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#release-释放许可证" class="sidebar-link" style="padding-left:3rem;">release：释放许可证</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#实现原理-2" class="sidebar-link">实现原理</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#cyclicbarrier-可循环屏障" class="sidebar-link">CyclicBarrier：可循环屏障</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#快速使用-3" class="sidebar-link">快速使用</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#await-到达屏障" class="sidebar-link" style="padding-left:3rem;">await：到达屏障</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#实现原理-3" class="sidebar-link">实现原理</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#核心字段" class="sidebar-link" style="padding-left:3rem;">核心字段</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#核心方法-await" class="sidebar-link" style="padding-left:3rem;">核心方法：await</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#barriercommand-屏障释放事件" class="sidebar-link" style="padding-left:3rem;">barrierCommand：屏障释放事件</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#屏障失效的场景" class="sidebar-link">屏障失效的场景</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#_1、线程中断" class="sidebar-link" style="padding-left:3rem;">1、线程中断</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#_2、等待超时" class="sidebar-link" style="padding-left:3rem;">2、等待超时</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#修复屏障" class="sidebar-link">修复屏障</a></li><li class="sidebar-sub-header"><a href="/blog/java多线程/juc/Tools1.html#小结" class="sidebar-link" style="padding-left:3rem;">小结</a></li></ul></li></ul></li><li><a href="/blog/java多线程/juc/Tools2.html" class="sidebar-link">CAS与锁的常见应用</a></li><li><a href="/blog/java多线程/juc/ConcurrentHashMap.html" class="sidebar-link">ConcurrentHashMap 源码剖析</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>五、线程池</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>六、补充</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="常见工具类-aqs-的应用"><a href="#常见工具类-aqs-的应用" class="header-anchor">#</a> 常见工具类：AQS 的应用</h1> <h2 id="countdownlatch-等待唤醒"><a href="#countdownlatch-等待唤醒" class="header-anchor">#</a> CountDownLatch：等待唤醒</h2> <p>CountDownLatch，中文翻译过来就是倒计时锁。</p> <p><strong>CountDownLatch 用于某个线程在执行任务之前，需要等待其它线程完成一些前置任务，必须等所有的前置任务都完成，才能开始执行本线程的任务。</strong></p> <h3 id="快速使用"><a href="#快速使用" class="header-anchor">#</a> 快速使用</h3> <p>CountDownLatch使用非常简单，只有两个API ：wait 和 countdown。</p> <p>但在此之前我们必须了解一个核心参数：state</p> <h4 id="state-还需等待几个线程"><a href="#state-还需等待几个线程" class="header-anchor">#</a> state：还需等待几个线程</h4> <ul><li>对于调用countDown方法的线程，不关心state具体的值</li> <li>对于调用await方法的线程，state代表还需要等待多少个线程调用countDown方法，才能被唤醒</li></ul> <h4 id="构造方法-指定state初始值"><a href="#构造方法-指定state初始值" class="header-anchor">#</a> 构造方法：指定state初始值</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;count &lt; 0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sync</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="await-阻塞等待执行"><a href="#await-阻塞等待执行" class="header-anchor">#</a> await：阻塞等待执行</h4> <p>await对应获取资源，因为自定义了tryAcquireShared方法，只有state为0才能获取资源</p> <h4 id="countdown-state"><a href="#countdown-state" class="header-anchor">#</a> countDown：state--</h4> <p>countDown对应释放资源，自旋CAS让<code>state = state - 1</code>。</p> <p>当state被减为0，所有调用await阻塞的线程会按顺序一个个醒来，继续执行它们的任务</p> <h3 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h3> <p>因为完全是依托AQS而实现的，所以只关注重写的两个模板方法，当然对 AQS 不熟悉请结合 AQS 源码一起看。</p> <blockquote><p>CountDownLatch是个共享锁，所以只需要重写两个方法</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// State为0 获取锁成功</span>
<span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// CAS自旋 让state--</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryReleaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> releases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Decrement count; signal when transition to zero</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> nextc <span class="token operator">=</span> c<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> nextc<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> nextc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="semaphore-控制线程数量"><a href="#semaphore-控制线程数量" class="header-anchor">#</a> Semaphore：控制线程数量</h2> <p><strong>作用：控制「访问资源/执行某段程序」的线程数量</strong>。</p> <h3 id="快速使用-2"><a href="#快速使用-2" class="header-anchor">#</a> 快速使用</h3> <p>主要是acquire获取许可证，release释放许可证</p> <h4 id="permits-state-最大线程数量"><a href="#permits-state-最大线程数量" class="header-anchor">#</a> permits/state：最大线程数量</h4> <p>即所控制的最大线程数量</p> <h4 id="构造方法-指定state-公平"><a href="#构造方法-指定state-公平" class="header-anchor">#</a> 构造方法：指定state/公平</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">permits</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token keyword">permits</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">permits</span><span class="token punctuation">,</span> <span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token keyword">permits</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token keyword">permits</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="acquire-获取许可证"><a href="#acquire-获取许可证" class="header-anchor">#</a> acquire：获取许可证</h4> <p>无参acquire，获取一个，可以指定获取的许可证个数</p> <h4 id="release-释放许可证"><a href="#release-释放许可证" class="header-anchor">#</a> release：释放许可证</h4> <p>类似acquire</p> <h3 id="实现原理-2"><a href="#实现原理-2" class="header-anchor">#</a> 实现原理</h3> <p>和CountDownLatch类似，我们只看非公平的两个模板方法吧</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// CAS自旋 让state-acquires </span>
<span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">nonfairTryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> available <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> remaining <span class="token operator">=</span> available <span class="token operator">-</span> acquires<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>remaining <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
            <span class="token function">compareAndSetState</span><span class="token punctuation">(</span>available<span class="token punctuation">,</span> remaining<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> remaining<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// CAS自旋 让state+releases</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryReleaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> releases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> current <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> next <span class="token operator">=</span> current <span class="token operator">+</span> releases<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">&lt;</span> current<span class="token punctuation">)</span> <span class="token comment">// overflow</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Maximum permit count exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="cyclicbarrier-可循环屏障"><a href="#cyclicbarrier-可循环屏障" class="header-anchor">#</a> CyclicBarrier：可循环屏障</h2> <p><strong>作用：让一组线程到达一个屏障（也可以叫同步点）时被阻塞，直到最后一个线程到达屏障时，屏障才会开门，所有被屏障拦截的线程才会继续干活。</strong> CyclicBarrier可以用于多线程计算数据，最后合并计算结果等应用场景。</p> <blockquote><p>为了便于讲解，我们定义当指定线程数量到达屏障时，线程唤醒继续执行的这个事件叫做：「屏障释放」</p></blockquote> <p>说他是循环的原因是：当触发「屏障释放」时，会让屏障恢复到最初的状态，即便出现异常也可以通过手动调用reset方法重复使用，而CountDownLatch就没有这个功能。</p> <h3 id="快速使用-3"><a href="#快速使用-3" class="header-anchor">#</a> 快速使用</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CyclicBarrier</span> barrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;触发barrierCommand&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程到达屏障&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// -------------省略异常处理</span>
        barrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ------------</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程离开屏障&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>输出：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>线程到达屏障
触发barrierCommand
线程离开屏障
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>可以看到，上述例子只调用了一个await方法，这也是CyclicBarrier最核心的方法</p> <h4 id="await-到达屏障"><a href="#await-到达屏障" class="header-anchor">#</a> await：到达屏障</h4> <p>await方法代表：当前线程已经到达该CyclicBarrier，阻塞，等待触发「屏障释放」事件后继续执行</p> <blockquote><p>为了避免误会还是说一下：如果调用await方法的线程刚好是最后一个到达CyclicBarrier的线程，即触发「屏障释放」事件，是不会阻塞的，该线程会负责执行barrierCommand方法，唤醒其余在屏障阻塞的线程，为CyclicBarrier的下次工作做好准备，然后继续该线程的工作。</p></blockquote> <h3 id="实现原理-3"><a href="#实现原理-3" class="header-anchor">#</a> 实现原理</h3> <p>CyclicBarrier会特殊一些，不像之前继承AQS就完事，它基于ReentrantLock，Condition实现</p> <h4 id="核心字段"><a href="#核心字段" class="header-anchor">#</a> 核心字段</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 到达屏障，await需要获得锁</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 阻塞/唤醒的工具</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> trip <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 触发「屏障释放」的线程数量阈值</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> parties<span class="token punctuation">;</span>
<span class="token comment">// 触发「屏障释放」时，先执行barrierCommand方法</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Runnable</span> barrierCommand<span class="token punctuation">;</span>
<span class="token comment">// Generation是个静态内部类 代表一个布尔值 boolean broken = false;即表示「屏障是否破损」</span>
<span class="token keyword">private</span> <span class="token class-name">Generation</span> generation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Generation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 还需要等待来到屏障的线程数量</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="核心方法-await"><a href="#核心方法-await" class="header-anchor">#</a> 核心方法：await</h4> <p>可以说使用CyclicBarrier主要都是在调用await方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">dowait</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> timed<span class="token punctuation">,</span> <span class="token keyword">long</span> nanos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 仍需等待的线程数-- </span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token operator">--</span>count<span class="token punctuation">;</span>
        <span class="token comment">// 如果 所有线程都已经到达屏障</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token comment">// 1.首先执行barrierCommand方法</span>
            <span class="token comment">// 2.唤醒所有阻塞线程(按顺序依次唤醒)</span>
            <span class="token comment">// 3.重置屏障用于下次使用，具体是：</span>
                    <span class="token comment">// 3.1 count = parties;</span>
                    <span class="token comment">// 3.2 generation = new Generation();</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 否则 根据预期的时间阻塞，或是一直阻塞下去</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="barriercommand-屏障释放事件"><a href="#barriercommand-屏障释放事件" class="header-anchor">#</a> barrierCommand：屏障释放事件</h4> <p>barrierCommand是个Runnable，但它并没有通过Thread.start方法调用，也就是说barrierCommand只是个封装的线程体，并没有作为线程单独执行，源码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">final</span> <span class="token class-name">Runnable</span> command <span class="token operator">=</span> barrierCommand<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        command<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        trip<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// set up next generation</span>
        count <span class="token operator">=</span> parties<span class="token punctuation">;</span>
        generation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Generation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>因此，是<strong>barrierCommand执行完毕，才去执行唤醒操作，这是有先后顺序的</strong>。</p> <h3 id="屏障失效的场景"><a href="#屏障失效的场景" class="header-anchor">#</a> 屏障失效的场景</h3> <h4 id="_1、线程中断"><a href="#_1、线程中断" class="header-anchor">#</a> 1、线程中断</h4> <p>一旦调用await方法的线程被interrupt，就会触发breakBarrier方法</p> <h4 id="_2、等待超时"><a href="#_2、等待超时" class="header-anchor">#</a> 2、等待超时</h4> <p>CyclicBarrier允许指定等待超时时间<code>await(long timeout, TimeUnit unit)</code>，一旦超出时间仍未触发 「屏障释放」，就会触发breakBarrier方法</p> <p>而breakBarrier方法，会将所有阻塞的线程依次唤醒，并设置broken标识为true，源码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">breakBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    generation<span class="token punctuation">.</span>broken <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    count <span class="token operator">=</span> parties<span class="token punctuation">;</span>
    trip<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这些被唤醒的线程，以及正在对一个损坏的屏障调用await方法的线程，会抛出「BrokenBarrierException」</p> <p>而触发超时的线程会抛出「TimeoutException」，注意区分</p> <h3 id="修复屏障"><a href="#修复屏障" class="header-anchor">#</a> 修复屏障</h3> <p>CyclicBarrier提供了修复屏障的方法，下面两个API可以搭配使用</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// 由于篇幅问题 省略加解锁逻辑 下面这两个方法都要先获取锁</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isBroken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> generation<span class="token punctuation">.</span>broken<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">breakBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 不理解这里breakBarrier有什么用，欢迎在评论区告知我</span>
            <span class="token function">nextGeneration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// start a new generation</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>会依次唤醒所有之前await的线程，重置count与generation，为下一次工作做好准备。</p> <h4 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h4> <p>可以看到，通过AQS我们可以快速的自定义共享/独占锁，通过这些例子不仅仅认识了好用的工具类，也是更进一步理解AQS的应用。</p> <p>并且即便是 CyclicBarrier 的源码，也并不复杂，并且功能强大，应用广泛，非常推荐想读源码但又担心源码过于复杂的同学迈出阅读源码的第一步。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/java多线程/juc/Locks.html" class="prev">
        透过 ReentrantLock 讲 AQS 的原理
      </a></span> <span class="next"><a href="/blog/java多线程/juc/Tools2.html">
        CAS与锁的常见应用
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.7b9df32b.js" defer></script><script src="/blog/assets/js/2.be714ec7.js" defer></script><script src="/blog/assets/js/1.26c7c9cc.js" defer></script><script src="/blog/assets/js/61.75813485.js" defer></script>
  </body>
</html>
