<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>认识 Java 字节码文件 | lun&#39;s blogs</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="description" content="blog">
    
    <link rel="preload" href="/blog/assets/css/0.styles.56f5eb6c.css" as="style"><link rel="preload" href="/blog/assets/js/app.7b9df32b.js" as="script"><link rel="preload" href="/blog/assets/js/2.be714ec7.js" as="script"><link rel="preload" href="/blog/assets/js/1.26c7c9cc.js" as="script"><link rel="preload" href="/blog/assets/js/20.3e42feda.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.0d71bf2e.js"><link rel="prefetch" href="/blog/assets/js/11.cc81c248.js"><link rel="prefetch" href="/blog/assets/js/12.5e69cd14.js"><link rel="prefetch" href="/blog/assets/js/13.f0bc7bf2.js"><link rel="prefetch" href="/blog/assets/js/14.0188e855.js"><link rel="prefetch" href="/blog/assets/js/15.48a1e71e.js"><link rel="prefetch" href="/blog/assets/js/16.0f4182c9.js"><link rel="prefetch" href="/blog/assets/js/17.ec7b8f9d.js"><link rel="prefetch" href="/blog/assets/js/18.776522e2.js"><link rel="prefetch" href="/blog/assets/js/19.26561e06.js"><link rel="prefetch" href="/blog/assets/js/21.fd4e7a00.js"><link rel="prefetch" href="/blog/assets/js/22.b59f6079.js"><link rel="prefetch" href="/blog/assets/js/23.e6b2d3ec.js"><link rel="prefetch" href="/blog/assets/js/24.736cfa99.js"><link rel="prefetch" href="/blog/assets/js/25.91176041.js"><link rel="prefetch" href="/blog/assets/js/26.146e299c.js"><link rel="prefetch" href="/blog/assets/js/27.56a57551.js"><link rel="prefetch" href="/blog/assets/js/28.13a846a1.js"><link rel="prefetch" href="/blog/assets/js/29.f71b59d6.js"><link rel="prefetch" href="/blog/assets/js/3.f34ea2f7.js"><link rel="prefetch" href="/blog/assets/js/30.bf0626f9.js"><link rel="prefetch" href="/blog/assets/js/31.47592684.js"><link rel="prefetch" href="/blog/assets/js/32.63f20fc3.js"><link rel="prefetch" href="/blog/assets/js/33.4852d9ec.js"><link rel="prefetch" href="/blog/assets/js/34.4f467138.js"><link rel="prefetch" href="/blog/assets/js/35.17d26444.js"><link rel="prefetch" href="/blog/assets/js/36.d0059312.js"><link rel="prefetch" href="/blog/assets/js/37.fc856e5d.js"><link rel="prefetch" href="/blog/assets/js/38.dc6b373c.js"><link rel="prefetch" href="/blog/assets/js/39.f04e5b6a.js"><link rel="prefetch" href="/blog/assets/js/4.885368ff.js"><link rel="prefetch" href="/blog/assets/js/40.b378efa5.js"><link rel="prefetch" href="/blog/assets/js/41.3c800d8a.js"><link rel="prefetch" href="/blog/assets/js/42.8b804f0c.js"><link rel="prefetch" href="/blog/assets/js/43.832aa078.js"><link rel="prefetch" href="/blog/assets/js/44.d1121c11.js"><link rel="prefetch" href="/blog/assets/js/45.b3e8ede1.js"><link rel="prefetch" href="/blog/assets/js/46.01e4202b.js"><link rel="prefetch" href="/blog/assets/js/47.489850e9.js"><link rel="prefetch" href="/blog/assets/js/48.3bd88d5f.js"><link rel="prefetch" href="/blog/assets/js/49.08c6f759.js"><link rel="prefetch" href="/blog/assets/js/5.d1dbc0b1.js"><link rel="prefetch" href="/blog/assets/js/50.c900e52a.js"><link rel="prefetch" href="/blog/assets/js/51.a59d8fbf.js"><link rel="prefetch" href="/blog/assets/js/52.0c715d23.js"><link rel="prefetch" href="/blog/assets/js/53.07715a2f.js"><link rel="prefetch" href="/blog/assets/js/54.e0d8cc69.js"><link rel="prefetch" href="/blog/assets/js/55.1efa3b0b.js"><link rel="prefetch" href="/blog/assets/js/56.ace3e6e3.js"><link rel="prefetch" href="/blog/assets/js/57.221667c1.js"><link rel="prefetch" href="/blog/assets/js/58.a786e5bd.js"><link rel="prefetch" href="/blog/assets/js/59.8a6dde26.js"><link rel="prefetch" href="/blog/assets/js/6.7ee6eed6.js"><link rel="prefetch" href="/blog/assets/js/60.0192f277.js"><link rel="prefetch" href="/blog/assets/js/61.75813485.js"><link rel="prefetch" href="/blog/assets/js/62.d8de1a01.js"><link rel="prefetch" href="/blog/assets/js/63.a08485a4.js"><link rel="prefetch" href="/blog/assets/js/64.7d19f572.js"><link rel="prefetch" href="/blog/assets/js/65.3f290d9a.js"><link rel="prefetch" href="/blog/assets/js/66.73f49082.js"><link rel="prefetch" href="/blog/assets/js/67.cb22e678.js"><link rel="prefetch" href="/blog/assets/js/68.22dc7228.js"><link rel="prefetch" href="/blog/assets/js/69.1f450482.js"><link rel="prefetch" href="/blog/assets/js/7.153b9c62.js"><link rel="prefetch" href="/blog/assets/js/70.03205c0b.js"><link rel="prefetch" href="/blog/assets/js/71.5b98edf5.js"><link rel="prefetch" href="/blog/assets/js/72.8be00756.js"><link rel="prefetch" href="/blog/assets/js/73.5e60394c.js"><link rel="prefetch" href="/blog/assets/js/74.a1100b64.js"><link rel="prefetch" href="/blog/assets/js/75.b47153bc.js"><link rel="prefetch" href="/blog/assets/js/76.b881f0b9.js"><link rel="prefetch" href="/blog/assets/js/77.eef60dd8.js"><link rel="prefetch" href="/blog/assets/js/78.b52fa32f.js"><link rel="prefetch" href="/blog/assets/js/79.9adc486f.js"><link rel="prefetch" href="/blog/assets/js/80.10b21516.js"><link rel="prefetch" href="/blog/assets/js/81.12c11cbc.js"><link rel="prefetch" href="/blog/assets/js/82.df4ae15b.js"><link rel="prefetch" href="/blog/assets/js/83.078b9ed6.js"><link rel="prefetch" href="/blog/assets/js/84.2d8ccb46.js"><link rel="prefetch" href="/blog/assets/js/85.4d5e44f4.js"><link rel="prefetch" href="/blog/assets/js/86.c32dda95.js"><link rel="prefetch" href="/blog/assets/js/87.c28d1f54.js"><link rel="prefetch" href="/blog/assets/js/88.c06457bb.js"><link rel="prefetch" href="/blog/assets/js/89.1febc082.js"><link rel="prefetch" href="/blog/assets/js/90.37985dbe.js"><link rel="prefetch" href="/blog/assets/js/91.9c3ebd93.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.02634ae8.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.56f5eb6c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="lun's blogs" class="logo"> <span class="site-name can-hide">lun's blogs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/base/Exception.html" class="nav-link">
  异常
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Generics.html" class="nav-link">
  泛型
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Enum.html" class="nav-link">
  枚举
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Serialize.html" class="nav-link">
  Java序列化机制详解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Proxy.html" class="nav-link">
  动态代理
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Annotation.html" class="nav-link">
  深入理解Java注解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream1.html" class="nav-link">
  Stream源码分析(上)
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream2.html" class="nav-link">
  Stream源码分析(下)
</a></li></ul></div></div><div class="nav-item"><a href="/blog/java多线程/" class="nav-link">
  Java多线程
</a></div><div class="nav-item"><a href="/blog/jvm/" class="nav-link router-link-active">
  JVM
</a></div><div class="nav-item"><a href="/blog/redis/" class="nav-link">
  Redis
</a></div><div class="nav-item"><a href="/blog/blogs/" class="nav-link">
  随笔
</a></div><div class="nav-item"><a href="https://juejin.cn/user/2159878519134157" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/base/Exception.html" class="nav-link">
  异常
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Generics.html" class="nav-link">
  泛型
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Enum.html" class="nav-link">
  枚举
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Serialize.html" class="nav-link">
  Java序列化机制详解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Proxy.html" class="nav-link">
  动态代理
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Annotation.html" class="nav-link">
  深入理解Java注解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream1.html" class="nav-link">
  Stream源码分析(上)
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream2.html" class="nav-link">
  Stream源码分析(下)
</a></li></ul></div></div><div class="nav-item"><a href="/blog/java多线程/" class="nav-link">
  Java多线程
</a></div><div class="nav-item"><a href="/blog/jvm/" class="nav-link router-link-active">
  JVM
</a></div><div class="nav-item"><a href="/blog/redis/" class="nav-link">
  Redis
</a></div><div class="nav-item"><a href="/blog/blogs/" class="nav-link">
  随笔
</a></div><div class="nav-item"><a href="https://juejin.cn/user/2159878519134157" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/jvm/" aria-current="page" class="sidebar-link">一、前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>二、认识Java类和对象</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/jvm/base/Class.html" aria-current="page" class="active sidebar-link">认识 Java 字节码文件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#class文件结构" class="sidebar-link">class文件结构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#_0、魔数-cafebabe" class="sidebar-link">0、魔数：CAFEBABE</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#_1、两个版本号" class="sidebar-link">1、两个版本号</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#_2、常量池-重要" class="sidebar-link">2、常量池（重要）</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#类的符号引用-constant-class-info" class="sidebar-link" style="padding-left:4rem;">类的符号引用：CONSTANT_Class_info</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#utf8字符串-constant-utf8-info" class="sidebar-link" style="padding-left:4rem;">Utf8字符串：CONSTANT_Utf8_info</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#_3、类访问标记" class="sidebar-link">3、类访问标记</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#_4、当前类-父类" class="sidebar-link">4、当前类，父类</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#_5、接口索引集合" class="sidebar-link">5、接口索引集合</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#_6、字段表集合" class="sidebar-link">6、字段表集合</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#_7、方法表集合" class="sidebar-link">7、方法表集合</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#_8、属性表集合" class="sidebar-link">8、属性表集合</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#constantvalue-常量值索引" class="sidebar-link" style="padding-left:3rem;">ConstantValue：常量值索引</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#code-方法体" class="sidebar-link" style="padding-left:3rem;">Code：方法体</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#code内部的异常表" class="sidebar-link" style="padding-left:3rem;">Code内部的异常表</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#exceptions-方法抛出的异常" class="sidebar-link" style="padding-left:3rem;">Exceptions：方法抛出的异常</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#innerclasses-内部类集合" class="sidebar-link" style="padding-left:3rem;">InnerClasses：内部类集合</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#signature-标签" class="sidebar-link" style="padding-left:3rem;">Signature：标签</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#annotations-运行时注解相关" class="sidebar-link" style="padding-left:3rem;">Annotations：运行时注解相关</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#字节码指令集" class="sidebar-link">字节码指令集</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#javap-查看字节码指令" class="sidebar-link">javap：查看字节码指令</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#javap基本使用" class="sidebar-link" style="padding-left:3rem;">javap基本使用</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#javap参数" class="sidebar-link" style="padding-left:4rem;">javap参数</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Class.html#参考文档" class="sidebar-link" style="padding-left:3rem;">参考文档</a></li></ul></li></ul></li><li><a href="/blog/jvm/base/Object.html" class="sidebar-link">认识 Java 对象</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>三、类加载子系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>四、垃圾回收子系统</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="认识-java-字节码文件"><a href="#认识-java-字节码文件" class="header-anchor">#</a> 认识 Java 字节码文件</h1> <p>什么是字节码？JVM可以理解的代码（即扩展名为 <code>.class</code> 的文件），源代码通过编译器<strong>编译为字节码</strong>，再通过类加载子系统加载到JVM中运行。比如 Kotlin也是基于JVM的编程语言。<strong>class文件就是字节码文件</strong>。</p> <p><img src="/blog/assets/img/image-20240111153029802.3021b91c.png" alt="image-20240111153029802"></p> <h3 id="为什么要学习字节码文件"><a href="#为什么要学习字节码文件" class="header-anchor">#</a> 为什么要学习字节码文件</h3> <p>学习字节码文件可以帮助你更好地理解类加载的整个过程，区分符号引用与直接引用，弄明白方法调用的过程，多态的实现原理。字节码文件也与注解，异常的实现原理息息相关。字节码文件是基础的基础。</p> <h3 id="class文件特点"><a href="#class文件特点" class="header-anchor">#</a> class文件特点</h3> <p>class文件/字节码文件本质上是一个<strong>以8个字节为基础单位的二进制流</strong>，各个数据项目严格按照顺序紧凑的排列在class文件中，中间没有添加任何分隔符。jvm根据其特定的规则解析该二进制数据，从而得到相关信息。</p> <blockquote><p>RednaxelaFX：</p> <p>用字节码来解释性能问题很抱歉也是比较不靠谱的。</p> <p>字节码用于解释 <strong>“语义问题”</strong> 很靠谱，但看字节码是<strong>看不出性能问题</strong>的——超过它的抽象层次了</p></blockquote> <h4 id="class文件的两种数据类型"><a href="#class文件的两种数据类型" class="header-anchor">#</a> class文件的两种数据类型</h4> <p>只有两种数据类型：“无符号数”和“表”</p> <ul><li>无符号数：以u1/u2/u4/u8代表1/2/4/8个字节数的无符号数，可以用来描述数字、索引引用、数量值、字符串值</li> <li>表：由无符号数和其它表构成，命名以“_info”结尾。</li></ul> <p>整个class文件也是一张表。</p> <h2 id="class文件结构"><a href="#class文件结构" class="header-anchor">#</a> class文件结构</h2> <p><img src="/blog/assets/img/image-20240111161145247.1ba5e52e.png" alt="image-20240111161145247"></p> <h3 id="_0、魔数-cafebabe"><a href="#_0、魔数-cafebabe" class="header-anchor">#</a> 0、魔数：CAFEBABE</h3> <p>文件开头的<strong>4个字节</strong>(&quot;cafe babe&quot;)称之为 <strong>魔数</strong>，唯有以<code>&quot;cafe babe&quot;</code>开头的class文件方可被虚拟机所接受，这4个字节就是<strong>字节码文件的身份识别</strong>。</p> <h3 id="_1、两个版本号"><a href="#_1、两个版本号" class="header-anchor">#</a> 1、两个版本号</h3> <p>minor：次要版本；major：主要版本</p> <p>它们各占两个字节</p> <h3 id="_2、常量池-重要"><a href="#_2、常量池-重要" class="header-anchor">#</a> 2、常量池（重要）</h3> <p>常量池占一个Class文件的很大一部分空间</p> <blockquote><p>常量池的入口有一个u2，代表个数（constant_pool_count）</p> <p>Class文件结构中只有常量池的容量计数是从1开始</p></blockquote> <p>常量池用于<strong>存储字面量和符号引用</strong>，字面量包括字符串<code>&quot;abd&quot;</code>，和用final修饰的字段。</p> <p>符号引用包括：</p> <ul><li>类和接口的<strong>全限定名</strong></li> <li>字段的<strong>简单名称和描述符</strong></li> <li>方法的<strong>简单名称和描述符</strong></li></ul> <blockquote><p>比如：一个方法在方法表，存储的是索引，指向常量池内的方法名称/描述符</p></blockquote> <p>以及可能不太眼熟的：</p> <ul><li>被模块导出或者开放的包</li> <li>动态调用点和动态常量</li> <li>方法句柄和方法类型</li></ul> <p>截至JDK13，常量表中分别有17种不同类型的常量。</p> <h5 id="类的符号引用-constant-class-info"><a href="#类的符号引用-constant-class-info" class="header-anchor">#</a> 类的符号引用：CONSTANT_Class_info</h5> <p>CONSTANT_Class_info还是一个索引，它的结构是：</p> <ul><li>一个tag，u1，标识当前常量类型为<code>CONSTANT_Class_info</code></li> <li>一个name_index，u2，指向常量池中一个<code>CONSTANT_Utf8_info</code>类型常量，此常量代表了这个类（或者接口）的全限定名</li></ul> <blockquote><p>笼统的符号引用是：本身可以是任何形式的字面量，它的实现取决于JVM，只要能定位到目标即可。</p> <p>所以，类的符号引用在HotSpot的实现就是全类名</p></blockquote> <h5 id="utf8字符串-constant-utf8-info"><a href="#utf8字符串-constant-utf8-info" class="header-anchor">#</a> Utf8字符串：CONSTANT_Utf8_info</h5> <p>这就是存储字符串字面值的。它的结构是：</p> <ul><li>一个tag，u1，所有常量池的类型都有一个tag用于标识自己的类型，后续不再赘述</li> <li>一个length，u2，代表当前字符串的长度</li> <li>bytes，u1的集合，个数取决于length</li></ul> <h3 id="_3、类访问标记"><a href="#_3、类访问标记" class="header-anchor">#</a> 3、类访问标记</h3> <p>包括访问修饰符，是否接口，是否抽象，是否枚举</p> <p><img src="/blog/assets/img/image-20240111161208107.42a299be.png" alt="image-20240111161208107"></p> <h3 id="_4、当前类-父类"><a href="#_4、当前类-父类" class="header-anchor">#</a> 4、当前类，父类</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code> u2             this_class<span class="token punctuation">;</span>  <span class="token comment">// 当前类</span>
 u2             super_class<span class="token punctuation">;</span> <span class="token comment">// 父类</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>它们都指向一个类型为CONSTANT_Class_info的类描述符常量，从而找到定义在CONSTANT_Utf8_info类型的常量中的全限定名字符串。</p> <p>可以理解为：this_class -&gt; CONSTANT_Class_info -&gt; CONSTANT_Utf8_info -&gt; 全类名</p> <p>有这个链条关系，就可以知道当前类和父类了，「5、接口索引集合」同理</p> <p>如果没看懂为什么就再去看一遍「2、常量池」吧</p> <h3 id="_5、接口索引集合"><a href="#_5、接口索引集合" class="header-anchor">#</a> 5、接口索引集合</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code>u2的集合         interfaces<span class="token punctuation">;</span>  <span class="token comment">// 接口索引集合 </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>接口索引集合存放着当前类实现的所有接口，如果当前是接口，则是所有继承的接口</p> <p>它的查找过程和类/父类一样。</p> <h3 id="_6、字段表集合"><a href="#_6、字段表集合" class="header-anchor">#</a> 6、字段表集合</h3> <p>字段包括了类变量（static修饰）和普通变量（非static修饰），类变量由access_flags的ACC_STATIC标识。</p> <p>字段表结构：</p> <p>1、access_flags：类似「3、类访问标记」，以及一些字段独有的比如：volatile，transient</p> <p>2、name_index和descriptor_index，<strong>是对常量池项的引用</strong>，分别代表着字段的<strong>简单名称</strong>以及<strong>字段的描述符</strong></p> <blockquote><p>再强调一下，这两个是索引，真正的符号引用/字面量在常量池，因此是u2是定长的</p></blockquote> <p><img src="/blog/assets/img/image-20240111161316335.500486a4.png" alt="image-20240111161316335"></p> <blockquote><p>字段的简单名称：纯的字段名。int m字段的简单名称就是“m”</p> <p>字段描述符：描述字段的数据类型</p> <p>如一个定义为“java.lang.String<a href="#"></a>”类型的二维数组将被记录成“[[Ljava/lang/String；” 一个整型数组“int[]”将被记录成“[I”。</p></blockquote> <p>3、attribute_info：额外信息，详见『8、属性表集合』</p> <blockquote><p>字段表集合中不会列出从父类或者父接口中继承而来的字段，但有可能出现原本Java代码之中不存在的字段，譬如在内部类中为了保持对外部类的访问性，编译器就会自动添加指向外部类实例的字段。另外，在Java语言中字段是无法重载的，两个字段的数据类型、修饰符不管是否相同，都必须使用不一样的名称，但是对于Class文件格式来讲，只要两个字段的描述符不是完全相同，那字段重名就是合法的</p></blockquote> <h3 id="_7、方法表集合"><a href="#_7、方法表集合" class="header-anchor">#</a> 7、方法表集合</h3> <p>method_info和field_info<strong>几乎完全一致</strong>。</p> <p>仅仅是<code>access_flag</code>略有不同。比如：</p> <ul><li>方法独有：是否synchronized，native；</li> <li>而字段独有：volatile，transient</li></ul> <p>name_index和descriptor_index的引用也分别代表了方法的<strong>简单名称</strong>以及<strong>方法的描述符</strong></p> <blockquote><p><strong>方法的简单名称</strong>：纯的方法名。inc()方法就是“inc”</p> <p><strong>方法描述符</strong>：包括 方法的参数列表（包括数量、类型以及顺序）和返回值</p> <p>方法int indexOf(char[]source，int sourceOffset，int sourceCount，char[]target，int targetOffset，int targetCount，int fromIndex)的描述符为 <strong>“([CII[CIII)I”</strong> 。</p></blockquote> <p>实际的方法代码存储在哪里？</p> <p>方法原本也是一段java代码，因此会被编译成字节码指令，存储在： <strong>方法属性表集合中一个名为“Code”的属性里面</strong>。</p> <p>详见『8、属性表集合』</p> <h3 id="_8、属性表集合"><a href="#_8、属性表集合" class="header-anchor">#</a> 8、属性表集合</h3> <p>属性表集合用于描述某些场景专有的信息</p> <p>像前文提到的字段，方法都依赖属性表集合</p> <ul><li>方法表依赖Code 存储实际方法的字节码指令</li> <li>字段表依赖ConstantValue 存储final定义的常量值</li></ul> <blockquote><p>声明<code>final static int m=123；</code>那就可能会存在一项名称为ConstantValue的属性，其值指向常量123。</p></blockquote> <p>属性表还包括：</p> <ul><li>Exceptions：方法可能抛出的所有异常</li> <li>Inner classes：内部类</li></ul> <p>还有非常多，一共接近30个，详见《深入理解Java虚拟机 第三版》P318，这里暂时只看两个：</p> <h4 id="constantvalue-常量值索引"><a href="#constantvalue-常量值索引" class="header-anchor">#</a> ConstantValue：常量值索引</h4> <p>static字段专属。</p> <p>static字段的初始化有两种方法：</p> <ul><li>类构造器&lt; clinit &gt;()方法中</li> <li>使用ConstantValue属性</li></ul> <p>目前：被static final修饰，且为基本数据类型或者java.lang.String的，用ConstantValue；其余用&lt; clinit &gt;()</p> <blockquote><p>ConstantValue是常量池索引，常量池只有基本数据类型和String，因此这看似是一种ConstantValue对User的束缚，实际ConstantValue自己是被常量池所束缚</p></blockquote> <h4 id="code-方法体"><a href="#code-方法体" class="header-anchor">#</a> Code：方法体</h4> <p>Code用于描述一个方法。</p> <div class="language- extra-class"><pre><code>// Java源程序编译后生成的字节码指令
u4 code length  // 字节码指令的长度
u1 code         // 字节码指令 有code length 个 code
    // 一个u1 8位，可以表达0~255 共256条指令，目前Java已经定义了两百多条指令。
    // 可见 《深入理解Java虚拟机 第三版》附录C“虚拟机字节码指令表
元数据
// 一个Code还包括很多其他元数据 包括栈最大深度 异常表等信息
</code></pre></div><p>虽然code length是u4，但《Java虚拟机规范》中明确限制了一个方法不允许超过65535条字节码指令。</p> <h4 id="code内部的异常表"><a href="#code内部的异常表" class="header-anchor">#</a> Code内部的异常表</h4> <p>异常表是Code的一部分。异常表不是必须的。是实现try catch finally代码块的核心。</p> <p>在Code中，异常表紧跟code：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    u2                  exception_table_length <span class="token comment">// 一个u2 异常表长度</span>
    exception_info      exception_table        <span class="token comment">// 异常表信息</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>对于一个exception_info是这样的：</p> <div class="language- extra-class"><pre><code>u2 start_pc     // 左闭右开的 start_pc ~ end_pc 
u2 end_pc        
u2 handler_pc   // 跳转行
u2 catch_type   // 出现了类型为catch_type或者其子类的异常
</code></pre></div><p>代表在一个「左闭右开」的 start_pc ~ end_pc 行之间，一旦出现了类型为catch_type或者其子类的异常，就转而到第handler_pc行继续处理。</p> <blockquote><p>对于finally来说 catch_type是any</p></blockquote> <p>javap反编译出来的异常表结果：</p> <div class="language- extra-class"><pre><code>Exception table:
from        to      target      type
0           5       10          Class java/lang/Exception
0           5       21           any
10          16      21           any
</code></pre></div><h4 id="exceptions-方法抛出的异常"><a href="#exceptions-方法抛出的异常" class="header-anchor">#</a> Exceptions：方法抛出的异常</h4> <p>更确切地说：Exceptions是列举出方法中可能抛出的受查异常（Checked Excepitons），也就是方法描述时在throws关键字后面列举的异常。</p> <p>Exceptions和异常表是不同的</p> <ul><li>Exceptions用于描述方法的throws关键字后面列举的异常</li> <li>异常表是try...代码块</li></ul> <p>因此，Exceptions与Code属性是平级的。</p> <p>结构和其他的差不多，就不再列举了</p> <h4 id="innerclasses-内部类集合"><a href="#innerclasses-内部类集合" class="header-anchor">#</a> InnerClasses：内部类集合</h4> <p>如果一个类有内部类，就会有这个属性。</p> <p>用若干个inner_classes_info表示。</p> <h4 id="signature-标签"><a href="#signature-标签" class="header-anchor">#</a> Signature：标签</h4> <p>任何类、接口、初始化方法或成员的泛型签名如果包含了类型变量（Type Variable）或参数化类型（ParameterizedType），则Signature属性会为它记录泛型签名信息。</p> <p>Java的反射API能够获取的泛型类型，最终的数据来源也是这个属性</p> <h4 id="annotations-运行时注解相关"><a href="#annotations-运行时注解相关" class="header-anchor">#</a> Annotations：运行时注解相关</h4> <p>RuntimeVisibleAnnotations：运行时可见注解</p> <p>使用反射API获取注解时，就来自属性表的注解属性</p> <blockquote><p>一个注解对应一个annotation属性</p> <p>一个annotation属性包含注解的全类名，以及它的所有属性，以键值对的形式存储，可以通过反射获取</p></blockquote> <h3 id="字节码指令集"><a href="#字节码指令集" class="header-anchor">#</a> 字节码指令集</h3> <p>Java虚拟机的指令由一个字节长度的Opcode操作码，加若干Operand操作数，Java虚拟机采用面向操作数栈，因此大多数指令都不包含操作数。</p> <p>基本工作模型：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        自动计算<span class="token constant">PC</span>寄存器的值加<span class="token number">1</span><span class="token punctuation">;</span>
        根据<span class="token constant">PC</span>寄存器指示的位置，从字节码流中取出操作码<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>字节码存在操作数<span class="token punctuation">)</span> 从字节码流中取出操作数<span class="token punctuation">;</span>
        执行操作码所定义的操作<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>字节码流长度 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>具体的字节码指令就不一一列举了，网上很方便能够查到</p> <h2 id="javap-查看字节码指令"><a href="#javap-查看字节码指令" class="header-anchor">#</a> javap：查看字节码指令</h2> <p>JDK内置了很多有用的小工具，javap是其中一个。javap可以帮助我们看到字节码指令</p> <p>字节码指令可以帮助我们更好地理解“语义”。在此简单介绍javap的使用：</p> <h4 id="javap基本使用"><a href="#javap基本使用" class="header-anchor">#</a> javap基本使用</h4> <p>首先在「idea整合javap」，然后只需要右键类，External Tools，javap即可。</p> <p>也可以在控制台直接拼下面的命令</p> <h5 id="javap参数"><a href="#javap参数" class="header-anchor">#</a> javap参数</h5> <ul><li>javap -l ：会输出行号和本地变量表信息；</li> <li>javap -c ：会对当前class字节码进行反编译生成汇编代码；</li> <li>javap -v： class字节码文件中除了包-c参数包含的内容外，还会输出行号、局部变量表信息、常量池等信息；</li></ul> <p>最全的：<strong>javap -verbose xxx.class</strong></p> <h4 id="参考文档"><a href="#参考文档" class="header-anchor">#</a> 参考文档</h4> <p>周志明 《深入理解Java虚拟机 第三版》</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/jvm/" class="prev router-link-active">
        一、前言
      </a></span> <span class="next"><a href="/blog/jvm/base/Object.html">
        认识 Java 对象
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.7b9df32b.js" defer></script><script src="/blog/assets/js/2.be714ec7.js" defer></script><script src="/blog/assets/js/1.26c7c9cc.js" defer></script><script src="/blog/assets/js/20.3e42feda.js" defer></script>
  </body>
</html>
