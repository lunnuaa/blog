<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>认识 Java 对象 | lun&#39;s blogs</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="description" content="blog">
    
    <link rel="preload" href="/blog/assets/css/0.styles.56f5eb6c.css" as="style"><link rel="preload" href="/blog/assets/js/app.7b9df32b.js" as="script"><link rel="preload" href="/blog/assets/js/2.be714ec7.js" as="script"><link rel="preload" href="/blog/assets/js/1.26c7c9cc.js" as="script"><link rel="preload" href="/blog/assets/js/43.832aa078.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.0d71bf2e.js"><link rel="prefetch" href="/blog/assets/js/11.cc81c248.js"><link rel="prefetch" href="/blog/assets/js/12.5e69cd14.js"><link rel="prefetch" href="/blog/assets/js/13.f0bc7bf2.js"><link rel="prefetch" href="/blog/assets/js/14.0188e855.js"><link rel="prefetch" href="/blog/assets/js/15.48a1e71e.js"><link rel="prefetch" href="/blog/assets/js/16.0f4182c9.js"><link rel="prefetch" href="/blog/assets/js/17.ec7b8f9d.js"><link rel="prefetch" href="/blog/assets/js/18.776522e2.js"><link rel="prefetch" href="/blog/assets/js/19.26561e06.js"><link rel="prefetch" href="/blog/assets/js/20.3e42feda.js"><link rel="prefetch" href="/blog/assets/js/21.fd4e7a00.js"><link rel="prefetch" href="/blog/assets/js/22.b59f6079.js"><link rel="prefetch" href="/blog/assets/js/23.e6b2d3ec.js"><link rel="prefetch" href="/blog/assets/js/24.736cfa99.js"><link rel="prefetch" href="/blog/assets/js/25.91176041.js"><link rel="prefetch" href="/blog/assets/js/26.146e299c.js"><link rel="prefetch" href="/blog/assets/js/27.56a57551.js"><link rel="prefetch" href="/blog/assets/js/28.13a846a1.js"><link rel="prefetch" href="/blog/assets/js/29.f71b59d6.js"><link rel="prefetch" href="/blog/assets/js/3.f34ea2f7.js"><link rel="prefetch" href="/blog/assets/js/30.bf0626f9.js"><link rel="prefetch" href="/blog/assets/js/31.47592684.js"><link rel="prefetch" href="/blog/assets/js/32.63f20fc3.js"><link rel="prefetch" href="/blog/assets/js/33.4852d9ec.js"><link rel="prefetch" href="/blog/assets/js/34.4f467138.js"><link rel="prefetch" href="/blog/assets/js/35.17d26444.js"><link rel="prefetch" href="/blog/assets/js/36.d0059312.js"><link rel="prefetch" href="/blog/assets/js/37.fc856e5d.js"><link rel="prefetch" href="/blog/assets/js/38.dc6b373c.js"><link rel="prefetch" href="/blog/assets/js/39.f04e5b6a.js"><link rel="prefetch" href="/blog/assets/js/4.885368ff.js"><link rel="prefetch" href="/blog/assets/js/40.b378efa5.js"><link rel="prefetch" href="/blog/assets/js/41.3c800d8a.js"><link rel="prefetch" href="/blog/assets/js/42.8b804f0c.js"><link rel="prefetch" href="/blog/assets/js/44.d1121c11.js"><link rel="prefetch" href="/blog/assets/js/45.b3e8ede1.js"><link rel="prefetch" href="/blog/assets/js/46.01e4202b.js"><link rel="prefetch" href="/blog/assets/js/47.489850e9.js"><link rel="prefetch" href="/blog/assets/js/48.3bd88d5f.js"><link rel="prefetch" href="/blog/assets/js/49.08c6f759.js"><link rel="prefetch" href="/blog/assets/js/5.d1dbc0b1.js"><link rel="prefetch" href="/blog/assets/js/50.c900e52a.js"><link rel="prefetch" href="/blog/assets/js/51.a59d8fbf.js"><link rel="prefetch" href="/blog/assets/js/52.0c715d23.js"><link rel="prefetch" href="/blog/assets/js/53.07715a2f.js"><link rel="prefetch" href="/blog/assets/js/54.e0d8cc69.js"><link rel="prefetch" href="/blog/assets/js/55.1efa3b0b.js"><link rel="prefetch" href="/blog/assets/js/56.ace3e6e3.js"><link rel="prefetch" href="/blog/assets/js/57.221667c1.js"><link rel="prefetch" href="/blog/assets/js/58.a786e5bd.js"><link rel="prefetch" href="/blog/assets/js/59.8a6dde26.js"><link rel="prefetch" href="/blog/assets/js/6.7ee6eed6.js"><link rel="prefetch" href="/blog/assets/js/60.0192f277.js"><link rel="prefetch" href="/blog/assets/js/61.75813485.js"><link rel="prefetch" href="/blog/assets/js/62.d8de1a01.js"><link rel="prefetch" href="/blog/assets/js/63.a08485a4.js"><link rel="prefetch" href="/blog/assets/js/64.7d19f572.js"><link rel="prefetch" href="/blog/assets/js/65.3f290d9a.js"><link rel="prefetch" href="/blog/assets/js/66.73f49082.js"><link rel="prefetch" href="/blog/assets/js/67.cb22e678.js"><link rel="prefetch" href="/blog/assets/js/68.22dc7228.js"><link rel="prefetch" href="/blog/assets/js/69.1f450482.js"><link rel="prefetch" href="/blog/assets/js/7.153b9c62.js"><link rel="prefetch" href="/blog/assets/js/70.03205c0b.js"><link rel="prefetch" href="/blog/assets/js/71.5b98edf5.js"><link rel="prefetch" href="/blog/assets/js/72.8be00756.js"><link rel="prefetch" href="/blog/assets/js/73.5e60394c.js"><link rel="prefetch" href="/blog/assets/js/74.a1100b64.js"><link rel="prefetch" href="/blog/assets/js/75.b47153bc.js"><link rel="prefetch" href="/blog/assets/js/76.b881f0b9.js"><link rel="prefetch" href="/blog/assets/js/77.eef60dd8.js"><link rel="prefetch" href="/blog/assets/js/78.b52fa32f.js"><link rel="prefetch" href="/blog/assets/js/79.9adc486f.js"><link rel="prefetch" href="/blog/assets/js/80.10b21516.js"><link rel="prefetch" href="/blog/assets/js/81.12c11cbc.js"><link rel="prefetch" href="/blog/assets/js/82.df4ae15b.js"><link rel="prefetch" href="/blog/assets/js/83.078b9ed6.js"><link rel="prefetch" href="/blog/assets/js/84.2d8ccb46.js"><link rel="prefetch" href="/blog/assets/js/85.4d5e44f4.js"><link rel="prefetch" href="/blog/assets/js/86.c32dda95.js"><link rel="prefetch" href="/blog/assets/js/87.c28d1f54.js"><link rel="prefetch" href="/blog/assets/js/88.c06457bb.js"><link rel="prefetch" href="/blog/assets/js/89.1febc082.js"><link rel="prefetch" href="/blog/assets/js/90.37985dbe.js"><link rel="prefetch" href="/blog/assets/js/91.9c3ebd93.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.02634ae8.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.56f5eb6c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="lun's blogs" class="logo"> <span class="site-name can-hide">lun's blogs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/base/Exception.html" class="nav-link">
  异常
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Generics.html" class="nav-link">
  泛型
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Enum.html" class="nav-link">
  枚举
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Serialize.html" class="nav-link">
  Java序列化机制详解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Proxy.html" class="nav-link">
  动态代理
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Annotation.html" class="nav-link">
  深入理解Java注解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream1.html" class="nav-link">
  Stream源码分析(上)
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream2.html" class="nav-link">
  Stream源码分析(下)
</a></li></ul></div></div><div class="nav-item"><a href="/blog/java多线程/" class="nav-link">
  Java多线程
</a></div><div class="nav-item"><a href="/blog/jvm/" class="nav-link router-link-active">
  JVM
</a></div><div class="nav-item"><a href="/blog/redis/" class="nav-link">
  Redis
</a></div><div class="nav-item"><a href="/blog/blogs/" class="nav-link">
  随笔
</a></div><div class="nav-item"><a href="https://juejin.cn/user/2159878519134157" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/base/Exception.html" class="nav-link">
  异常
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Generics.html" class="nav-link">
  泛型
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Enum.html" class="nav-link">
  枚举
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Serialize.html" class="nav-link">
  Java序列化机制详解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Proxy.html" class="nav-link">
  动态代理
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Annotation.html" class="nav-link">
  深入理解Java注解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream1.html" class="nav-link">
  Stream源码分析(上)
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream2.html" class="nav-link">
  Stream源码分析(下)
</a></li></ul></div></div><div class="nav-item"><a href="/blog/java多线程/" class="nav-link">
  Java多线程
</a></div><div class="nav-item"><a href="/blog/jvm/" class="nav-link router-link-active">
  JVM
</a></div><div class="nav-item"><a href="/blog/redis/" class="nav-link">
  Redis
</a></div><div class="nav-item"><a href="/blog/blogs/" class="nav-link">
  随笔
</a></div><div class="nav-item"><a href="https://juejin.cn/user/2159878519134157" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/jvm/" aria-current="page" class="sidebar-link">一、前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>二、认识Java类和对象</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/jvm/base/Class.html" class="sidebar-link">认识 Java 字节码文件</a></li><li><a href="/blog/jvm/base/Object.html" aria-current="page" class="active sidebar-link">认识 Java 对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#对象的组成" class="sidebar-link">对象的组成</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#_1、对象头" class="sidebar-link" style="padding-left:3rem;">1、对象头</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#markword" class="sidebar-link" style="padding-left:4rem;">markword</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#class指针" class="sidebar-link" style="padding-left:4rem;">Class指针</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#数组的length" class="sidebar-link" style="padding-left:4rem;">数组的length</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#_2、实例数据" class="sidebar-link" style="padding-left:3rem;">2、实例数据</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#_3、对齐填充" class="sidebar-link" style="padding-left:3rem;">3、对齐填充</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#new对象的过程" class="sidebar-link">new对象的过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#一、检查是否类加载" class="sidebar-link" style="padding-left:3rem;">一、检查是否类加载</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#二、为实例分配内存" class="sidebar-link" style="padding-left:3rem;">二、为实例分配内存</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#没有内存碎片-指针碰撞" class="sidebar-link" style="padding-left:4rem;">没有内存碎片：指针碰撞</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#有内存碎片-空闲列表" class="sidebar-link" style="padding-left:4rem;">有内存碎片：空闲列表</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#三、初始化实例变量" class="sidebar-link" style="padding-left:3rem;">三、初始化实例变量</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#四、设置对象头" class="sidebar-link" style="padding-left:3rem;">四、设置对象头</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#五、初始化" class="sidebar-link" style="padding-left:3rem;">五、初始化</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#开发视角-代码块-构造方法-声明调用顺序" class="sidebar-link">开发视角：代码块/构造方法/声明调用顺序</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#声明语句和代码块哪个先执行" class="sidebar-link" style="padding-left:3rem;">声明语句和代码块哪个先执行</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#对象如何被访问" class="sidebar-link">对象如何被访问</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#句柄" class="sidebar-link" style="padding-left:3rem;">句柄</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#直接指针" class="sidebar-link" style="padding-left:3rem;">直接指针</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#对比" class="sidebar-link" style="padding-left:3rem;">对比</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#引用类型" class="sidebar-link">引用类型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#_1、强引用-strongreference" class="sidebar-link" style="padding-left:3rem;">1、强引用（StrongReference）</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#_2、软引用-softreference" class="sidebar-link" style="padding-left:3rem;">2、软引用（SoftReference）</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#_3、弱引用-weakreference" class="sidebar-link" style="padding-left:3rem;">3、弱引用（WeakReference）</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#_4、虚引用-phantomreference" class="sidebar-link" style="padding-left:3rem;">4、虚引用（PhantomReference）</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#查看java对象的内存布局" class="sidebar-link">查看Java对象的内存布局</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#_1、jdk自带" class="sidebar-link">1、JDK自带</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#_2、jol工具" class="sidebar-link">2、jol工具</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#_3、instrumentation" class="sidebar-link">3、Instrumentation</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#浅析object类" class="sidebar-link">浅析Object类</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#object有哪些方法" class="sidebar-link">Object有哪些方法</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#为什么wait-notify在object内而不是thread" class="sidebar-link">为什么wait/notify在Object内而不是Thread</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#输出一个没有重写tostring方法的对象会发生什么" class="sidebar-link">输出一个没有重写toString方法的对象会发生什么</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#new-一个object多少字节" class="sidebar-link">new 一个Object多少字节</a></li><li class="sidebar-sub-header"><a href="/blog/jvm/base/Object.html#参考文档" class="sidebar-link" style="padding-left:3rem;">参考文档</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>三、类加载子系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>四、垃圾回收子系统</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="认识-java-对象"><a href="#认识-java-对象" class="header-anchor">#</a> 认识 Java 对象</h1> <p>先了解一下对象的组成</p> <h2 id="对象的组成"><a href="#对象的组成" class="header-anchor">#</a> 对象的组成</h2> <p><img src="/blog/assets/img/image-20240111161517219.f3b21c62.png" alt="image-20240111161517219">
可以看到，一个对象由：<strong>对象头，实例数据，对齐填充组成</strong>。</p> <h4 id="_1、对象头"><a href="#_1、对象头" class="header-anchor">#</a> 1、对象头</h4> <h5 id="markword"><a href="#markword" class="header-anchor">#</a> markword</h5> <table><thead><tr><th>锁状态</th> <th>29 bit 或 61 bit</th> <th>1 bit 是否是偏向锁？</th> <th>2 bit 锁标志位</th></tr></thead> <tbody><tr><td>无锁</td> <td>31bit的Hashcode</td> <td>0</td> <td>01</td></tr> <tr><td>偏向锁</td> <td>线程ID</td> <td>1</td> <td>01</td></tr> <tr><td>轻量级锁</td> <td>指向栈中锁记录的指针</td> <td>此时这一位不用于标识偏向锁</td> <td>00</td></tr> <tr><td>重量级锁</td> <td>指向互斥量（重量级锁）的指针</td> <td>此时这一位不用于标识偏向锁</td> <td>10</td></tr> <tr><td>GC标记</td> <td></td> <td>此时这一位不用于标识偏向锁</td> <td>11</td></tr></tbody></table> <h5 id="class指针"><a href="#class指针" class="header-anchor">#</a> Class指针</h5> <p>4字节的指针（指向类元信息地址，class），用于访问Class对象。</p> <p>默认开启指针压缩，所以是4字节，关闭的话为8字节。</p> <h5 id="数组的length"><a href="#数组的length" class="header-anchor">#</a> 数组的length</h5> <p>这个好理解，数组的<code>.length</code>就是拿到这个信息</p> <p>这里length四个字节，也解释了一个数组的最大长度，是max_int。</p> <h4 id="_2、实例数据"><a href="#_2、实例数据" class="header-anchor">#</a> 2、实例数据</h4> <p>就是类自己的类似<code>private String name = &quot;123&quot;</code>这样的信息。</p> <p>像父类的private的属性，也是有的，但访问不了。</p> <h4 id="_3、对齐填充"><a href="#_3、对齐填充" class="header-anchor">#</a> 3、对齐填充</h4> <p>对齐填充使得对象实例的字节数是<strong>8的倍数</strong>。</p> <blockquote><p>64位JVM的寻址空间更大，但是会带来性能的损耗；大多数计算机都是高效的64位处理器，顾名思义，一次能处理64位的指令，即8个字节的数据，HotSpot VM的自动内存管理系统也就遵循了这个要求，这样子性能更高，处理更快。</p></blockquote> <p>因此，new一个对象，实际就是要处理上述三大部分。一般有：</p> <ul><li>markword</li> <li>Class对象</li> <li>实例数据</li></ul> <h2 id="new对象的过程"><a href="#new对象的过程" class="header-anchor">#</a> new对象的过程</h2> <h4 id="一、检查是否类加载"><a href="#一、检查是否类加载" class="header-anchor">#</a> 一、检查是否类加载</h4> <p>检查常量池中是否能定位到这个类的「符号引用」。</p> <p>如果没有Class对象，会先执行类加载过程的1~5步骤。类加载的过程可以参考：<a href="https://juejin.cn/post/7276698909782327352" target="_blank" rel="noopener noreferrer">JVM架构之类加载系统，深入理解类加载器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="二、为实例分配内存"><a href="#二、为实例分配内存" class="header-anchor">#</a> 二、为实例分配内存</h4> <p>首先因为堆全局唯一，因此需要保证线程安全：</p> <p>方案是：<strong>CAS+TLAB</strong></p> <p><strong>TLAB</strong>：Thread Local Allocation Buffer。就是在Eden区直接划分一块给某个线程私有。后续的new对象都在这块私有区域分配。</p> <blockquote><p>划分区域也会线程不安全，也需要CAS或锁，但是一种<strong>锁粗化</strong>的原理，比单单分配一个对象效率要高得多。</p></blockquote> <p><strong>在TLAB不够时，采用CAS的方式分配内存。</strong></p> <blockquote><p>CAS：compare and swap，保证线程安全</p></blockquote> <p>然后开始具体地分配内存</p> <p>对象所需的内存大小在类加载完成后便可确定，具体如何分配有两种方式：</p> <h5 id="没有内存碎片-指针碰撞"><a href="#没有内存碎片-指针碰撞" class="header-anchor">#</a> <strong>没有内存碎片：指针碰撞</strong></h5> <p>用过的内存全部整合到一边，没有用过的内存放在另一边，中间有一个分界指针，只需要向着没用过的内存方向将该指针移动对象内存大小位置</p> <h5 id="有内存碎片-空闲列表"><a href="#有内存碎片-空闲列表" class="header-anchor">#</a> <strong>有内存碎片：空闲列表</strong></h5> <p>虚拟机会维护一个列表，该列表中会记录哪些内存块是可用的，在分配的时候，找一块儿足够大的内存块儿来划分给对象实例，最后更新列表记录。</p> <blockquote><p>有没有内存碎片取决于GC算法，清除有内存碎片，复制，整理没有内存碎片</p></blockquote> <h4 id="三、初始化实例变量"><a href="#三、初始化实例变量" class="header-anchor">#</a> 三、初始化实例变量</h4> <p>将方法区内对实例变量的定义拷贝一份到堆区，然后赋默认值（一般是0）。</p> <h4 id="四、设置对象头"><a href="#四、设置对象头" class="header-anchor">#</a> 四、设置对象头</h4> <p>即初始化mark word，class指针等信息</p> <blockquote><p>对象头是下图绿色的部分</p></blockquote> <p><img src="/blog/assets/img/image-20240111161517219.f3b21c62.png" alt="image-20240111161517219"></p> <h4 id="五、初始化"><a href="#五、初始化" class="header-anchor">#</a> 五、初始化</h4> <p>先初始化父类再初始化子类。</p> <p>初始化时先执行<strong>实例代码块</strong>然后是<strong>构造方法</strong>。</p> <p>这样一个真正可用的对象才算完全产生出来</p> <h3 id="开发视角-代码块-构造方法-声明调用顺序"><a href="#开发视角-代码块-构造方法-声明调用顺序" class="header-anchor">#</a> 开发视角：代码块/构造方法/声明调用顺序</h3> <p>我们现在已经学了Class对象的加载，实例对象的加载，这里来梳理一下，<strong>父子类的静态（非静态）代码块，构造方法，静态（非静态）字段的调用顺序</strong></p> <p>Class加载完全早于实例对象的加载，因此：</p> <ol><li>父类的：静态变量声明，静态代码块</li> <li>子类的：静态变量声明，静态代码块</li></ol> <p>这里的1~2是类加载的（5）初始化阶段</p> <ol><li>父类的：实例变量声明，普通语句块</li> <li>父类的：构造函数</li> <li>子类的：实例变量声明，普通语句块</li> <li>子类的：构造函数</li></ol> <p>这里的3~6是new对象实例的（5）初始化阶段</p> <blockquote><p>没有被声明，代码块，构造函数指定的变量就是默认值（一般为零值）</p> <ul><li>对于静态的字段由类加载步骤（3）准备阶段保证</li> <li>对于普通的字段由new对象步骤（3）初始化实例变量阶段保证</li></ul></blockquote> <h4 id="声明语句和代码块哪个先执行"><a href="#声明语句和代码块哪个先执行" class="header-anchor">#</a> 声明语句和代码块哪个先执行</h4> <p>为什么把声明和代码块放在同一行内？它们之间的顺序如何？</p> <p>实际上，这取决于<strong>代码的位置</strong>。</p> <p>我们知道在初始化之前，无论是静态字段，还是普通字段，都会为它们分配空间并赋予默认值，一般为零值。</p> <p>因此：</p> <div class="language- extra-class"><pre><code>public static int a = 1;
</code></pre></div><p>像这样的语句，「为a分配空间」 与 「声明a的值」 ，并不会被一起执行。</p> <p>完全可以这样写：</p> <div class="language- extra-class"><pre><code>static {  a = 2; }
public static int a = 1;
</code></pre></div><p>此时访问a为1</p> <p>交换这两行代码的位置：</p> <div class="language- extra-class"><pre><code>public static int a = 1;
static {  a = 2; }
</code></pre></div><p>此时访问a为2</p> <p>普通字段完全一样，多个代码块也是这样</p> <p>因此，<strong>变量声明与代码块的执行顺序取决于代码的位置顺序</strong></p> <h2 id="对象如何被访问"><a href="#对象如何被访问" class="header-anchor">#</a> 对象如何被访问</h2> <h4 id="句柄"><a href="#句柄" class="header-anchor">#</a> 句柄</h4> <p>在堆中划分一块区域作为句柄池，指针指向句柄，句柄指向堆内存空间</p> <h4 id="直接指针"><a href="#直接指针" class="header-anchor">#</a> 直接指针</h4> <p>直接指针就是指向堆内存空间的指针</p> <h4 id="对比"><a href="#对比" class="header-anchor">#</a> 对比</h4> <p>直接指针显然访问速度更快。句柄的好处是对象被移动时（比如GC），只改变句柄中实例数据指针，<code>reference</code>本身不用改变。</p> <p>HotSpot VM采用<strong>直接指针</strong></p> <h2 id="引用类型"><a href="#引用类型" class="header-anchor">#</a> 引用类型</h2> <p>直接指针提供的功能太少，因此JDK1.2之后Java提供了四个级别的引用，以下按引用强度排序：</p> <h4 id="_1、强引用-strongreference"><a href="#_1、强引用-strongreference" class="header-anchor">#</a> <strong>1、强引用（StrongReference）</strong></h4> <p>最普遍的引用，垃圾回收器绝不会回收它，宁愿抛出 OutOfMemoryError 错误，使程序异常终止。</p> <p>new出来的对象的引用都是强引用。像下面这行代码，obj就是个强引用，存储在栈帧的局部变量表中。</p> <div class="language- extra-class"><pre><code>Object obj = new Object();
</code></pre></div><p>执行 <code>obj=null;</code>后，这个obj原本指向的Object实例才可能被GC</p> <h4 id="_2、软引用-softreference"><a href="#_2、软引用-softreference" class="header-anchor">#</a> 2、软引用（SoftReference）</h4> <p>如果内存空间足够，垃圾回收器就不会回收它，如果内存空间不足了，就会回收这些对象的内存。<strong>可有可无</strong>。可用来实现内存敏感的高速缓存。</p> <h4 id="_3、弱引用-weakreference"><a href="#_3、弱引用-weakreference" class="header-anchor">#</a> 3、<strong>弱引用（WeakReference）</strong></h4> <p><strong>值得被回收</strong>。一旦发现了只具有弱引用的对象，不管当前内存空间足够与否，都会回收它的内存。</p> <blockquote><p>ThreadLocal的key是弱引用</p></blockquote> <h4 id="_4、虚引用-phantomreference"><a href="#_4、虚引用-phantomreference" class="header-anchor">#</a> 4、<strong>虚引用（PhantomReference）</strong></h4> <p><strong>虚引用：主要用来跟踪对象被垃圾回收的活动</strong>。虚引用不会决定GC机制对一个对象的回收权。如果一个对象仅持有虚引用，那么它就和没有任何引用一样，在任何时候都可能被垃圾回收。</p> <p>在程序设计中一般很少使用弱引用与虚引用，使用软引用的情况较多，这是因为<strong>软引用可以加速 JVM 对垃圾内存的回收速度，可以维护系统的运行安全，防止内存溢出（OutOfMemory）等问题的产生</strong>。</p> <h2 id="查看java对象的内存布局"><a href="#查看java对象的内存布局" class="header-anchor">#</a> 查看Java对象的内存布局</h2> <h3 id="_1、jdk自带"><a href="#_1、jdk自带" class="header-anchor">#</a> 1、JDK自带</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;java.vm.name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Java HotSpot(TM) &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ObjectSizeCalculator</span><span class="token punctuation">.</span><span class="token function">getObjectSize</span><span class="token punctuation">(</span><span class="token number">3L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_2、jol工具"><a href="#_2、jol工具" class="header-anchor">#</a> 2、jol工具</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>openjdk<span class="token punctuation">.</span>jol<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>jol<span class="token operator">-</span>core<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">0.16</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 基本使用</span>
<span class="token class-name">Object</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 实例信息</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// class类信息</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseClass</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_3、instrumentation"><a href="#_3、instrumentation" class="header-anchor">#</a> 3、Instrumentation</h3> <p>获取Instrumentation对象，先引入依赖项</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.bytebuddy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>byte-buddy-agent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.12.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.bytebuddy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>byte-buddy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.12.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>agent<span class="token punctuation">.</span></span><span class="token class-name">ByteBuddyAgent</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>instrument<span class="token punctuation">.</span></span><span class="token class-name">Instrumentation</span></span><span class="token punctuation">;</span>
	<span class="token class-name">ByteBuddyAgent</span><span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token class-name">Instrumentation</span> instrumentation <span class="token operator">=</span> <span class="token class-name">ByteBuddyAgent</span><span class="token punctuation">.</span><span class="token function">getInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    inst<span class="token punctuation">.</span><span class="token function">getObjectSize</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>最后来看看Object类，它是Java所有类的父类。</p> <h2 id="浅析object类"><a href="#浅析object类" class="header-anchor">#</a> 浅析Object类</h2> <h3 id="object有哪些方法"><a href="#object有哪些方法" class="header-anchor">#</a> Object有哪些方法</h3> <p>hashcode，equals，toString，wait，notify，clone</p> <h3 id="为什么wait-notify在object内而不是thread"><a href="#为什么wait-notify在object内而不是thread" class="header-anchor">#</a> 为什么wait/notify在Object内而不是Thread</h3> <p>因为等待/通知机制设计是为了解决线程间通信的。</p> <p>线程通信是否可执行，是由资源决定的，而非线程。</p> <p>一个线程使用完毕某个资源，别的线程才能使用。</p> <p>线程知道自己是因为要获取哪个资源而被阻塞，关注的是资源，而不在乎是因为谁（具体哪个线程）。</p> <h3 id="输出一个没有重写tostring方法的对象会发生什么"><a href="#输出一个没有重写tostring方法的对象会发生什么" class="header-anchor">#</a> 输出一个没有重写toString方法的对象会发生什么</h3> <p>输出Person类得到 Person@3c1</p> <p>输出数组得到 [I@4554617c</p> <p>输出new Object的对象得到 java.lang.Object@4554617c</p> <p>一个类没有重写toString方法，也会有这个方法</p> <p>因为Object类下已经做了实现</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>public String toString() {
    return getClass().getName() + &quot;@&quot; + Integer.toHexString(hashCode());
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>也就是会输出 <code>类名 + @ + hashcode的值</code>（hashcode16进制）</p> <h3 id="new-一个object多少字节"><a href="#new-一个object多少字节" class="header-anchor">#</a> new 一个Object多少字节</h3> <p>这跟硬件是有关系的。还有是否开启指针压缩等。所以没有确切的答案。但可以肯定的是：一定会是8的倍数。开启指针压缩的情况下，为16字节。8字节mark word，4字节指针，以及对齐填充。另外要区分堆与栈。在栈上也会生成一个4字节的指针。</p> <p>小结一下：new 一个Object，在本地栈生成一个4字节的指针，指向一块堆内存区域。这块堆内存区域存储了markword，实例数据，和一个指针指向方法区class对象（或者用句柄实现，但sunhotspot是指针实现），以及对齐填充</p> <h4 id="参考文档"><a href="#参考文档" class="header-anchor">#</a> 参考文档</h4> <p><a href="https://javaguide.cn" target="_blank" rel="noopener noreferrer">Java内存区域详解（重点）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/jvm/base/Class.html" class="prev">
        认识 Java 字节码文件
      </a></span> <span class="next"><a href="/blog/jvm/architecture/ClassLoader.html">
        深入理解类加载系统
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.7b9df32b.js" defer></script><script src="/blog/assets/js/2.be714ec7.js" defer></script><script src="/blog/assets/js/1.26c7c9cc.js" defer></script><script src="/blog/assets/js/43.832aa078.js" defer></script>
  </body>
</html>
