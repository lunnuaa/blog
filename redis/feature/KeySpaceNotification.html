<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>监控 key 变化：Keyspace Notifications | lun&#39;s blogs</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="description" content="blog">
    
    <link rel="preload" href="/blog/assets/css/0.styles.56f5eb6c.css" as="style"><link rel="preload" href="/blog/assets/js/app.7b9df32b.js" as="script"><link rel="preload" href="/blog/assets/js/2.be714ec7.js" as="script"><link rel="preload" href="/blog/assets/js/1.26c7c9cc.js" as="script"><link rel="preload" href="/blog/assets/js/17.ec7b8f9d.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.0d71bf2e.js"><link rel="prefetch" href="/blog/assets/js/11.cc81c248.js"><link rel="prefetch" href="/blog/assets/js/12.5e69cd14.js"><link rel="prefetch" href="/blog/assets/js/13.f0bc7bf2.js"><link rel="prefetch" href="/blog/assets/js/14.0188e855.js"><link rel="prefetch" href="/blog/assets/js/15.48a1e71e.js"><link rel="prefetch" href="/blog/assets/js/16.0f4182c9.js"><link rel="prefetch" href="/blog/assets/js/18.776522e2.js"><link rel="prefetch" href="/blog/assets/js/19.26561e06.js"><link rel="prefetch" href="/blog/assets/js/20.3e42feda.js"><link rel="prefetch" href="/blog/assets/js/21.fd4e7a00.js"><link rel="prefetch" href="/blog/assets/js/22.b59f6079.js"><link rel="prefetch" href="/blog/assets/js/23.e6b2d3ec.js"><link rel="prefetch" href="/blog/assets/js/24.736cfa99.js"><link rel="prefetch" href="/blog/assets/js/25.91176041.js"><link rel="prefetch" href="/blog/assets/js/26.146e299c.js"><link rel="prefetch" href="/blog/assets/js/27.56a57551.js"><link rel="prefetch" href="/blog/assets/js/28.13a846a1.js"><link rel="prefetch" href="/blog/assets/js/29.f71b59d6.js"><link rel="prefetch" href="/blog/assets/js/3.f34ea2f7.js"><link rel="prefetch" href="/blog/assets/js/30.bf0626f9.js"><link rel="prefetch" href="/blog/assets/js/31.47592684.js"><link rel="prefetch" href="/blog/assets/js/32.63f20fc3.js"><link rel="prefetch" href="/blog/assets/js/33.4852d9ec.js"><link rel="prefetch" href="/blog/assets/js/34.4f467138.js"><link rel="prefetch" href="/blog/assets/js/35.17d26444.js"><link rel="prefetch" href="/blog/assets/js/36.d0059312.js"><link rel="prefetch" href="/blog/assets/js/37.fc856e5d.js"><link rel="prefetch" href="/blog/assets/js/38.dc6b373c.js"><link rel="prefetch" href="/blog/assets/js/39.f04e5b6a.js"><link rel="prefetch" href="/blog/assets/js/4.885368ff.js"><link rel="prefetch" href="/blog/assets/js/40.b378efa5.js"><link rel="prefetch" href="/blog/assets/js/41.3c800d8a.js"><link rel="prefetch" href="/blog/assets/js/42.8b804f0c.js"><link rel="prefetch" href="/blog/assets/js/43.832aa078.js"><link rel="prefetch" href="/blog/assets/js/44.d1121c11.js"><link rel="prefetch" href="/blog/assets/js/45.b3e8ede1.js"><link rel="prefetch" href="/blog/assets/js/46.01e4202b.js"><link rel="prefetch" href="/blog/assets/js/47.489850e9.js"><link rel="prefetch" href="/blog/assets/js/48.3bd88d5f.js"><link rel="prefetch" href="/blog/assets/js/49.08c6f759.js"><link rel="prefetch" href="/blog/assets/js/5.d1dbc0b1.js"><link rel="prefetch" href="/blog/assets/js/50.c900e52a.js"><link rel="prefetch" href="/blog/assets/js/51.a59d8fbf.js"><link rel="prefetch" href="/blog/assets/js/52.0c715d23.js"><link rel="prefetch" href="/blog/assets/js/53.07715a2f.js"><link rel="prefetch" href="/blog/assets/js/54.e0d8cc69.js"><link rel="prefetch" href="/blog/assets/js/55.1efa3b0b.js"><link rel="prefetch" href="/blog/assets/js/56.ace3e6e3.js"><link rel="prefetch" href="/blog/assets/js/57.221667c1.js"><link rel="prefetch" href="/blog/assets/js/58.a786e5bd.js"><link rel="prefetch" href="/blog/assets/js/59.8a6dde26.js"><link rel="prefetch" href="/blog/assets/js/6.7ee6eed6.js"><link rel="prefetch" href="/blog/assets/js/60.0192f277.js"><link rel="prefetch" href="/blog/assets/js/61.75813485.js"><link rel="prefetch" href="/blog/assets/js/62.d8de1a01.js"><link rel="prefetch" href="/blog/assets/js/63.a08485a4.js"><link rel="prefetch" href="/blog/assets/js/64.7d19f572.js"><link rel="prefetch" href="/blog/assets/js/65.3f290d9a.js"><link rel="prefetch" href="/blog/assets/js/66.73f49082.js"><link rel="prefetch" href="/blog/assets/js/67.cb22e678.js"><link rel="prefetch" href="/blog/assets/js/68.22dc7228.js"><link rel="prefetch" href="/blog/assets/js/69.1f450482.js"><link rel="prefetch" href="/blog/assets/js/7.153b9c62.js"><link rel="prefetch" href="/blog/assets/js/70.03205c0b.js"><link rel="prefetch" href="/blog/assets/js/71.5b98edf5.js"><link rel="prefetch" href="/blog/assets/js/72.8be00756.js"><link rel="prefetch" href="/blog/assets/js/73.5e60394c.js"><link rel="prefetch" href="/blog/assets/js/74.a1100b64.js"><link rel="prefetch" href="/blog/assets/js/75.b47153bc.js"><link rel="prefetch" href="/blog/assets/js/76.b881f0b9.js"><link rel="prefetch" href="/blog/assets/js/77.eef60dd8.js"><link rel="prefetch" href="/blog/assets/js/78.b52fa32f.js"><link rel="prefetch" href="/blog/assets/js/79.9adc486f.js"><link rel="prefetch" href="/blog/assets/js/80.10b21516.js"><link rel="prefetch" href="/blog/assets/js/81.12c11cbc.js"><link rel="prefetch" href="/blog/assets/js/82.df4ae15b.js"><link rel="prefetch" href="/blog/assets/js/83.078b9ed6.js"><link rel="prefetch" href="/blog/assets/js/84.2d8ccb46.js"><link rel="prefetch" href="/blog/assets/js/85.4d5e44f4.js"><link rel="prefetch" href="/blog/assets/js/86.c32dda95.js"><link rel="prefetch" href="/blog/assets/js/87.c28d1f54.js"><link rel="prefetch" href="/blog/assets/js/88.c06457bb.js"><link rel="prefetch" href="/blog/assets/js/89.1febc082.js"><link rel="prefetch" href="/blog/assets/js/90.37985dbe.js"><link rel="prefetch" href="/blog/assets/js/91.9c3ebd93.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.02634ae8.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.56f5eb6c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="lun's blogs" class="logo"> <span class="site-name can-hide">lun's blogs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/base/Exception.html" class="nav-link">
  异常
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Generics.html" class="nav-link">
  泛型
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Enum.html" class="nav-link">
  枚举
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Serialize.html" class="nav-link">
  Java序列化机制详解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Proxy.html" class="nav-link">
  动态代理
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Annotation.html" class="nav-link">
  深入理解Java注解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream1.html" class="nav-link">
  Stream源码分析(上)
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream2.html" class="nav-link">
  Stream源码分析(下)
</a></li></ul></div></div><div class="nav-item"><a href="/blog/java多线程/" class="nav-link">
  Java多线程
</a></div><div class="nav-item"><a href="/blog/jvm/" class="nav-link">
  JVM
</a></div><div class="nav-item"><a href="/blog/redis/" class="nav-link router-link-active">
  Redis
</a></div><div class="nav-item"><a href="/blog/blogs/" class="nav-link">
  随笔
</a></div><div class="nav-item"><a href="https://juejin.cn/user/2159878519134157" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/base/Exception.html" class="nav-link">
  异常
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Generics.html" class="nav-link">
  泛型
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Enum.html" class="nav-link">
  枚举
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Serialize.html" class="nav-link">
  Java序列化机制详解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Proxy.html" class="nav-link">
  动态代理
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Annotation.html" class="nav-link">
  深入理解Java注解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream1.html" class="nav-link">
  Stream源码分析(上)
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream2.html" class="nav-link">
  Stream源码分析(下)
</a></li></ul></div></div><div class="nav-item"><a href="/blog/java多线程/" class="nav-link">
  Java多线程
</a></div><div class="nav-item"><a href="/blog/jvm/" class="nav-link">
  JVM
</a></div><div class="nav-item"><a href="/blog/redis/" class="nav-link router-link-active">
  Redis
</a></div><div class="nav-item"><a href="/blog/blogs/" class="nav-link">
  随笔
</a></div><div class="nav-item"><a href="https://juejin.cn/user/2159878519134157" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/redis/" aria-current="page" class="sidebar-link">一、前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>二、Redis数据类型</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>三、Redis功能特性</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/redis/feature/PubSub.html" class="sidebar-link">Redis 发布订阅：PubSub</a></li><li><a href="/blog/redis/feature/KeySpaceNotification.html" aria-current="page" class="active sidebar-link">监控 key 变化：Keyspace Notifications</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/redis/feature/KeySpaceNotification.html#keyspace-notifications-快速入门" class="sidebar-link">Keyspace Notifications 快速入门</a></li><li class="sidebar-sub-header"><a href="/blog/redis/feature/KeySpaceNotification.html#客户端订阅频道-两种通知事件" class="sidebar-link">客户端订阅频道：两种通知事件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/redis/feature/KeySpaceNotification.html#_1、key-space-notification-关注-key" class="sidebar-link">1、Key-space notification：关注 key</a></li><li class="sidebar-sub-header"><a href="/blog/redis/feature/KeySpaceNotification.html#_2、key-event-notification-关注事件" class="sidebar-link">2、Key-event notification：关注事件</a></li><li class="sidebar-sub-header"><a href="/blog/redis/feature/KeySpaceNotification.html#命令对应的事件" class="sidebar-link">命令对应的事件</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/redis/feature/KeySpaceNotification.html#keyspace-notifications-源码分析" class="sidebar-link">Keyspace Notifications 源码分析</a></li><li class="sidebar-sub-header"><a href="/blog/redis/feature/KeySpaceNotification.html#keyspace-notifications-的缺点" class="sidebar-link">Keyspace Notifications 的缺点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/redis/feature/KeySpaceNotification.html#_1、不可靠性" class="sidebar-link">1、不可靠性</a></li><li class="sidebar-sub-header"><a href="/blog/redis/feature/KeySpaceNotification.html#_2、集群模式的问题" class="sidebar-link">2、集群模式的问题</a></li><li class="sidebar-sub-header"><a href="/blog/redis/feature/KeySpaceNotification.html#_3、过期-key-事件的延迟" class="sidebar-link">3、过期 Key 事件的延迟</a></li></ul></li></ul></li><li><a href="/blog/redis/feature/Persistence.html" class="sidebar-link">Redis 持久化：RDB &amp; AOF</a></li><li><a href="/blog/redis/feature/Lua.html" class="sidebar-link">Redis 事务 vs Lua</a></li><li><a href="/blog/redis/feature/Rollback.html" class="sidebar-link">为什么 Redis 不支持事务回滚</a></li><li><a href="/blog/redis/feature/DistributedLock.html" class="sidebar-link">基于 Redis 实现分布式锁</a></li><li><a href="/blog/redis/feature/Problems.html" class="sidebar-link">Redis 常见问题</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>四、Redis高可用</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="监控-key-变化-keyspace-notifications"><a href="#监控-key-变化-keyspace-notifications" class="header-anchor">#</a> 监控 key 变化：Keyspace Notifications</h1> <p>Keyspace Notifications，可以用于监控 Redis 内的 Key 和 Value的变化，包括 Key 过期事件。</p> <p>基本原理是：Pub/Sub。客户端通过订阅 Pub/Sub 频道，来感知事件的发生。</p> <h3 id="开启键空间通知功能"><a href="#开启键空间通知功能" class="header-anchor">#</a> 开启键空间通知功能</h3> <p>Keyspace Notifications 功能默认是关闭的，需要手动开启</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># config set 或者 redis.conf 配置</span>
notify-keyspace-events <span class="token punctuation">[</span>参数<span class="token punctuation">]</span><span class="token punctuation">(</span>KEA<span class="token punctuation">)</span>
<span class="token comment"># 禁用该功能 参数设置为空即可</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="参数详细选项"><a href="#参数详细选项" class="header-anchor">#</a> 参数详细选项</h3> <blockquote><p>至少需要有 K  或者 E 中的一个</p></blockquote> <table><thead><tr><th style="text-align:center;">参数</th> <th style="text-align:center;">意义</th></tr></thead> <tbody><tr><td style="text-align:center;">K</td> <td style="text-align:center;">以 <code>__keyspace@&lt;db&gt;__</code> 为前缀的 Keyspace events</td></tr> <tr><td style="text-align:center;">E</td> <td style="text-align:center;">以 <code>__keyevent@&lt;db&gt;__</code> 为前缀的 Keyevent events</td></tr> <tr><td style="text-align:center;">m</td> <td style="text-align:center;">访问了不存在的 key</td></tr> <tr><td style="text-align:center;">n</td> <td style="text-align:center;">产生了新 key</td></tr> <tr><td style="text-align:center;">A</td> <td style="text-align:center;">A是<strong>特殊</strong>的，代表下面所有的参数的总和，是&quot;g$lshztxed&quot;的别名（除去mnKE的全部）</td></tr> <tr><td style="text-align:center;">x</td> <td style="text-align:center;">key 过期事件</td></tr> <tr><td style="text-align:center;">e</td> <td style="text-align:center;">Redis内存满了,被内存淘汰的事件</td></tr> <tr><td style="text-align:center;">g</td> <td style="text-align:center;">通用命令</td></tr> <tr><td style="text-align:center;">$</td> <td style="text-align:center;">String commands</td></tr> <tr><td style="text-align:center;">s</td> <td style="text-align:center;">Set commands</td></tr> <tr><td style="text-align:center;">h</td> <td style="text-align:center;">Hash commands</td></tr> <tr><td style="text-align:center;">z</td> <td style="text-align:center;">Sorted set commands</td></tr> <tr><td style="text-align:center;">t</td> <td style="text-align:center;">Stream commands</td></tr> <tr><td style="text-align:center;">d</td> <td style="text-align:center;">Module key type events</td></tr></tbody></table> <h2 id="keyspace-notifications-快速入门"><a href="#keyspace-notifications-快速入门" class="header-anchor">#</a> Keyspace Notifications 快速入门</h2> <p>首先开启该功能，然后客户端只需要监听对应的频道即可。</p> <p>频道分为两类：<code>__keyspace@&lt;db&gt;__:xxx</code> 和 <code>__keyevent@&lt;db&gt;__:xxx</code></p> <p>详细可以参考下面的例子：</p> <p>一个客户端执行：</p> <p><img src="/blog/assets/img/image-20231225231656041.0aae02e8.png" alt="image-20231225231656041"></p> <p>另一个客户端执行：</p> <p><img src="data:image/png;base64,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" alt="image-20231225231752867"></p> <p>第一个客户端收到消息如下：</p> <p><img src="/blog/assets/img/image-20231225231813285.23c04c3f.png" alt="image-20231225231813285"></p> <p>可以看到，setex 命令分为 set expire 两条命令，并且在10s以后产生了 expired 事件代表 key 过期</p> <p>对于每个事件的含义如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>1) 消息类型 pmessage 为模式匹配的消息
2) 匹配的模式
3) 事件名称
4) 命令 或者 key
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="客户端订阅频道-两种通知事件"><a href="#客户端订阅频道-两种通知事件" class="header-anchor">#</a> 客户端订阅频道：两种通知事件</h2> <p>大多数情况下，一条命令会生成两条通知事件，两种事件的类型不同。</p> <p>键空间通知事件分为两类，K 和 E，下面说一下区别</p> <h3 id="_1、key-space-notification-关注-key"><a href="#_1、key-space-notification-关注-key" class="header-anchor">#</a> 1、Key-space notification：关注 key</h3> <p>Key-space notification 更关注 key，你可以通过如下命令来关注指定的 key</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>psubscribe <span class="token string">'__keyspace@*__:[key name]'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>下面的例子中，只有 Key 为 test 的事件被监听。</p> <p><img src="/blog/assets/img/image-20231225233008020.afcc98f7.png" alt="image-20231225233008020"></p> <h3 id="_2、key-event-notification-关注事件"><a href="#_2、key-event-notification-关注事件" class="header-anchor">#</a> 2、Key-event notification：关注事件</h3> <p>Key-event notification 更关注事件或者某个具体的命令</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>psubscribe <span class="token string">'__keyevent@*__:[event]'</span>
<span class="token comment"># 关注过期事件发生</span>
psubscribe <span class="token string">'__keyevent@*__:expired'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>下面的例子中，两个key的过期事件均被监听到，没有set事件。</p> <p><img src="/blog/assets/img/image-20231225233417497.10486417.png" alt="image-20231225233417497"></p> <h3 id="命令对应的事件"><a href="#命令对应的事件" class="header-anchor">#</a> 命令对应的事件</h3> <p>举个例子，过期事件对应为&quot;expired&quot;，<code>RENAME</code> 命令对应有 <code>rename_from</code> 事件和  <code>rename_to</code> 事件</p> <p>非常多，在此不一一列举，详细见官网：<a href="https://redis.io/docs/manual/keyspace-notifications/#events-generated-by-different-commands" target="_blank" rel="noopener noreferrer">Events generated by different commands<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="keyspace-notifications-源码分析"><a href="#keyspace-notifications-源码分析" class="header-anchor">#</a> Keyspace Notifications 源码分析</h2> <p>我们还是以过期事件为例，下面是懒删除找不到 key 时的处理：</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code>robj <span class="token operator">*</span><span class="token function">lookupKey</span><span class="token punctuation">(</span>redisDb <span class="token operator">*</span>db<span class="token punctuation">,</span> robj <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dictEntry <span class="token operator">*</span>de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>db<span class="token operator">-&gt;</span>dict<span class="token punctuation">,</span>key<span class="token operator">-&gt;</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    robj <span class="token operator">*</span>val <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>de<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        val <span class="token operator">=</span> <span class="token function">dictGetVal</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// ...</span>
        <span class="token comment">// 发现过期了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">expireIfNeeded</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> key<span class="token punctuation">,</span> expire_flags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            val <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... </span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// notifyKeyspaceEvent 发出通知 对不存在的 key 进行了操作</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>LOOKUP_NONOTIFY <span class="token operator">|</span> LOOKUP_WRITE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">notifyKeyspaceEvent</span><span class="token punctuation">(</span>NOTIFY_KEY_MISS<span class="token punctuation">,</span> <span class="token string">&quot;keymiss&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> db<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><code>expireIfNeeded</code> 方法中，调用如下方法：</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">deleteExpiredKeyAndPropagate</span><span class="token punctuation">(</span>redisDb <span class="token operator">*</span>db<span class="token punctuation">,</span> robj <span class="token operator">*</span>keyobj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先删除 key</span>
    <span class="token class-name">mstime_t</span> expire_latency<span class="token punctuation">;</span>
    <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>expire_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>lazyfree_lazy_expire<span class="token punctuation">)</span>
        <span class="token function">dbAsyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">dbSyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>expire_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">&quot;expire-del&quot;</span><span class="token punctuation">,</span>expire_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// notifyKeyspaceEvent 发出通知 发生了 key 过期事件</span>
    <span class="token function">notifyKeyspaceEvent</span><span class="token punctuation">(</span>NOTIFY_EXPIRED<span class="token punctuation">,</span><span class="token string">&quot;expired&quot;</span><span class="token punctuation">,</span>keyobj<span class="token punctuation">,</span>db<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">signalModifiedKey</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> db<span class="token punctuation">,</span> keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">propagateDeletion</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">,</span>server<span class="token punctuation">.</span>lazyfree_lazy_expire<span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>stat_expiredkeys<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>所以不管是什么类型的事件，都会通过 <code>notifyKeyspaceEvent</code> 进行消息的发布，第一个参数 type 就代表了事件的类型。 <code>notifyKeyspaceEvent</code> 就是最核心的部分，源码如下：</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">notifyKeyspaceEvent</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>event<span class="token punctuation">,</span> robj <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">int</span> dbid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// sds 做 key 的拼接</span>
    sds chan<span class="token punctuation">;</span>
    robj <span class="token operator">*</span>chanobj<span class="token punctuation">,</span> <span class="token operator">*</span>eventobj<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    eventobj <span class="token operator">=</span> <span class="token function">createStringObject</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* __keyspace@&lt;db&gt;__:&lt;key&gt; &lt;event&gt; notifications. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>notify_keyspace_events <span class="token operator">&amp;</span> NOTIFY_KEYSPACE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 首先利用 sds 拼接 key </span>
        chan <span class="token operator">=</span> <span class="token function">sdsnewlen</span><span class="token punctuation">(</span><span class="token string">&quot;__keyspace@&quot;</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        len <span class="token operator">=</span> <span class="token function">ll2string</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span>dbid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        chan <span class="token operator">=</span> <span class="token function">sdscatlen</span><span class="token punctuation">(</span>chan<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        chan <span class="token operator">=</span> <span class="token function">sdscatlen</span><span class="token punctuation">(</span>chan<span class="token punctuation">,</span> <span class="token string">&quot;__:&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chan <span class="token operator">=</span> <span class="token function">sdscatsds</span><span class="token punctuation">(</span>chan<span class="token punctuation">,</span> key<span class="token operator">-&gt;</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        chanobj <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_STRING<span class="token punctuation">,</span> chan<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// pubsub 发布消息</span>
        <span class="token function">pubsubPublishMessage</span><span class="token punctuation">(</span>chanobj<span class="token punctuation">,</span> eventobj<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">decrRefCount</span><span class="token punctuation">(</span>chanobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* __keyevent@&lt;db&gt;__:&lt;event&gt; &lt;key&gt; notifications. */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>notify_keyspace_events <span class="token operator">&amp;</span> NOTIFY_KEYEVENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        chan <span class="token operator">=</span> <span class="token function">sdsnewlen</span><span class="token punctuation">(</span><span class="token string">&quot;__keyevent@&quot;</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> len <span class="token operator">=</span> <span class="token function">ll2string</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span>dbid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        chan <span class="token operator">=</span> <span class="token function">sdscatlen</span><span class="token punctuation">(</span>chan<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        chan <span class="token operator">=</span> <span class="token function">sdscatlen</span><span class="token punctuation">(</span>chan<span class="token punctuation">,</span> <span class="token string">&quot;__:&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chan <span class="token operator">=</span> <span class="token function">sdscatsds</span><span class="token punctuation">(</span>chan<span class="token punctuation">,</span> eventobj<span class="token operator">-&gt;</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        chanobj <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span>OBJ_STRING<span class="token punctuation">,</span> chan<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pubsubPublishMessage</span><span class="token punctuation">(</span>chanobj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">decrRefCount</span><span class="token punctuation">(</span>chanobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">decrRefCount</span><span class="token punctuation">(</span>eventobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>代码逻辑很清晰，就是拼接 key 然后发布到对应的频道上。 <code>pubsubPublishMessage</code> 方法，就相当于执行了 publish 命令，在 Pub/Sub 源码已经介绍过。</p> <h2 id="keyspace-notifications-的缺点"><a href="#keyspace-notifications-的缺点" class="header-anchor">#</a> Keyspace Notifications 的缺点</h2> <p>既然是基于 Pub/Sub 实现的，那 Pub/Sub 的所有缺点 Keyspace Notifications 也一并继承了。</p> <h3 id="_1、不可靠性"><a href="#_1、不可靠性" class="header-anchor">#</a> 1、不可靠性</h3> <p>pubsub的消息传递模型是至多一次，不会对消息做持久化，因此出现连接断开时，消息会丢失</p> <h3 id="_2、集群模式的问题"><a href="#_2、集群模式的问题" class="header-anchor">#</a> 2、集群模式的问题</h3> <p>在集群模式下，Keyspace Notifications 就与 Pub/Sub 不太相同了。</p> <p>在 Redis 7.0 前，集群模式下的全局 Pub/Sub，会导致广播风暴问题；</p> <p>Redis 7.0 推出了 Shared Pub/Sub 来解决这个问题。</p> <p>而在集群模式下，Keyspace Notifications 不会进行广播，每个节点只会生成自己 Key 子集的事件。</p> <p>因此，为了收到所有的事件，客户端需要订阅集群的所有节点。</p> <h3 id="_3、过期-key-事件的延迟"><a href="#_3、过期-key-事件的延迟" class="header-anchor">#</a> 3、过期 Key 事件的延迟</h3> <p>过期 Key 事件的通知，并非 TTL 到 0，而是当 Redis 发现过期并真正删除时才会通知，发现 Key 过期的时间取决于过期策略。因此，在 Key 的数量非常多时，过期 Key 事件的通知可能会有分钟级的延迟。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/redis/feature/PubSub.html" class="prev">
        Redis 发布订阅：PubSub
      </a></span> <span class="next"><a href="/blog/redis/feature/Persistence.html">
        Redis 持久化：RDB &amp; AOF
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.7b9df32b.js" defer></script><script src="/blog/assets/js/2.be714ec7.js" defer></script><script src="/blog/assets/js/1.26c7c9cc.js" defer></script><script src="/blog/assets/js/17.ec7b8f9d.js" defer></script>
  </body>
</html>
