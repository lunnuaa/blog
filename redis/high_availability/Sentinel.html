<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>哨兵（Sentinel） | lun&#39;s blogs</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="description" content="blog">
    
    <link rel="preload" href="/blog/assets/css/0.styles.56f5eb6c.css" as="style"><link rel="preload" href="/blog/assets/js/app.7b9df32b.js" as="script"><link rel="preload" href="/blog/assets/js/2.be714ec7.js" as="script"><link rel="preload" href="/blog/assets/js/1.26c7c9cc.js" as="script"><link rel="preload" href="/blog/assets/js/85.4d5e44f4.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.0d71bf2e.js"><link rel="prefetch" href="/blog/assets/js/11.cc81c248.js"><link rel="prefetch" href="/blog/assets/js/12.5e69cd14.js"><link rel="prefetch" href="/blog/assets/js/13.f0bc7bf2.js"><link rel="prefetch" href="/blog/assets/js/14.0188e855.js"><link rel="prefetch" href="/blog/assets/js/15.48a1e71e.js"><link rel="prefetch" href="/blog/assets/js/16.0f4182c9.js"><link rel="prefetch" href="/blog/assets/js/17.ec7b8f9d.js"><link rel="prefetch" href="/blog/assets/js/18.776522e2.js"><link rel="prefetch" href="/blog/assets/js/19.26561e06.js"><link rel="prefetch" href="/blog/assets/js/20.3e42feda.js"><link rel="prefetch" href="/blog/assets/js/21.fd4e7a00.js"><link rel="prefetch" href="/blog/assets/js/22.b59f6079.js"><link rel="prefetch" href="/blog/assets/js/23.e6b2d3ec.js"><link rel="prefetch" href="/blog/assets/js/24.736cfa99.js"><link rel="prefetch" href="/blog/assets/js/25.91176041.js"><link rel="prefetch" href="/blog/assets/js/26.146e299c.js"><link rel="prefetch" href="/blog/assets/js/27.56a57551.js"><link rel="prefetch" href="/blog/assets/js/28.13a846a1.js"><link rel="prefetch" href="/blog/assets/js/29.f71b59d6.js"><link rel="prefetch" href="/blog/assets/js/3.f34ea2f7.js"><link rel="prefetch" href="/blog/assets/js/30.bf0626f9.js"><link rel="prefetch" href="/blog/assets/js/31.47592684.js"><link rel="prefetch" href="/blog/assets/js/32.63f20fc3.js"><link rel="prefetch" href="/blog/assets/js/33.4852d9ec.js"><link rel="prefetch" href="/blog/assets/js/34.4f467138.js"><link rel="prefetch" href="/blog/assets/js/35.17d26444.js"><link rel="prefetch" href="/blog/assets/js/36.d0059312.js"><link rel="prefetch" href="/blog/assets/js/37.fc856e5d.js"><link rel="prefetch" href="/blog/assets/js/38.dc6b373c.js"><link rel="prefetch" href="/blog/assets/js/39.f04e5b6a.js"><link rel="prefetch" href="/blog/assets/js/4.885368ff.js"><link rel="prefetch" href="/blog/assets/js/40.b378efa5.js"><link rel="prefetch" href="/blog/assets/js/41.3c800d8a.js"><link rel="prefetch" href="/blog/assets/js/42.8b804f0c.js"><link rel="prefetch" href="/blog/assets/js/43.832aa078.js"><link rel="prefetch" href="/blog/assets/js/44.d1121c11.js"><link rel="prefetch" href="/blog/assets/js/45.b3e8ede1.js"><link rel="prefetch" href="/blog/assets/js/46.01e4202b.js"><link rel="prefetch" href="/blog/assets/js/47.489850e9.js"><link rel="prefetch" href="/blog/assets/js/48.3bd88d5f.js"><link rel="prefetch" href="/blog/assets/js/49.08c6f759.js"><link rel="prefetch" href="/blog/assets/js/5.d1dbc0b1.js"><link rel="prefetch" href="/blog/assets/js/50.c900e52a.js"><link rel="prefetch" href="/blog/assets/js/51.a59d8fbf.js"><link rel="prefetch" href="/blog/assets/js/52.0c715d23.js"><link rel="prefetch" href="/blog/assets/js/53.07715a2f.js"><link rel="prefetch" href="/blog/assets/js/54.e0d8cc69.js"><link rel="prefetch" href="/blog/assets/js/55.1efa3b0b.js"><link rel="prefetch" href="/blog/assets/js/56.ace3e6e3.js"><link rel="prefetch" href="/blog/assets/js/57.221667c1.js"><link rel="prefetch" href="/blog/assets/js/58.a786e5bd.js"><link rel="prefetch" href="/blog/assets/js/59.8a6dde26.js"><link rel="prefetch" href="/blog/assets/js/6.7ee6eed6.js"><link rel="prefetch" href="/blog/assets/js/60.0192f277.js"><link rel="prefetch" href="/blog/assets/js/61.75813485.js"><link rel="prefetch" href="/blog/assets/js/62.d8de1a01.js"><link rel="prefetch" href="/blog/assets/js/63.a08485a4.js"><link rel="prefetch" href="/blog/assets/js/64.7d19f572.js"><link rel="prefetch" href="/blog/assets/js/65.3f290d9a.js"><link rel="prefetch" href="/blog/assets/js/66.73f49082.js"><link rel="prefetch" href="/blog/assets/js/67.cb22e678.js"><link rel="prefetch" href="/blog/assets/js/68.22dc7228.js"><link rel="prefetch" href="/blog/assets/js/69.1f450482.js"><link rel="prefetch" href="/blog/assets/js/7.153b9c62.js"><link rel="prefetch" href="/blog/assets/js/70.03205c0b.js"><link rel="prefetch" href="/blog/assets/js/71.5b98edf5.js"><link rel="prefetch" href="/blog/assets/js/72.8be00756.js"><link rel="prefetch" href="/blog/assets/js/73.5e60394c.js"><link rel="prefetch" href="/blog/assets/js/74.a1100b64.js"><link rel="prefetch" href="/blog/assets/js/75.b47153bc.js"><link rel="prefetch" href="/blog/assets/js/76.b881f0b9.js"><link rel="prefetch" href="/blog/assets/js/77.eef60dd8.js"><link rel="prefetch" href="/blog/assets/js/78.b52fa32f.js"><link rel="prefetch" href="/blog/assets/js/79.9adc486f.js"><link rel="prefetch" href="/blog/assets/js/80.10b21516.js"><link rel="prefetch" href="/blog/assets/js/81.12c11cbc.js"><link rel="prefetch" href="/blog/assets/js/82.df4ae15b.js"><link rel="prefetch" href="/blog/assets/js/83.078b9ed6.js"><link rel="prefetch" href="/blog/assets/js/84.2d8ccb46.js"><link rel="prefetch" href="/blog/assets/js/86.c32dda95.js"><link rel="prefetch" href="/blog/assets/js/87.c28d1f54.js"><link rel="prefetch" href="/blog/assets/js/88.c06457bb.js"><link rel="prefetch" href="/blog/assets/js/89.1febc082.js"><link rel="prefetch" href="/blog/assets/js/90.37985dbe.js"><link rel="prefetch" href="/blog/assets/js/91.9c3ebd93.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.02634ae8.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.56f5eb6c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="lun's blogs" class="logo"> <span class="site-name can-hide">lun's blogs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/base/Exception.html" class="nav-link">
  异常
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Generics.html" class="nav-link">
  泛型
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Enum.html" class="nav-link">
  枚举
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Serialize.html" class="nav-link">
  Java序列化机制详解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Proxy.html" class="nav-link">
  动态代理
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Annotation.html" class="nav-link">
  深入理解Java注解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream1.html" class="nav-link">
  Stream源码分析(上)
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream2.html" class="nav-link">
  Stream源码分析(下)
</a></li></ul></div></div><div class="nav-item"><a href="/blog/java多线程/" class="nav-link">
  Java多线程
</a></div><div class="nav-item"><a href="/blog/jvm/" class="nav-link">
  JVM
</a></div><div class="nav-item"><a href="/blog/redis/" class="nav-link router-link-active">
  Redis
</a></div><div class="nav-item"><a href="/blog/blogs/" class="nav-link">
  随笔
</a></div><div class="nav-item"><a href="https://juejin.cn/user/2159878519134157" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/base/Exception.html" class="nav-link">
  异常
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Generics.html" class="nav-link">
  泛型
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Enum.html" class="nav-link">
  枚举
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Serialize.html" class="nav-link">
  Java序列化机制详解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Proxy.html" class="nav-link">
  动态代理
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Annotation.html" class="nav-link">
  深入理解Java注解
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream1.html" class="nav-link">
  Stream源码分析(上)
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/base/Stream2.html" class="nav-link">
  Stream源码分析(下)
</a></li></ul></div></div><div class="nav-item"><a href="/blog/java多线程/" class="nav-link">
  Java多线程
</a></div><div class="nav-item"><a href="/blog/jvm/" class="nav-link">
  JVM
</a></div><div class="nav-item"><a href="/blog/redis/" class="nav-link router-link-active">
  Redis
</a></div><div class="nav-item"><a href="/blog/blogs/" class="nav-link">
  随笔
</a></div><div class="nav-item"><a href="https://juejin.cn/user/2159878519134157" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/redis/" aria-current="page" class="sidebar-link">一、前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>二、Redis数据类型</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>三、Redis功能特性</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>四、Redis高可用</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/redis/high_availability/MasterSlave.html" class="sidebar-link">主从架构 Redis</a></li><li><a href="/blog/redis/high_availability/Sentinel.html" aria-current="page" class="active sidebar-link">哨兵（Sentinel）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#哨兵的功能意义" class="sidebar-link">哨兵的功能意义</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#_1、监控" class="sidebar-link">1、监控</a></li><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#_2、自动故障恢复" class="sidebar-link">2、自动故障恢复</a></li><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#_3、通知" class="sidebar-link">3、通知</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#哨兵的基本使用" class="sidebar-link">哨兵的基本使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#启动哨兵" class="sidebar-link">启动哨兵</a></li><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#哨兵本身也是集群" class="sidebar-link">哨兵本身也是集群</a></li><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#主观下线和客观下线" class="sidebar-link">主观下线和客观下线</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#哨兵常用命令" class="sidebar-link">哨兵常用命令</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#连接哨兵" class="sidebar-link" style="padding-left:3rem;">连接哨兵</a></li><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#查询监听的节点信息" class="sidebar-link" style="padding-left:3rem;">查询监听的节点信息</a></li><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#查询其它哨兵-sentinels" class="sidebar-link" style="padding-left:3rem;">查询其它哨兵：sentinels</a></li><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#添加监控的主节点-monitor" class="sidebar-link" style="padding-left:3rem;">添加监控的主节点：monitor</a></li><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#移除监控的主节点-remove" class="sidebar-link" style="padding-left:3rem;">移除监控的主节点：remove</a></li><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#修改-quorum-参数-set" class="sidebar-link" style="padding-left:3rem;">修改 quorum 参数：set</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#监控的实现原理" class="sidebar-link">监控的实现原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#主观下线的本质" class="sidebar-link" style="padding-left:3rem;">主观下线的本质</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#自动故障恢复实现原理" class="sidebar-link">自动故障恢复实现原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#如何选择新的主节点-replica-priority" class="sidebar-link" style="padding-left:3rem;">如何选择新的主节点：replica-priority</a></li><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#如何成为新的主节点" class="sidebar-link" style="padding-left:3rem;">如何成为新的主节点</a></li><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#故障恢复期间的请求" class="sidebar-link">故障恢复期间的请求</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#哨兵彼此如何通信-pub-sub" class="sidebar-link">哨兵彼此如何通信：pub/sub</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#频道-消息类型" class="sidebar-link" style="padding-left:3rem;">频道：消息类型</a></li><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#客户端感知哨兵的工作情况" class="sidebar-link" style="padding-left:3rem;">客户端感知哨兵的工作情况</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#哨兵实战" class="sidebar-link">哨兵实战</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#哨兵通常配置为奇数个" class="sidebar-link" style="padding-left:3rem;">哨兵通常配置为奇数个</a></li><li class="sidebar-sub-header"><a href="/blog/redis/high_availability/Sentinel.html#哨兵配置一致" class="sidebar-link" style="padding-left:3rem;">哨兵配置一致</a></li></ul></li></ul></li><li><a href="/blog/redis/high_availability/Cluster.html" class="sidebar-link">Redis集群：Redis cluster</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="哨兵-sentinel"><a href="#哨兵-sentinel" class="header-anchor">#</a> 哨兵（Sentinel）</h1> <h2 id="哨兵的功能意义"><a href="#哨兵的功能意义" class="header-anchor">#</a> 哨兵的功能意义</h2> <h3 id="_1、监控"><a href="#_1、监控" class="header-anchor">#</a> 1、监控</h3> <p>Sentinel 会不断检查您的master和slave是否按预期工作</p> <h3 id="_2、自动故障恢复"><a href="#_2、自动故障恢复" class="header-anchor">#</a> 2、自动故障恢复</h3> <p>如果master故障，Sentinel会将一个slave提升为master。当故障实例恢复后也变为一个slave，也以新的master为主</p> <h3 id="_3、通知"><a href="#_3、通知" class="header-anchor">#</a> 3、通知</h3> <p>Sentinel充当Redis客户端的服务发现来源，当集群发生故障转移时，会将最新信息推送给Redis的客户端。即作Redis为主节点、从节点的地址的通知者，发生变更后第一时间通知Redis客户端。</p> <h2 id="哨兵的基本使用"><a href="#哨兵的基本使用" class="header-anchor">#</a> 哨兵的基本使用</h2> <h3 id="启动哨兵"><a href="#启动哨兵" class="header-anchor">#</a> 启动哨兵</h3> <p><strong>哨兵不需要配置从节点，哨兵会自动监听从节点</strong>。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>./src/redis-sentinel sentinel.conf
<span class="token comment"># sentinel.conf 是配置文件</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>配置文件如下：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 监听的主节点信息</span>
sentinel monitor <span class="token punctuation">[</span>master-name<span class="token punctuation">]</span> <span class="token punctuation">[</span>ip<span class="token punctuation">]</span> <span class="token punctuation">[</span>port<span class="token punctuation">]</span> <span class="token punctuation">[</span>quorum<span class="token punctuation">]</span>
<span class="token comment"># 当[quorum]个sentinel认为主节点下线(主观下线)，则认为主节点客观下线</span>
<span class="token comment"># 主节点的密码</span>
sentinel auth-pass <span class="token punctuation">[</span>master-name<span class="token punctuation">]</span> <span class="token punctuation">[</span>password<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="哨兵本身也是集群"><a href="#哨兵本身也是集群" class="header-anchor">#</a> 哨兵本身也是集群</h3> <p>多个 Sentinel 监听到一个主节点，他们会自动发现彼此，构成 Sentinel 集群</p> <h3 id="主观下线和客观下线"><a href="#主观下线和客观下线" class="header-anchor">#</a> 主观下线和客观下线</h3> <p>一个 Sentinel 认为节点下线，就是主观下线；那怎么才算认为呢，稍后原理部分介绍。</p> <p>超过 Quorum 个 Sentinel 认为节点下线，就是客观下线。</p> <h2 id="哨兵常用命令"><a href="#哨兵常用命令" class="header-anchor">#</a> 哨兵常用命令</h2> <h4 id="连接哨兵"><a href="#连接哨兵" class="header-anchor">#</a> 连接哨兵</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>redis-cli <span class="token parameter variable">-h</span> <span class="token punctuation">[</span>ip<span class="token punctuation">]</span> <span class="token parameter variable">-p</span> <span class="token punctuation">[</span>port 默认26379<span class="token punctuation">]</span> <span class="token parameter variable">-a</span> <span class="token punctuation">[</span>password<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="查询监听的节点信息"><a href="#查询监听的节点信息" class="header-anchor">#</a> 查询监听的节点信息</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 主节点 哨兵可以监听多个主节点</span>
sentinel master <span class="token punctuation">[</span>master-name<span class="token punctuation">]</span>
<span class="token comment"># 所有从节点</span>
sentinel replicas <span class="token punctuation">[</span>master-name<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="查询其它哨兵-sentinels"><a href="#查询其它哨兵-sentinels" class="header-anchor">#</a> 查询其它哨兵：sentinels</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>sentinel sentinels <span class="token punctuation">[</span>master-name<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="添加监控的主节点-monitor"><a href="#添加监控的主节点-monitor" class="header-anchor">#</a> 添加监控的主节点：monitor</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>sentinel monitor <span class="token punctuation">[</span>master-name<span class="token punctuation">]</span> <span class="token punctuation">[</span>IP:127.0.0.1<span class="token punctuation">]</span> <span class="token punctuation">[</span>port:6379<span class="token punctuation">]</span> <span class="token punctuation">[</span>quorum<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="移除监控的主节点-remove"><a href="#移除监控的主节点-remove" class="header-anchor">#</a> 移除监控的主节点：remove</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>sentinel remove <span class="token punctuation">[</span>master-name<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="修改-quorum-参数-set"><a href="#修改-quorum-参数-set" class="header-anchor">#</a> 修改 quorum 参数：set</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>sentinel <span class="token builtin class-name">set</span> <span class="token punctuation">[</span>master-name<span class="token punctuation">]</span> quorum <span class="token punctuation">[</span>new-num<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="监控的实现原理"><a href="#监控的实现原理" class="header-anchor">#</a> 监控的实现原理</h2> <p>Sentinel基于心跳机制监测服务状态，每隔1秒向每个实例（包括从节点）发送ping命令。</p> <h4 id="主观下线的本质"><a href="#主观下线的本质" class="header-anchor">#</a> 主观下线的本质</h4> <p>主观下线最重要的参数是 <code>down-after-milliseconds</code> ，即距离上次ping通超过30s(默认值)，认为主观下线。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>down-after-milliseconds <span class="token number">30</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="自动故障恢复实现原理"><a href="#自动故障恢复实现原理" class="header-anchor">#</a> 自动故障恢复实现原理</h2> <p>一旦发现master故障，Sentinel需要选择一个作为新的master。</p> <h4 id="如何选择新的主节点-replica-priority"><a href="#如何选择新的主节点-replica-priority" class="header-anchor">#</a> 如何选择新的主节点：replica-priority</h4> <p>首先排除一些可能也存在问题的节点，比如：与master节点的断开时间超过<code>down-after-milliseconds</code> * 10的</p> <p>然后根据<code>replica-priority</code>选择优先级最高的，这个选型位于 redis.conf 中</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 默认值为100 最大也为100</span>
replica-priority <span class="token number">100</span>
<span class="token comment"># 这个值越小,优先级越高,0除外</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>如果 <code>replica-priority</code> 为0，永远不会参与选举</p></blockquote> <p>那如果 <code>replica-priority</code> 都相同，还记得同步原理的offset吗，我们选择offset最新的作为主节点。</p> <blockquote><p>这样选到的主节点数据最新</p></blockquote> <h4 id="如何成为新的主节点"><a href="#如何成为新的主节点" class="header-anchor">#</a> 如何成为新的主节点</h4> <p>当选中了其中一个slave为新的master后（例如slave1），故障的转移的步骤如下：</p> <ol><li>sentinel给备选的slave1节点发送 <code>slaveof no one</code> 命令，让该节点成为master</li> <li>sentinel给所有其它slave发送slaveof 192.168.150.101 7002 命令，让这些slave成为新master的从节点，开始从新的master上同步数据。</li> <li>最后，sentinel将故障节点标记为slave，当故障节点恢复后会自动成为新的master的slave节点</li></ol> <h3 id="故障恢复期间的请求"><a href="#故障恢复期间的请求" class="header-anchor">#</a> 故障恢复期间的请求</h3> <p>主库故障后，无法处理写请求，但读请求依然可以交给从库。</p> <h2 id="哨兵彼此如何通信-pub-sub"><a href="#哨兵彼此如何通信-pub-sub" class="header-anchor">#</a> 哨兵彼此如何通信：pub/sub</h2> <p>显然，哨兵之间是需要彼此通信的，比如确定主观下线。</p> <p>而它们通信的原理是：发布/订阅。</p> <p>哨兵上线，会在某个特定的「频道」上发布消息；其它哨兵通过订阅该频道来发现彼此和通信。</p> <h4 id="频道-消息类型"><a href="#频道-消息类型" class="header-anchor">#</a> 频道：消息类型</h4> <p>频道可以理解为消息类型，唯一确定某一类消息。</p> <p>例如：“sentinel:hello”频道，就是哨兵发现彼此存在的频道。</p> <h4 id="客户端感知哨兵的工作情况"><a href="#客户端感知哨兵的工作情况" class="header-anchor">#</a> 客户端感知哨兵的工作情况</h4> <p>哨兵本身也提供 pub/sub 机制，客户端可以通过订阅哨兵特定的频道来获取如主观下线，主库切换等事件。</p> <h2 id="哨兵实战"><a href="#哨兵实战" class="header-anchor">#</a> 哨兵实战</h2> <h4 id="哨兵通常配置为奇数个"><a href="#哨兵通常配置为奇数个" class="header-anchor">#</a> 哨兵通常配置为奇数个</h4> <p>这和超过半数有关系。</p> <h4 id="哨兵配置一致"><a href="#哨兵配置一致" class="header-anchor">#</a> 哨兵配置一致</h4> <p>所有哨兵的配置需要一致，避免选举错误。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/redis/high_availability/MasterSlave.html" class="prev">
        主从架构 Redis
      </a></span> <span class="next"><a href="/blog/redis/high_availability/Cluster.html">
        Redis集群：Redis cluster
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.7b9df32b.js" defer></script><script src="/blog/assets/js/2.be714ec7.js" defer></script><script src="/blog/assets/js/1.26c7c9cc.js" defer></script><script src="/blog/assets/js/85.4d5e44f4.js" defer></script>
  </body>
</html>
